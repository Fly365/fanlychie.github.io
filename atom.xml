<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>範宗雲</title>
  <subtitle>面朝大海，望眼欲穿</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://yoursite.com/"/>
  <updated>2017-10-08T06:02:37.869Z</updated>
  <id>http://yoursite.com/</id>
  
  <author>
    <name>範宗雲</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>分布式文件系统 FastDFS 环境搭建和使用</title>
    <link href="http://yoursite.com/post/fastdfs-setup.html"/>
    <id>http://yoursite.com/post/fastdfs-setup.html</id>
    <published>2017-09-22T14:39:04.000Z</published>
    <updated>2017-10-08T06:02:37.869Z</updated>
    
    <content type="html"><![CDATA[<p>FastDFS 是一个开源的轻量级分布式文件系统，它对文件进行管理，功能包括：文件存储、文件同步、文件访问（文件上传、文件下载）等，解决了大容量存储和负载均衡的问题。适合以文件为载体的在线服务，如图片网站、视频网站等等。</p>
<a id="more"></a>
<h3 id="1-环境清单"><a href="#1-环境清单" class="headerlink" title="1. 环境清单"></a>1. 环境清单</h3><ul>
<li>CentOS 7</li>
<li>FastDFS 5.08<ul>
<li><a href="https://nchc.dl.sourceforge.net/project/fastdfs/FastDFS%20Server%20Source%20Code/FastDFS%20Server%20with%20PHP%20Extension%20Source%20Code%20V5.08/FastDFS_v5.08.tar.gz" target="_blank" rel="external">FastDFS_v5.08.tar.gz</a></li>
<li><a href="https://codeload.github.com/happyfish100/libfastcommon/tar.gz/V1.0.36" target="_blank" rel="external">libfastcommon-1.0.36.tar.gz</a></li>
<li><a href="https://ncu.dl.sourceforge.net/project/fastdfs/FastDFS%20Nginx%20Module%20Source%20Code/fastdfs-nginx-module_v1.16.tar.gz" target="_blank" rel="external">fastdfs-nginx-module_v1.16.tar.gz</a></li>
</ul>
</li>
<li>Nginx 1.12.1<ul>
<li><a href="http://nginx.org/download/nginx-1.12.1.tar.gz" target="_blank" rel="external">nginx-1.12.1.tar.gz</a></li>
<li><a href="https://www.openssl.org/source/openssl-1.0.2l.tar.gz" target="_blank" rel="external">openssl-1.0.2l.tar.gz</a></li>
<li><a href="http://ncu.dl.sourceforge.net/project/pcre/pcre/8.36/pcre-8.36.tar.gz" target="_blank" rel="external">pcre-8.36.tar.gz</a></li>
<li><a href="http://zlib.net/zlib-1.2.11.tar.gz" target="_blank" rel="external">zlib-1.2.11.tar.gz</a></li>
</ul>
</li>
<li>Other<ul>
<li><a href="https://github.com/libevent/libevent/releases/download/release-2.1.8-stable/libevent-2.1.8-stable.tar.gz" target="_blank" rel="external">libevent-2.1.8-stable.tar.gz</a></li>
</ul>
</li>
</ul>
<h3 id="2-FastDFS-安装"><a href="#2-FastDFS-安装" class="headerlink" title="2. FastDFS 安装"></a>2. FastDFS 安装</h3><p>FastDFS 服务端有两个角色：跟踪器（tracker）和存储节点（storage）。客户端（Client）通过 Tracker 服务器，将文件存储在 Storage 服务器。在访问量不大情况下，可将 Tracker 和 Storage 都部署在同一台服务器上，后期根据业务需要进行扩展。<br>下载清单中的安装包，上传到服务器<code>/usr/local/src</code>目录中，服务器IP：192.168.1.102。</p>
<h4 id="2-1-libevent-安装"><a href="#2-1-libevent-安装" class="headerlink" title="2.1 libevent 安装"></a>2.1 libevent 安装</h4><p>查看是否已经安装：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> ls -al /usr/* | grep libevent</span></div></pre></td></tr></table></figure>
<p>若已安装，则跳过此步骤。若未安装，则执行以下步骤：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> tar zxvf libevent-2.1.8-stable.tar.gz &amp;&amp; <span class="built_in">cd</span> libevent-2.1.8-stable</span></div></pre></td></tr></table></figure></p>
<p>编译安装：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> ./configure --prefix=/usr &amp;&amp; make &amp;&amp; make install</span></div></pre></td></tr></table></figure></p>
<p>如果报 <font color="#da5985" style="margin:-12px 0 6px 0;">no acceptable C compiler found in $PATH</font> 错误，解决方法：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> yum install -y gcc gcc-c++</span></div></pre></td></tr></table></figure>
<p>重新编译安装：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> ./configure --prefix=/usr &amp;&amp; make clean &amp;&amp; make &amp;&amp; make install</span></div></pre></td></tr></table></figure></p>
<h4 id="2-2-libfastcommon-安装"><a href="#2-2-libfastcommon-安装" class="headerlink" title="2.2 libfastcommon 安装"></a>2.2 libfastcommon 安装</h4><p>解压缩并进入根目录：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> tar zxvf libfastcommon-1.0.36.tar.gz &amp;&amp; <span class="built_in">cd</span> libfastcommon-1.0.36</span></div></pre></td></tr></table></figure></p>
<p>编译安装：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> ./make.sh &amp;&amp; ./make.sh install</span></div></pre></td></tr></table></figure></p>
<h4 id="2-3-fastdfs-安装"><a href="#2-3-fastdfs-安装" class="headerlink" title="2.3 fastdfs 安装"></a>2.3 fastdfs 安装</h4><p>解压缩并重命名：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> tar zxvf FastDFS_v5.08.tar.gz &amp;&amp; mv FastDFS fastdfs-5.08 &amp;&amp; <span class="built_in">cd</span> fastdfs-5.08</span></div></pre></td></tr></table></figure></p>
<p>编译安装：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> ./make.sh &amp;&amp; ./make.sh install</span></div></pre></td></tr></table></figure></p>
<p>如果报 <font color="#da5985" style="margin:-12px 0 6px 0;">perl: command not found</font> 错误，解决方法：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> yum install perl</span></div></pre></td></tr></table></figure>
<p>安装完 perl 后，重新编译安装：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> ./make.sh clean &amp;&amp; ./make.sh &amp;&amp; ./make.sh install</span></div></pre></td></tr></table></figure></p>
<p>将<code>conf</code>目录下的文件拷贝到<code>/etc/fdfs</code>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">cd</span> conf &amp;&amp; cp anti-steal.jpg http.conf mime.types /etc/fdfs/</span></div></pre></td></tr></table></figure>
<h5 id="2-3-1-tracker-配置"><a href="#2-3-1-tracker-配置" class="headerlink" title="2.3.1 tracker 配置"></a>2.3.1 tracker 配置</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">cd</span> /etc/fdfs &amp;&amp; mv tracker.conf.sample tracker.conf &amp;&amp; vi tracker.conf</span></div></pre></td></tr></table></figure>
<p>找到第22行，改为如下并保存退出：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">base_path=/data/fastdfs</div></pre></td></tr></table></figure>
<p>创建<code>/data/fastdfs</code>目录：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> mkdir -p /data/fastdfs</span></div></pre></td></tr></table></figure>
<p>建立软链接：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> ln -s /usr/bin/fdfs_trackerd /usr/<span class="built_in">local</span>/bin &amp;&amp; ln -s /usr/bin/stop.sh /usr/<span class="built_in">local</span>/bin &amp;&amp; ln -s /usr/bin/restart.sh /usr/<span class="built_in">local</span>/bin</span></div></pre></td></tr></table></figure>
<h5 id="2-3-2-client-配置"><a href="#2-3-2-client-配置" class="headerlink" title="2.3.2 client 配置"></a>2.3.2 client 配置</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">cd</span> /etc/fdfs &amp;&amp; mv client.conf.sample client.conf &amp;&amp; vi client.conf</span></div></pre></td></tr></table></figure>
<p>找到第10行，改为：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">base_path=/data/fastdfs</div></pre></td></tr></table></figure>
<p>找到第14行，改为如下并保存退出：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tracker_server=192.168.1.102:22122</div></pre></td></tr></table></figure>
<h5 id="2-3-3-storage-配置"><a href="#2-3-3-storage-配置" class="headerlink" title="2.3.3 storage 配置"></a>2.3.3 storage 配置</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">cd</span> /etc/fdfs &amp;&amp; mv storage.conf.sample storage.conf &amp;&amp; vi storage.conf</span></div></pre></td></tr></table></figure>
<p>找到第41行，改为：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">base_path=/data/fastdfs/storage</div></pre></td></tr></table></figure>
<p>找到第109行，改为：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">store_path0=/data/fastdfs/storage</div></pre></td></tr></table></figure>
<p>找到第118行，改为如下并保存退出：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tracker_server=192.168.1.102:22122</div></pre></td></tr></table></figure>
<p>创建<code>/data/fastdfs/storage</code>目录：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> mkdir /data/fastdfs/storage</span></div></pre></td></tr></table></figure>
<p>建立软链接：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> ln -s /usr/bin/fdfs_storaged /usr/<span class="built_in">local</span>/bin</span></div></pre></td></tr></table></figure>
<h4 id="2-4-fastdfs-nginx-module-配置"><a href="#2-4-fastdfs-nginx-module-配置" class="headerlink" title="2.4 fastdfs-nginx-module 配置"></a>2.4 fastdfs-nginx-module 配置</h4><p>解压缩并进入根目录：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> tar zxvf fastdfs-nginx-module_v1.16.tar.gz &amp;&amp; <span class="built_in">cd</span> fastdfs-nginx-module</span></div></pre></td></tr></table></figure></p>
<p>编辑<code>src/mod_fastdfs.conf</code>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> vi src/mod_fastdfs.conf</span></div></pre></td></tr></table></figure>
<p>找到第40行，改为：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tracker_server=192.168.1.102:22122</div></pre></td></tr></table></figure>
<p>找到第53行，改为：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">url_have_group_name = true</div></pre></td></tr></table></figure>
<p>找到第62行，改为如下并保存退出：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">store_path0=/data/fastdfs/storage</div></pre></td></tr></table></figure>
<p>拷贝<code>src/mod_fastdfs.conf</code>配置文件到<code>/etc/fdfs/</code>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> cp src/mod_fastdfs.conf /etc/fdfs/</span></div></pre></td></tr></table></figure>
<p>编辑<code>src/config</code>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> vi src/config</span></div></pre></td></tr></table></figure>
<p>将第4行的：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">CORE_INCS="$CORE_INCS /usr/local/include/fastdfs /usr/local/include/fastcommon/"</div></pre></td></tr></table></figure>
<p>去掉路径中的<code>/local</code>，改为如下并保存退出：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">CORE_INCS="$CORE_INCS /usr/include/fastdfs /usr/include/fastcommon/"</div></pre></td></tr></table></figure>
<h4 id="2-5-nginx-安装"><a href="#2-5-nginx-安装" class="headerlink" title="2.5 nginx 安装"></a>2.5 nginx 安装</h4><h5 id="2-5-1-pcre-安装"><a href="#2-5-1-pcre-安装" class="headerlink" title="2.5.1 pcre 安装"></a>2.5.1 pcre 安装</h5><p>解压缩并进入根目录：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> tar zxvf pcre-8.36.tar.gz &amp;&amp; <span class="built_in">cd</span> pcre-8.36</span></div></pre></td></tr></table></figure></p>
<p>编译安装：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> ./configure &amp;&amp; make &amp;&amp; make install</span></div></pre></td></tr></table></figure>
<p>64位系统：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> ln -s /usr/<span class="built_in">local</span>/lib/libpcre.so.1 /lib64</span></div></pre></td></tr></table></figure>
<p>32位系统：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> ln -s /usr/<span class="built_in">local</span>/lib/libpcre.so.1 /lib</span></div></pre></td></tr></table></figure>
<h5 id="2-5-2-zlib-安装"><a href="#2-5-2-zlib-安装" class="headerlink" title="2.5.2 zlib 安装"></a>2.5.2 zlib 安装</h5><p>解压缩并进入根目录：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> tar zxvf zlib-1.2.11.tar.gz &amp;&amp; <span class="built_in">cd</span> zlib-1.2.11</span></div></pre></td></tr></table></figure></p>
<p>编译安装：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> ./configure &amp;&amp; make &amp;&amp; make install</span></div></pre></td></tr></table></figure>
<h5 id="2-5-3-openssl-安装"><a href="#2-5-3-openssl-安装" class="headerlink" title="2.5.3 openssl 安装"></a>2.5.3 openssl 安装</h5><p>解压缩并进入根目录：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> tar zxvf openssl-1.0.2l.tar.gz &amp;&amp; <span class="built_in">cd</span> openssl-1.0.2l</span></div></pre></td></tr></table></figure></p>
<p>编译安装：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> ./config &amp;&amp; make &amp;&amp; make install</span></div></pre></td></tr></table></figure>
<h5 id="2-5-4-nginx-安装"><a href="#2-5-4-nginx-安装" class="headerlink" title="2.5.4 nginx 安装"></a>2.5.4 nginx 安装</h5><p>解压缩并进入根目录：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> tar zxvf nginx-1.12.1.tar.gz &amp;&amp; <span class="built_in">cd</span> nginx-1.12.1</span></div></pre></td></tr></table></figure></p>
<p>编译安装：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> ./configure --prefix=/usr/<span class="built_in">local</span>/nginx --add-module=/usr/<span class="built_in">local</span>/src/fastdfs-nginx-module/src/ &amp;&amp; make &amp;&amp; make install</span></div></pre></td></tr></table></figure>
<p>编辑 nginx 配置文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> vi /usr/<span class="built_in">local</span>/nginx/conf/nginx.conf</span></div></pre></td></tr></table></figure>
<p>添加如下配置并保存退出：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">location /group1/M00 &#123;</div><div class="line">    root /data/fastdfs/storage/;</div><div class="line">    ngx_fastdfs_module;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>创建目录：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> mkdir -p /data/fastdfs/storage/data/group1</span></div></pre></td></tr></table></figure>
<p>创建软链接：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> ln -s /data/fastdfs/storage/data /data/fastdfs/storage/data/group1/M00</span></div></pre></td></tr></table></figure>
<h3 id="3-启动服务"><a href="#3-启动服务" class="headerlink" title="3. 启动服务"></a>3. 启动服务</h3><h4 id="3-1-tracker-服务"><a href="#3-1-tracker-服务" class="headerlink" title="3.1 tracker 服务"></a>3.1 tracker 服务</h4><p>启动：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> service fdfs_trackerd start</span></div></pre></td></tr></table></figure>
<p>停止：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> service fdfs_trackerd stop</span></div></pre></td></tr></table></figure>
<p>查看进程：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> ps -ef|grep fdfs</span></div></pre></td></tr></table></figure>
<h4 id="3-2-storage-服务"><a href="#3-2-storage-服务" class="headerlink" title="3.2 storage 服务"></a>3.2 storage 服务</h4><p>启动：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> service fdfs_storaged start</span></div></pre></td></tr></table></figure>
<p>停止：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> service fdfs_storaged stop</span></div></pre></td></tr></table></figure>
<p>查看进程：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> ps -ef|grep fdfs</span></div></pre></td></tr></table></figure>
<h4 id="3-2-http-服务"><a href="#3-2-http-服务" class="headerlink" title="3.2 http 服务"></a>3.2 http 服务</h4><p>启动：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> /usr/<span class="built_in">local</span>/nginx/sbin/nginx</span></div></pre></td></tr></table></figure>
<p>停止：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> /usr/<span class="built_in">local</span>/nginx/sbin/nginx -s stop</span></div></pre></td></tr></table></figure>
<p>重新加载配置文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> /usr/<span class="built_in">local</span>/nginx/sbin/nginx -s reload</span></div></pre></td></tr></table></figure>
<p>查看进程：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> ps -ef|grep nginx</span></div></pre></td></tr></table></figure>
<h3 id="4-FastDFS-测试"><a href="#4-FastDFS-测试" class="headerlink" title="4. FastDFS 测试"></a>4. FastDFS 测试</h3><p>新建测试文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">echo</span> <span class="string">'Hello World!'</span> &gt; hello.txt</span></div></pre></td></tr></table></figure>
<p>测试上传：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span><span class="bash"> /usr/bin/fdfs_test /etc/fdfs/client.conf upload /home/fanlychie/hello.txt</span></div></pre></td></tr></table></figure>
<p>上传成功之后返回类似信息：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">example file url: http://192.168.1.102/group1/M00/00/00/wKiLgVnGs-2AUYZ7AAAADT9THu8070_big.txt</div></pre></td></tr></table></figure>
<p>测试下载：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span><span class="bash"> fdfs_download_file /etc/fdfs/client.conf group1/M00/00/00/wKiLgVnGs-2AUYZ7AAAADT9THu8070_big.txt hello-download.txt</span></div></pre></td></tr></table></figure>
<h3 id="5-开启服务端口"><a href="#5-开启服务端口" class="headerlink" title="5. 开启服务端口"></a>5. 开启服务端口</h3><p>对外开启 80、8080、22122、23000 端口：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">firewall-cmd --permanent --add-port=80/tcp</div><div class="line">firewall-cmd --permanent --add-port=8080/tcp</div><div class="line">firewall-cmd --permanent --add-port=22122/tcp</div><div class="line">firewall-cmd --permanent --add-port=23000/tcp</div></pre></td></tr></table></figure>
<h3 id="6-storage-集群"><a href="#6-storage-集群" class="headerlink" title="6. storage 集群"></a>6. storage 集群</h3><p>上面安装配置的 FastDFS（192.168.1.102）是单机模式，现添加一台 storage 服务器（192.168.1.103）。</p>
<p>安装配置步骤参考第2节（tracker 的配置可以忽略），因为只有一个 tracker，故 tracker_server 的配置仍然指向 192.168.1.102:22122（如果有多个 tracker，配置多行）。以下是一些差异性配置。</p>
<h4 id="6-1-client-配置"><a href="#6-1-client-配置" class="headerlink" title="6.1 client 配置"></a>6.1 client 配置</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tracker_server=192.168.1.102:22122</div></pre></td></tr></table></figure>
<h4 id="6-2-storage-配置"><a href="#6-2-storage-配置" class="headerlink" title="6.2 storage 配置"></a>6.2 storage 配置</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">group_name=group2</div><div class="line">tracker_server=192.168.1.102:22122</div></pre></td></tr></table></figure>
<h4 id="6-3-fastdfs-nginx-module-配置"><a href="#6-3-fastdfs-nginx-module-配置" class="headerlink" title="6.3 fastdfs-nginx-module 配置"></a>6.3 fastdfs-nginx-module 配置</h4><p>编辑 mod_fastdfs.conf 配置文件：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">tracker_server=192.168.1.102:22122</div><div class="line">group_name=group2</div></pre></td></tr></table></figure>
<h4 id="6-4-nginx-配置"><a href="#6-4-nginx-配置" class="headerlink" title="6.4 nginx 配置"></a>6.4 nginx 配置</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">location /group2/M00 &#123;</div><div class="line">    root /data/fastdfs/storage/;</div><div class="line">    ngx_fastdfs_module;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>创建目录：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> mkdir -p /data/fastdfs/storage/data/group2</span></div></pre></td></tr></table></figure>
<p>创建软链接：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> ln -s /data/fastdfs/storage/data /data/fastdfs/storage/data/group2/M00</span></div></pre></td></tr></table></figure>
<h4 id="6-5-启动服务"><a href="#6-5-启动服务" class="headerlink" title="6.5 启动服务"></a>6.5 启动服务</h4><p>启动 storage 和 nginx 服务即可。集群完成。</p>
<h3 id="7-客户端使用"><a href="#7-客户端使用" class="headerlink" title="7. 客户端使用"></a>7. 客户端使用</h3><p>下载客户端源码：<a href="https://github.com/happyfish100/fastdfs-client-java" target="_blank" rel="external">https://github.com/happyfish100/fastdfs-client-java</a></p>
<p>编译安装：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mvn clean install</div></pre></td></tr></table></figure>
<p>工具类（JDK 1.7 或以上）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * FastDFS 客户端工具</div><div class="line"> * Created by fanlychei on 2017/9/22.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">FastDFSClient</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> StorageClient1 storageClient;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 上传文件</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> file 文件对象</div><div class="line">     * <span class="doctag">@return</span> 上传如果成功, 则返回表示该文件的文件ID字符串; 否则抛出异常</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">uploadFile</span><span class="params">(File file)</span> </span>&#123;</div><div class="line">        String name = file.getName();</div><div class="line">        <span class="keyword">int</span> index = name.lastIndexOf(<span class="string">"."</span>);</div><div class="line">        String extension = index == -<span class="number">1</span> ? <span class="keyword">null</span> : name.substring(index + <span class="number">1</span>);</div><div class="line">        <span class="keyword">byte</span>[] sources;</div><div class="line">        InputStream inputStream = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            inputStream = <span class="keyword">new</span> FileInputStream(file);</div><div class="line">            sources = <span class="keyword">new</span> <span class="keyword">byte</span>[inputStream.available()];</div><div class="line">            inputStream.read(sources);</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ExceptionWrapper(e);</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            <span class="keyword">if</span> (inputStream != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    inputStream.close();</div><div class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;&#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> storage(sources, extension);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 存储任意源到文件</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> sources 源</div><div class="line">     * <span class="doctag">@return</span> 存储如果成功, 则返回表示该文件的文件ID字符串; 否则抛出异常</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">storage</span><span class="params">(<span class="keyword">byte</span>[] sources)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> storage(sources, <span class="keyword">null</span>);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 存储任意源到文件</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> sources   源</div><div class="line">     * <span class="doctag">@param</span> extension 存储的文件扩展名</div><div class="line">     * <span class="doctag">@return</span> 存储如果成功, 则返回表示该文件的文件ID字符串; 否则抛出异常</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">storage</span><span class="params">(<span class="keyword">byte</span>[] sources, String extension)</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">return</span> storageClient.upload_file1(sources, extension, <span class="keyword">null</span>);</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ExceptionWrapper(e);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 更新文件, 更新时, 先上传新的文件, 若上传成功, 则删除原文件; 若新文件上传失败, 则原文件不会被删除, 并抛出异常</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> fileId  原文件ID</div><div class="line">     * <span class="doctag">@param</span> newFile 新的文件对象</div><div class="line">     * <span class="doctag">@return</span> 先上传新的文件, 若上传成功, 则删除原文件, 并返回新的文件ID; 若新文件上传失败, 则原文件不会被删除, 并抛出异常</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">updateFile</span><span class="params">(String fileId, File newFile)</span> </span>&#123;</div><div class="line">        String newFileId = uploadFile(newFile);</div><div class="line">        delete(fileId);</div><div class="line">        <span class="keyword">return</span> newFileId;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 更新源, 更新时, 先存储新的源内容, 若存储成功, 则删除原文件; 若存储失败, 则原文件不会被删除, 并抛出异常</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> fileId     原文件ID</div><div class="line">     * <span class="doctag">@param</span> newSources 新的源内容</div><div class="line">     * <span class="doctag">@return</span> 先存储新的源内容, 若存储成功, 则删除原文件, 并返回新的文件ID; 若存储失败, 则原文件不会被删除, 并抛出异常</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">modify</span><span class="params">(String fileId, <span class="keyword">byte</span>[] newSources)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> modify(fileId, newSources, <span class="keyword">null</span>);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 更新源, 更新时, 先存储新的源内容, 若存储成功, 则删除原文件; 若存储失败, 则原文件不会被删除, 并抛出异常</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> fileId     原文件ID</div><div class="line">     * <span class="doctag">@param</span> newSources 新的源内容</div><div class="line">     * <span class="doctag">@param</span> extension 存储的文件扩展名</div><div class="line">     * <span class="doctag">@return</span> 先存储新的源内容, 若存储成功, 则删除原文件, 并返回新的文件ID; 若存储失败, 则原文件不会被删除, 并抛出异常</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">modify</span><span class="params">(String fileId, <span class="keyword">byte</span>[] newSources, String extension)</span> </span>&#123;</div><div class="line">        String newFileId = storage(newSources, extension);</div><div class="line">        delete(fileId);</div><div class="line">        <span class="keyword">return</span> newFileId;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 删除文件</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> fileId 文件ID</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">delete</span><span class="params">(String fileId)</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            storageClient.delete_file1(fileId);</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ExceptionWrapper(e);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 下载文件</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> fileId       文件ID</div><div class="line">     * <span class="doctag">@param</span> outputStream 输出流对象</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">downloadFile</span><span class="params">(String fileId, OutputStream outputStream)</span> </span>&#123;</div><div class="line">        <span class="keyword">byte</span>[] bytes;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            bytes = storageClient.download_file1(fileId);</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ExceptionWrapper(e);</div><div class="line">        &#125;</div><div class="line">        InputStream inputStream = <span class="keyword">new</span> ByteArrayInputStream(bytes);</div><div class="line">        <span class="keyword">try</span> (BufferedInputStream bis = <span class="keyword">new</span> BufferedInputStream(inputStream);</div><div class="line">             BufferedOutputStream bos = <span class="keyword">new</span> BufferedOutputStream(outputStream)) &#123;</div><div class="line">            <span class="keyword">int</span> read;</div><div class="line">            <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">512</span> * <span class="number">1024</span>];</div><div class="line">            <span class="keyword">while</span> ((read = bis.read(buffer)) != -<span class="number">1</span>) &#123;</div><div class="line">                bos.write(buffer, <span class="number">0</span>, read);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">            <span class="keyword">if</span> (!e.getClass().getSimpleName().equals(<span class="string">"ClientAbortException"</span>)) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ExceptionWrapper(e);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 下载文件</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> response 客户端响应对象</div><div class="line">     * <span class="doctag">@param</span> fileId   文件ID</div><div class="line">     * <span class="doctag">@param</span> fileName 客户端下载框中显示的文件名称, 如果有扩展名, 该名称应含文件的扩展名</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">downloadFile</span><span class="params">(HttpServletResponse response, String fileId, String fileName)</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            fileName = <span class="keyword">new</span> String(fileName.getBytes(<span class="string">"UTF-8"</span>), <span class="string">"ISO-8859-1"</span>);</div><div class="line">            response.setContentType(<span class="string">"application/octet-stream; charset=iso-8859-1"</span>);</div><div class="line">            response.setHeader(<span class="string">"Content-Disposition"</span>, <span class="string">"attachment; filename="</span> + fileName);</div><div class="line">            downloadFile(fileId, response.getOutputStream());</div><div class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ExceptionWrapper(e);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 初始化 FastDFS</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            ClientGlobal.initByProperties(<span class="string">"fastdfs-client.properties"</span>);</div><div class="line">            TrackerClient trackerClient = <span class="keyword">new</span> TrackerClient(ClientGlobal.getG_tracker_group());</div><div class="line">            TrackerServer trackerServer = trackerClient.getConnection();</div><div class="line">            <span class="keyword">if</span> (trackerServer == <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> FastDFSClientException(<span class="string">"连接 FastDFS 服务失败"</span>);</div><div class="line">            &#125;</div><div class="line">            StorageServer storageServer = trackerClient.getStoreStorage(trackerServer);</div><div class="line">            <span class="keyword">if</span> (storageServer == <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> FastDFSClientException(<span class="string">"获取 FastDFS 存储对象失败"</span>);</div><div class="line">            &#125;</div><div class="line">            storageClient = <span class="keyword">new</span> StorageClient1(trackerServer, storageServer);</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ExceptionWrapper(e);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 第一次加载时执行初始化工作</div><div class="line">     */</div><div class="line">    <span class="keyword">static</span> &#123; init(); &#125;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 异常包装器, 将非运行时异常包装成运行时异常并在运行时抛出</div><div class="line">     */</div><div class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ExceptionWrapper</span> <span class="keyword">extends</span> <span class="title">RuntimeException</span> </span>&#123;</div><div class="line">        </div><div class="line">        <span class="keyword">private</span> Throwable cause;</div><div class="line">        </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ExceptionWrapper</span><span class="params">(Throwable throwable)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>.cause = throwable;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> Throwable <span class="title">getCause</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> cause;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * FastDFS 客户端异常</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">FastDFSClientException</span> <span class="keyword">extends</span> <span class="title">RuntimeException</span> </span>&#123;</div><div class="line">    </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">FastDFSClientException</span><span class="params">(String message)</span> </span>&#123;</div><div class="line">            <span class="keyword">super</span>(message);</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>fastdfs-client.properties 配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">fastdfs.connect_timeout_in_seconds = 2</div><div class="line">fastdfs.network_timeout_in_seconds = 30</div><div class="line">fastdfs.charset = UTF-8</div><div class="line">fastdfs.http_anti_steal_token = false</div><div class="line">fastdfs.http_secret_key = FastDFS1234567890</div><div class="line">fastdfs.http_tracker_http_port = 8080</div><div class="line">    </div><div class="line">fastdfs.tracker_servers = 192.168.1.102:22122</div></pre></td></tr></table></figure>
<p>单元测试：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FastDFSClientTest</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 测试文件上传</div><div class="line">     */</div><div class="line">    <span class="meta">@Test</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testUploadFile</span><span class="params">()</span> </span>&#123;</div><div class="line">        File file = <span class="keyword">new</span> File(<span class="string">"src/test/resources/demo.txt"</span>);</div><div class="line">        String fileID = FastDFSClient.uploadFile(file);</div><div class="line">        System.out.println(fileID);</div><div class="line"></div><div class="line">        file = <span class="keyword">new</span> File(<span class="string">"src/test/resources/demo.txt"</span>);</div><div class="line">        fileID = FastDFSClient.uploadFile(file);</div><div class="line">        System.out.println(fileID);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 测试内容存储</div><div class="line">     */</div><div class="line">    <span class="meta">@Test</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testStorage</span><span class="params">()</span> </span>&#123;</div><div class="line">        String fileID = FastDFSClient.storage(<span class="string">"Hello World!!!"</span>.getBytes());</div><div class="line">        System.out.println(fileID);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 测试内容修改更新, 文件更新使用 updateFile</div><div class="line">     */</div><div class="line">    <span class="meta">@Test</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testModify</span><span class="params">()</span> </span>&#123;</div><div class="line">        String fileID = FastDFSClient.modify(<span class="string">"group1/M00/00/00/wKiLgVnHDwOAdxolAAAADtiRrk0132.txt"</span>, <span class="string">"Hello FastDFS!!!"</span>.getBytes());</div><div class="line">        System.out.println(fileID);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 测试文件下载</div><div class="line">     */</div><div class="line">    <span class="meta">@Test</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testDownloadFile</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        OutputStream os = <span class="keyword">new</span> FileOutputStream(<span class="string">"src/test/resources/demo-download.txt"</span>);</div><div class="line">        FastDFSClient.downloadFile(<span class="string">"group1/M00/00/00/wKiLgVnHFRKAZDZJAAAAEB_3vnU4400918"</span>, os);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>示例项目源码地址：<a href="https://github.com/fanlychie/fastdfs-java-sample" target="_blank" rel="external">https://github.com/fanlychie/fastdfs-java-sample</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;FastDFS 是一个开源的轻量级分布式文件系统，它对文件进行管理，功能包括：文件存储、文件同步、文件访问（文件上传、文件下载）等，解决了大容量存储和负载均衡的问题。适合以文件为载体的在线服务，如图片网站、视频网站等等。&lt;/p&gt;
    
    </summary>
    
    
      <category term="FastDFS" scheme="http://yoursite.com/tags/FastDFS/"/>
    
  </entry>
  
  <entry>
    <title>Jenkins 定时任务</title>
    <link href="http://yoursite.com/post/jenkins-schedule.html"/>
    <id>http://yoursite.com/post/jenkins-schedule.html</id>
    <published>2017-08-20T10:24:11.000Z</published>
    <updated>2017-11-05T07:58:53.541Z</updated>
    
    <content type="html"><![CDATA[<h3 id="1-创建自由风格的软件项目"><a href="#1-创建自由风格的软件项目" class="headerlink" title="1. 创建自由风格的软件项目"></a>1. 创建自由风格的软件项目</h3><p>创建一个自由风格的软件项目，并找到<code>构建触发器</code>项，勾选<code>Build periodically</code>：</p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/jenkins-schedule.png" alt=""></p>
<a id="more"></a>
<p>首次需要手工点一次任务构建，以后就会定时自动构建了。</p>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;1-创建自由风格的软件项目&quot;&gt;&lt;a href=&quot;#1-创建自由风格的软件项目&quot; class=&quot;headerlink&quot; title=&quot;1. 创建自由风格的软件项目&quot;&gt;&lt;/a&gt;1. 创建自由风格的软件项目&lt;/h3&gt;&lt;p&gt;创建一个自由风格的软件项目，并找到&lt;code&gt;构建触发器&lt;/code&gt;项，勾选&lt;code&gt;Build periodically&lt;/code&gt;：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/fanlychie/mdimg/master/jenkins-schedule.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
    
    </summary>
    
    
      <category term="Jenkins" scheme="http://yoursite.com/tags/Jenkins/"/>
    
  </entry>
  
  <entry>
    <title>Jenkins SSH 远程执行 Shell 脚本</title>
    <link href="http://yoursite.com/post/jenkins-remote-ssh.html"/>
    <id>http://yoursite.com/post/jenkins-remote-ssh.html</id>
    <published>2017-08-20T07:44:41.000Z</published>
    <updated>2017-11-05T07:34:42.950Z</updated>
    
    <content type="html"><![CDATA[<h3 id="1-安装插件"><a href="#1-安装插件" class="headerlink" title="1. 安装插件"></a>1. 安装插件</h3><p>系统管理 -&gt; 管理插件 -&gt; 可用插件，搜索：SSH Plugin</p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/jenkins-ssh-1.png" alt=""></p>
<a id="more"></a>
<h3 id="2-远程主机身份配置"><a href="#2-远程主机身份配置" class="headerlink" title="2. 远程主机身份配置"></a>2. 远程主机身份配置</h3><p>Credentials –&gt; global –&gt; Add Credentials</p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/jenkins-ssh-2.png" alt=""></p>
<h3 id="3-远程主机SSH配置"><a href="#3-远程主机SSH配置" class="headerlink" title="3. 远程主机SSH配置"></a>3. 远程主机SSH配置</h3><p>系统管理 –&gt; 系统设置，找到<code>SSH remote hosts</code>项，点击添加按钮：</p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/jenkins-ssh-3.png" alt=""></p>
<h3 id="4-远程主机SSH免密登陆配置"><a href="#4-远程主机SSH免密登陆配置" class="headerlink" title="4. 远程主机SSH免密登陆配置"></a>4. 远程主机SSH免密登陆配置</h3><p>当前主机信息：</p>
<ul>
<li>IP：192.168.1.202</li>
<li>用户：root</li>
</ul>
<p>目标主机信息：</p>
<ul>
<li>IP：192.168.1.201</li>
<li>用户：fanlychie</li>
</ul>
<p>主机202以root用户身份免密SSH登陆到主机201的fanlychie用户的配置方式：</p>
<p>① 在主机202以root用户身份执行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> ssh-keygen -t rsa</span></div></pre></td></tr></table></figure>
<p>② 一路回车，生成的密钥文件在当前用户的目录的<code>.ssh</code>目录中。</p>
<p>③ 复制主机202用户目录下的id_rsa.pub文件到主机201的fanlychie用户目录下的<code>.ssh</code>目录中，并将文件重命名为authorized_keys：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">cd</span> ~/.ssh/ &amp;&amp; scp id_rsa.pub fanlychie@192.168.1.201:/home/fanlychie/.ssh/authorized_keys</span></div></pre></td></tr></table></figure>
<p>④ 验证SSH免密登陆，在主机202以root用户身份执行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> ssh fanlychie@192.168.1.201</span></div></pre></td></tr></table></figure>
<p>如果能顺利登陆主机201，说明配置成功。</p>
<p>⑤ 退出SSH登陆：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">exit</span></span></div></pre></td></tr></table></figure>
<p>如果主机202需要远程登陆多台目标主机，如主机203，只需要从第3步开始配置即可。</p>
<h3 id="5-验证配置"><a href="#5-验证配置" class="headerlink" title="5. 验证配置"></a>5. 验证配置</h3><p>新建一个自由风格的软件项目，在<code>构建</code>项里面选择<code>增加构建后操作步骤</code>并选择<code>Execute shell script on remote host using ssh</code>：</p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/jenkins-ssh-4.png" alt=""></p>
<p>在目标主机201中编写测试脚本：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> ~ &amp;&amp; mkdir scripts &amp;&amp; vi scripts/hello.sh</span></div></pre></td></tr></table></figure>
<p>测试内容如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">#!/bin/bash</div><div class="line"> </div><div class="line">echo '========================================='</div><div class="line">echo 'Hello World!'</div><div class="line">echo '========================================='</div></pre></td></tr></table></figure>
<p>保存退出。并修改文件权限为可执行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span><span class="bash"> chmod 764 scripts/hello.sh</span></div></pre></td></tr></table></figure>
<p>构建任务：</p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/jenkins-ssh-5.png" alt=""></p>
<h3 id="6-环境变量"><a href="#6-环境变量" class="headerlink" title="6. 环境变量"></a>6. 环境变量</h3><p>上面这种远程SSH到目标主机属于<code>NoLogin</code>方式，无法获取 PATH 等环境变量。</p>
<p>Jenkins构建好项目之后，如果应用服务器跟Jenkins服务器不是同一台主机，那Jenkins就需要通过SSH远程将应用的部署包发布到目标主机。执行发布的过程，通常需要目标主机环境变量的支持。例如：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">#!/bin/bash</div><div class="line"> </div><div class="line">java -version</div></pre></td></tr></table></figure>
<p>构建结果：</p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/jenkins-ssh-6.png" alt=""></p>
<p>实际上，java 环境变量是已经在服务器中配置好了的。但由于是<code>NoLogin</code>的方式登陆，无法获取 PATH 等环境变量导致。目前我的解决方法是在脚本中重新定义一次。如：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">#!/bin/bash</div><div class="line"> </div><div class="line">JAVA_HOME=/usr/local/jdk1.8.0_144</div><div class="line">CLASSPATH=.:$JAVA_HOME/lib</div><div class="line">PATH=$PATH:$JAVA_HOME/bin</div><div class="line">export JAVA_HOME CLASSPATH PATH</div><div class="line"> </div><div class="line">java -version</div></pre></td></tr></table></figure>
<p>构建结果：</p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/jenkins-ssh-7.png" alt=""></p>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;1-安装插件&quot;&gt;&lt;a href=&quot;#1-安装插件&quot; class=&quot;headerlink&quot; title=&quot;1. 安装插件&quot;&gt;&lt;/a&gt;1. 安装插件&lt;/h3&gt;&lt;p&gt;系统管理 -&amp;gt; 管理插件 -&amp;gt; 可用插件，搜索：SSH Plugin&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/fanlychie/mdimg/master/jenkins-ssh-1.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
    
    </summary>
    
    
      <category term="Jenkins" scheme="http://yoursite.com/tags/Jenkins/"/>
    
  </entry>
  
  <entry>
    <title>Jenkins 为视图添加控制台按钮</title>
    <link href="http://yoursite.com/post/jenkins-console-icon.html"/>
    <id>http://yoursite.com/post/jenkins-console-icon.html</id>
    <published>2017-08-20T06:42:32.000Z</published>
    <updated>2017-11-05T05:54:18.655Z</updated>
    
    <content type="html"><![CDATA[<h3 id="1-安装插件"><a href="#1-安装插件" class="headerlink" title="1. 安装插件"></a>1. 安装插件</h3><p>系统管理 -&gt; 管理插件 -&gt; 可用插件，搜索：Console Column Plugin</p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/jenkins-console-1.png" alt=""></p>
<a id="more"></a>
<h3 id="2-编辑视图"><a href="#2-编辑视图" class="headerlink" title="2. 编辑视图"></a>2. 编辑视图</h3><p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/jenkins-console-2.png" alt=""></p>
<h3 id="3-添加列"><a href="#3-添加列" class="headerlink" title="3. 添加列"></a>3. 添加列</h3><p>视图的列顺序可以自由拖放改变，按照你自己的习惯摆放即可。</p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/jenkins-console-3.png" alt=""></p>
<h3 id="4-效果图"><a href="#4-效果图" class="headerlink" title="4. 效果图"></a>4. 效果图</h3><p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/jenkins-console-4.png" alt=""></p>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;1-安装插件&quot;&gt;&lt;a href=&quot;#1-安装插件&quot; class=&quot;headerlink&quot; title=&quot;1. 安装插件&quot;&gt;&lt;/a&gt;1. 安装插件&lt;/h3&gt;&lt;p&gt;系统管理 -&amp;gt; 管理插件 -&amp;gt; 可用插件，搜索：Console Column Plugin&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/fanlychie/mdimg/master/jenkins-console-1.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
    
    </summary>
    
    
      <category term="Jenkins" scheme="http://yoursite.com/tags/Jenkins/"/>
    
  </entry>
  
  <entry>
    <title>Jenkins 视图管理</title>
    <link href="http://yoursite.com/post/jenkins-view.html"/>
    <id>http://yoursite.com/post/jenkins-view.html</id>
    <published>2017-08-20T04:12:22.000Z</published>
    <updated>2017-11-05T05:19:12.130Z</updated>
    
    <content type="html"><![CDATA[<h3 id="1-添加视图"><a href="#1-添加视图" class="headerlink" title="1. 添加视图"></a>1. 添加视图</h3><p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/jenkins-view.png" alt=""></p>
<a id="more"></a>
<h3 id="2-填写信息"><a href="#2-填写信息" class="headerlink" title="2. 填写信息"></a>2. 填写信息</h3><p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/jenkins-view-2.png" alt=""></p>
<h3 id="3-配置信息"><a href="#3-配置信息" class="headerlink" title="3. 配置信息"></a>3. 配置信息</h3><p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/jenkins-view-3.png" alt=""></p>
<h3 id="4-效果图"><a href="#4-效果图" class="headerlink" title="4. 效果图"></a>4. 效果图</h3><p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/jenkins-view-4.png" alt=""></p>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;1-添加视图&quot;&gt;&lt;a href=&quot;#1-添加视图&quot; class=&quot;headerlink&quot; title=&quot;1. 添加视图&quot;&gt;&lt;/a&gt;1. 添加视图&lt;/h3&gt;&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/fanlychie/mdimg/master/jenkins-view.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
    
    </summary>
    
    
      <category term="Jenkins" scheme="http://yoursite.com/tags/Jenkins/"/>
    
  </entry>
  
  <entry>
    <title>使用 Jenkins 进行持续集成</title>
    <link href="http://yoursite.com/post/jenkins-guide.html"/>
    <id>http://yoursite.com/post/jenkins-guide.html</id>
    <published>2017-08-19T14:52:52.000Z</published>
    <updated>2017-11-04T19:13:38.611Z</updated>
    
    <content type="html"><![CDATA[<p>Jenkins 的前身是 Hudson，它是基于 Java 开发的一种持续集成（Continuous Integration，简称 CI）开源工具。用于持续交付、自动构建、测试、发布和监控等，无需过多的人工干预，利于提高开发的效率。</p>
<a id="more"></a>
<h3 id="1-安装"><a href="#1-安装" class="headerlink" title="1. 安装"></a>1. 安装</h3><p>到 <a href="https://jenkins.io/" target="_blank" rel="external">Jenkins</a> 官网下载安装包 <a href="https://pkg.jenkins.io/redhat-stable/jenkins-2.60.3-1.1.noarch.rpm" target="_blank" rel="external">jenkins-2.60.3-1.1.noarch.rpm</a>。Jenkins 2.54 或以上的版本需要 JDK 8 或以上的版本作为运行时环境。如果你系统环境的 JDK 版本低于 8，请选用低于 2.54 的 Jenkins 安装包。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> rpm -ivh jenkins-2.60.3-1.1.noarch.rpm</span></div></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>目录</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>/usr/lib/jenkins/</td>
<td>war 包目录</td>
</tr>
<tr>
<td>/var/lib/jenkins/</td>
<td>默认的 JENKINS_HOME 目录</td>
</tr>
<tr>
<td>/var/log/jenkins/</td>
<td>日志文件目录</td>
</tr>
<tr>
<td>/etc/sysconfig/jenkins</td>
<td>配置文件</td>
</tr>
</tbody>
</table>
<h4 id="1-1-JDK-配置"><a href="#1-1-JDK-配置" class="headerlink" title="1.1 JDK 配置"></a>1.1 JDK 配置</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> vi /etc/init.d/jenkins</span></div></pre></td></tr></table></figure>
<p>在 66 行附近找到 candidates 的配置：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">candidates="</div><div class="line">/etc/alternatives/java</div><div class="line">/usr/lib/jvm/java-1.8.0/bin/java</div><div class="line">/usr/lib/jvm/jre-1.8.0/bin/java</div><div class="line">/usr/lib/jvm/java-1.7.0/bin/java</div><div class="line">/usr/lib/jvm/jre-1.7.0/bin/java</div><div class="line">/usr/bin/java</div><div class="line">"</div></pre></td></tr></table></figure>
<p>将你机器的 JDK 安装目录下的 /bin/java 文件的路径添加到第一行，其余行也可以删掉：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">candidates="</div><div class="line">/usr/local/jdk1.8.0_144/bin/java</div><div class="line">"</div></pre></td></tr></table></figure>
<h4 id="1-2-端口配置（可选）："><a href="#1-2-端口配置（可选）：" class="headerlink" title="1.2 端口配置（可选）："></a>1.2 端口配置（可选）：</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> vi /etc/sysconfig/jenkins</span></div></pre></td></tr></table></figure>
<p>在 56 行，默认端口是 8080，可自行修改：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">JENKINS_PORT="8888"</div></pre></td></tr></table></figure>
<h4 id="1-3-用户配置"><a href="#1-3-用户配置" class="headerlink" title="1.3 用户配置"></a>1.3 用户配置</h4><p>Jenkins 安装时默认创建了一个名为 jenkins 的用户，为避免 Jenkins 运行时没有操作其他文件的权限，可修改为其他权限用户，比如 root：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> vi /etc/sysconfig/jenkins</span></div></pre></td></tr></table></figure>
<p>在 29 行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"><span class="comment"># Type:        string</span></span></div><div class="line"><span class="meta">#</span><span class="bash"><span class="comment"># Default:     "jenkins"</span></span></div><div class="line"><span class="meta">#</span><span class="bash"><span class="comment"># ServiceRestart: jenkins</span></span></div><div class="line"><span class="meta">#</span><span class="bash"></span></div><div class="line"><span class="meta">#</span><span class="bash"> Unix user account that runs the Jenkins daemon</span></div><div class="line"><span class="meta">#</span><span class="bash"> Be careful when you change this, as you need to update</span></div><div class="line"><span class="meta">#</span><span class="bash"> permissions of <span class="variable">$JENKINS_HOME</span> and /var/<span class="built_in">log</span>/jenkins.</span></div><div class="line"><span class="meta">#</span><span class="bash"></span></div><div class="line">JENKINS_USER="root"</div></pre></td></tr></table></figure>
<h4 id="1-4-命令行"><a href="#1-4-命令行" class="headerlink" title="1.4 命令行"></a>1.4 命令行</h4><p>启动：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">service jenkins start</div></pre></td></tr></table></figure>
<p>停止：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">service jenkins stop</div></pre></td></tr></table></figure>
<p>重启：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">service jenkins restart</div></pre></td></tr></table></figure>
<h4 id="1-5-启动应用"><a href="#1-5-启动应用" class="headerlink" title="1.5 启动应用"></a>1.5 启动应用</h4><p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/jenkins_1.png" alt=""></p>
<p>第一次使用 Jenkins 时，它会自动生成一个随机的口令。你需要输入正确的口令才能进入系统。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span><span class="bash"> cat /var/lib/jenkins/secrets/initialAdminPassword</span></div></pre></td></tr></table></figure>
<p>复制并粘贴口令进入到安装界面：</p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/jenkins_2.png" alt=""></p>
<p>选择第一项<code>Install suggested plugins</code>，等待安装完成。待安装完成之后，创建管理员账户：</p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/jenkins_3.png" alt=""></p>
<p>至此，安装完成。</p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/jenkins_4.png" alt=""></p>
<h3 id="2-应用配置"><a href="#2-应用配置" class="headerlink" title="2. 应用配置"></a>2. 应用配置</h3><h4 id="2-1-JDK-配置"><a href="#2-1-JDK-配置" class="headerlink" title="2.1 JDK 配置"></a>2.1 JDK 配置</h4><p><code>系统管理 -&gt; Global Tool Configuration</code></p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/jenkins_5.png" alt=""></p>
<h4 id="2-2-Maven-配置"><a href="#2-2-Maven-配置" class="headerlink" title="2.2 Maven 配置"></a>2.2 Maven 配置</h4><p><code>系统管理 -&gt; Global Tool Configuration</code></p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/jenkins_7.png" alt=""></p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/jenkins_6.png" alt=""></p>
<h4 id="2-3-SVN-账户配置"><a href="#2-3-SVN-账户配置" class="headerlink" title="2.3 SVN 账户配置"></a>2.3 SVN 账户配置</h4><p><code>Credentials -&gt; global -&gt; Add Credentials</code></p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/jenkins_8.png" alt=""></p>
<h4 id="2-4-GIT-账户配置"><a href="#2-4-GIT-账户配置" class="headerlink" title="2.4 GIT 账户配置"></a>2.4 GIT 账户配置</h4><p><code>Credentials -&gt; global -&gt; Add Credentials</code></p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/jenkins_9.png" alt=""></p>
<h4 id="2-5-Maven-集成插件"><a href="#2-5-Maven-集成插件" class="headerlink" title="2.5 Maven 集成插件"></a>2.5 Maven 集成插件</h4><p><code>系统管理 -&gt; 管理插件 -&gt; Maven Integration plugin</code></p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/jenkins_10.png" alt=""></p>
<h4 id="2-6-发布插件"><a href="#2-6-发布插件" class="headerlink" title="2.6 发布插件"></a>2.6 发布插件</h4><p><code>系统管理 -&gt; 管理插件 -&gt; Deploy to container Plugin</code></p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/jenkins_11.png" alt=""></p>
<h3 id="3-创建任务"><a href="#3-创建任务" class="headerlink" title="3. 创建任务"></a>3. 创建任务</h3><p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/jenkins_12.png" alt=""></p>
<h3 id="4-任务配置"><a href="#4-任务配置" class="headerlink" title="4. 任务配置"></a>4. 任务配置</h3><p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/jenkins_13.png" alt=""></p>
<p>附 Shell 脚本源码：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/bin/bash</span></div><div class="line"> </div><div class="line"><span class="comment"># 必须, 否则Tomcat无法启动</span></div><div class="line"><span class="string">export</span> <span class="string">BUILD_ID=anything</span></div><div class="line"> </div><div class="line"><span class="comment"># 应用部署到的Tomcat的路径, 不同项目只需改变此参数即可</span></div><div class="line"><span class="string">app_tomcat_path=/home/fanlychie/application/helloworld-demo-tomcat</span></div><div class="line"> </div><div class="line"><span class="comment"># 工作区间</span></div><div class="line"><span class="string">workspace=$WORKSPACE</span></div><div class="line"> </div><div class="line"><span class="comment"># 应用的名称</span></div><div class="line"><span class="string">app_final_name=$&#123;workspace##*/&#125;</span></div><div class="line"> </div><div class="line"><span class="comment"># 应用Tomcat的名称, 用于查杀进程</span></div><div class="line"><span class="string">app_tomcat_name=$&#123;app_tomcat_path##*/&#125;</span></div><div class="line"> </div><div class="line"><span class="comment"># 应用包备份的目录</span></div><div class="line"><span class="string">app_backup_path=$app_tomcat_path/backup</span></div><div class="line"> </div><div class="line"><span class="comment"># 应用包备份的路径</span></div><div class="line"><span class="string">app_backup_pathname=$app_backup_path/`echo</span> <span class="string">| awk '&#123;print strftime("%Y-%m-%d-%H-%M-%S")&#125;'`</span></div><div class="line"> </div><div class="line"># 应用Tomcat的进程ID</div><div class="line">app_tomcat_process_id=`ps -ef | grep $app_tomcat_name | grep -v grep | awk '&#123;print $2&#125;'`</div><div class="line"> </div><div class="line"># 杀掉进程</div><div class="line">if [ $app_tomcat_process_id != "" ]; then</div><div class="line">    kill -9 $app_tomcat_process_id</div><div class="line">fi</div><div class="line"> </div><div class="line"># 创建备份目录</div><div class="line">if [ ! -d $app_backup_path ]; then</div><div class="line">    mkdir $app_backup_path</div><div class="line">fi</div><div class="line"> </div><div class="line"># 创建备份路径</div><div class="line">mkdir $app_backup_pathname</div><div class="line"> </div><div class="line"># 备份应用</div><div class="line">cp -r $app_tomcat_path/webapps/ROOT $app_backup_pathname</div><div class="line"> </div><div class="line"># 清空目录</div><div class="line">rm -rf $app_tomcat_path/webapps/ROOT/*</div><div class="line"> </div><div class="line"># 拷贝应用包</div><div class="line">cp -f $&#123;workspace&#125;/target/*.war $&#123;app_tomcat_path&#125;/webapps/ROOT</div><div class="line"> </div><div class="line"># 进入ROOT目录</div><div class="line">cd $&#123;app_tomcat_path&#125;/webapps/ROOT</div><div class="line"> </div><div class="line"># 解压缩应用包</div><div class="line">jar xvf *.war</div><div class="line"> </div><div class="line"># 删除应用包</div><div class="line">rm -f *.war</div><div class="line"> </div><div class="line"># 启动应用Tomcat服务</div><div class="line">$&#123;app_tomcat_path&#125;/bin/startup.sh</div></pre></td></tr></table></figure>
<h3 id="5-用户管理"><a href="#5-用户管理" class="headerlink" title="5. 用户管理"></a>5. 用户管理</h3><p><code>系统管理 -&gt; Configure Global Security</code></p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/jenkins_15.png" alt=""></p>
<p><code>系统管理 -&gt; 管理用户 -&gt; 新建用户</code></p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/jenkins_14.png" alt=""></p>
<p>用户新建完成后再到<code>系统管理 -&gt; Configure Global Security</code>添加用户并配置权限。</p>
<blockquote>
<p>环境：Java-8、Maven-3、Tomcat-8、Jenkins-2.60.3、Centos-6</p>
</blockquote>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Jenkins 的前身是 Hudson，它是基于 Java 开发的一种持续集成（Continuous Integration，简称 CI）开源工具。用于持续交付、自动构建、测试、发布和监控等，无需过多的人工干预，利于提高开发的效率。&lt;/p&gt;
    
    </summary>
    
    
      <category term="Jenkins" scheme="http://yoursite.com/tags/Jenkins/"/>
    
  </entry>
  
  <entry>
    <title>dubbo 集群容错</title>
    <link href="http://yoursite.com/post/dubbo-cluster-fault-tolerance.html"/>
    <id>http://yoursite.com/post/dubbo-cluster-fault-tolerance.html</id>
    <published>2017-07-29T10:18:21.000Z</published>
    <updated>2017-07-30T10:08:01.956Z</updated>
    
    <content type="html"><![CDATA[<p>在集群调用失败时，dubbo 提供了多种可选的容错方案：</p>
<p><code>failover</code>、<code>failfast</code>、<code>failsafe</code>、<code>failback</code>、<code>forking</code>、<code>broadcast</code></p>
<a id="more"></a>
<h3 id="1-failover"><a href="#1-failover" class="headerlink" title="1. failover"></a>1. failover</h3><p>失败自动切换，当出现失败，重试其它服务器。通常用于读操作，但重试会带来更长延迟。</p>
<p>在缺省配置的情况下，dubbo 采用此方案作为默认的集群容错模式（可以通过<code>cluster</code>参数设置），并默认失败重试2次（不含第一次）调用其他的服务器（可以通过<code>retries</code>参数设置）。直至重试次数用完或调用成功为止。失败一次消费者调用方就会抛一个异常，但只要有一次调用是成功的，结果就是成功的。除非全部调用都失败了，结果才是失败的。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- 服务提供者方的配置 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dubbo:service</span> <span class="attr">retries</span>=<span class="string">"2"</span> /&gt;</span></div><div class="line"> </div><div class="line"><span class="comment">&lt;!-- 服务消费者方的配置 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dubbo:reference</span> <span class="attr">retries</span>=<span class="string">"2"</span> /&gt;</span></div><div class="line"> </div><div class="line"><span class="comment">&lt;!-- 服务消费者方的配置 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dubbo:reference</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dubbo:method</span> <span class="attr">name</span>=<span class="string">"findFoo"</span> <span class="attr">retries</span>=<span class="string">"2"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dubbo:reference</span>&gt;</span></div></pre></td></tr></table></figure>
<p>注解配置示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 服务提供者方的配置</span></div><div class="line"><span class="meta">@com</span>.alibaba.dubbo.config.annotation.Service(retries = <span class="number">2</span>)</div><div class="line"> </div><div class="line"><span class="comment">// 服务消费者方的配置</span></div><div class="line"><span class="meta">@com</span>.alibaba.dubbo.config.annotation.Reference(retries = <span class="number">2</span>)</div></pre></td></tr></table></figure>
<h3 id="2-failfast"><a href="#2-failfast" class="headerlink" title="2. failfast"></a>2. failfast</h3><p>快速失败，只发起一次调用，失败立即报错。通常用于非幂等性的写操作，比如新增记录。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- 服务提供者方的配置 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dubbo:service</span> <span class="attr">cluster</span>=<span class="string">"failfast"</span> /&gt;</span></div><div class="line"> </div><div class="line"><span class="comment">&lt;!-- 服务消费者方的配置 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dubbo:reference</span> <span class="attr">cluster</span>=<span class="string">"failfast"</span> /&gt;</span></div></pre></td></tr></table></figure>
<p>注解配置示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 服务提供者方的配置（亲测不起作用）</span></div><div class="line"><span class="meta">@com</span>.alibaba.dubbo.config.annotation.Service(cluster = <span class="string">"failfast"</span>)</div><div class="line"> </div><div class="line"><span class="comment">// 服务消费者方的配置</span></div><div class="line"><span class="meta">@com</span>.alibaba.dubbo.config.annotation.Reference(cluster = <span class="string">"failfast"</span>)</div></pre></td></tr></table></figure>
<h3 id="3-failsafe"><a href="#3-failsafe" class="headerlink" title="3. failsafe"></a>3. failsafe</h3><p>失败安全，出现异常时，直接忽略。通常用于写入审计日志等操作。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- 服务提供者方的配置 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dubbo:service</span> <span class="attr">cluster</span>=<span class="string">"failsafe"</span> /&gt;</span></div><div class="line"> </div><div class="line"><span class="comment">&lt;!-- 服务消费者方的配置 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dubbo:reference</span> <span class="attr">cluster</span>=<span class="string">"failsafe"</span> /&gt;</span></div></pre></td></tr></table></figure>
<p>注解配置示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 服务提供者方的配置（亲测不起作用）</span></div><div class="line"><span class="meta">@com</span>.alibaba.dubbo.config.annotation.Service(cluster = <span class="string">"failsafe"</span>)</div><div class="line"> </div><div class="line"><span class="comment">// 服务消费者方的配置</span></div><div class="line"><span class="meta">@com</span>.alibaba.dubbo.config.annotation.Reference(cluster = <span class="string">"failsafe"</span>)</div></pre></td></tr></table></figure>
<h3 id="4-failback"><a href="#4-failback" class="headerlink" title="4. failback"></a>4. failback</h3><p>失败自动恢复，后台记录失败请求，定时重发。通常用于消息通知操作。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- 服务提供者方的配置 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dubbo:service</span> <span class="attr">cluster</span>=<span class="string">"failback"</span> /&gt;</span></div><div class="line"> </div><div class="line"><span class="comment">&lt;!-- 服务消费者方的配置 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dubbo:reference</span> <span class="attr">cluster</span>=<span class="string">"failback"</span> /&gt;</span></div></pre></td></tr></table></figure>
<p>注解配置示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 服务提供者方的配置（亲测不起作用）</span></div><div class="line"><span class="meta">@com</span>.alibaba.dubbo.config.annotation.Service(cluster = <span class="string">"failback"</span>)</div><div class="line"> </div><div class="line"><span class="comment">// 服务消费者方的配置</span></div><div class="line"><span class="meta">@com</span>.alibaba.dubbo.config.annotation.Reference(cluster = <span class="string">"failback"</span>)</div></pre></td></tr></table></figure>
<h3 id="5-forking"><a href="#5-forking" class="headerlink" title="5. forking"></a>5. forking</h3><p>并行调用多个服务器，只要一个成功即返回。通常用于实时性要求较高的读操作，但需要浪费更多服务资源。可通过<code>forks=&quot;2&quot;</code>来设置最大并行数。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- 服务提供者方的配置 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dubbo:service</span> <span class="attr">cluster</span>=<span class="string">"forking"</span> /&gt;</span></div><div class="line"> </div><div class="line"><span class="comment">&lt;!-- 服务消费者方的配置 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dubbo:reference</span> <span class="attr">cluster</span>=<span class="string">"forking"</span> /&gt;</span></div></pre></td></tr></table></figure>
<p>注解配置示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 服务提供者方的配置（亲测不起作用）</span></div><div class="line"><span class="meta">@com</span>.alibaba.dubbo.config.annotation.Service(cluster = <span class="string">"forking"</span>)</div><div class="line"> </div><div class="line"><span class="comment">// 服务消费者方的配置</span></div><div class="line"><span class="meta">@com</span>.alibaba.dubbo.config.annotation.Reference(cluster = <span class="string">"forking"</span>)</div></pre></td></tr></table></figure>
<h3 id="6-broadcast"><a href="#6-broadcast" class="headerlink" title="6. broadcast"></a>6. broadcast</h3><p>广播调用所有提供者，逐个调用，任意一台报错则报错。（2.1.0开始支持）通常用于通知所有提供者更新缓存或日志等本地资源信息。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- 服务提供者方的配置 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dubbo:service</span> <span class="attr">cluster</span>=<span class="string">"broadcast"</span> /&gt;</span></div><div class="line"> </div><div class="line"><span class="comment">&lt;!-- 服务消费者方的配置 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dubbo:reference</span> <span class="attr">cluster</span>=<span class="string">"broadcast"</span> /&gt;</span></div></pre></td></tr></table></figure>
<p>注解配置示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 服务提供者方的配置（亲测不起作用）</span></div><div class="line"><span class="meta">@com</span>.alibaba.dubbo.config.annotation.Service(cluster = <span class="string">"broadcast"</span>)</div><div class="line"> </div><div class="line"><span class="comment">// 服务消费者方的配置</span></div><div class="line"><span class="meta">@com</span>.alibaba.dubbo.config.annotation.Reference(cluster = <span class="string">"broadcast"</span>)</div></pre></td></tr></table></figure>
<blockquote>
<p>参考文档文献链接：<a href="http://dubbo.io/user-guide/demos/集群容错.html" target="_blank" rel="external">dubbo集群容错</a></p>
</blockquote>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;在集群调用失败时，dubbo 提供了多种可选的容错方案：&lt;/p&gt;
&lt;p&gt;&lt;code&gt;failover&lt;/code&gt;、&lt;code&gt;failfast&lt;/code&gt;、&lt;code&gt;failsafe&lt;/code&gt;、&lt;code&gt;failback&lt;/code&gt;、&lt;code&gt;forking&lt;/code&gt;、&lt;code&gt;broadcast&lt;/code&gt;&lt;/p&gt;
    
    </summary>
    
    
      <category term="Dubbo" scheme="http://yoursite.com/tags/Dubbo/"/>
    
  </entry>
  
  <entry>
    <title>dubbo 关闭启动时检查解决服务之间调用的问题</title>
    <link href="http://yoursite.com/post/resolve-dubbo-services-call-situation.html"/>
    <id>http://yoursite.com/post/resolve-dubbo-services-call-situation.html</id>
    <published>2017-07-28T07:26:57.000Z</published>
    <updated>2017-07-28T12:47:41.218Z</updated>
    
    <content type="html"><![CDATA[<p>dubbo 缺省会在启动时检查依赖的服务是否可用，不可用时会抛出异常，阻止 Spring 初始化完成，以便上线前，能及早发现问题，默认<code>check=&quot;true&quot;</code>。</p>
<p>如果你的 Spring 容器是懒加载的，或者通过 API 编程延迟引用服务，请关闭检查，否则服务临时不可用时会抛出异常，拿到 null 引用，如果<code>check=&quot;false&quot;</code>，总是会返回引用，当服务恢复时，能自动连上。</p>
<p>比如对一些不关心的服务，或者服务之间出现了相互依赖必须有一方先启动时，你可以关闭检查避免异常。</p>
<a id="more"></a>
<h3 id="1-场景描述"><a href="#1-场景描述" class="headerlink" title="1. 场景描述"></a>1. 场景描述</h3><p>假设现有两个已知的服务：用户中心服务、订单中心服务。它们作为服务提供者分别向 dubbo 注册了自己。用户中心服务中的<code>UserServiceImpl</code>调用了订单中心服务的<code>OrderServiceImpl</code>，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderServiceImpl</span> <span class="keyword">implements</span> <span class="title">OrderService</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">findByUserIdAndOrderStatus</span><span class="params">(Integer userId, String orderStatus)</span> </span>&#123;</div><div class="line">        <span class="comment">// do something</span></div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserService</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> OrderService orderService;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">findPaidOrdersById</span><span class="params">(Integer id)</span> </span>&#123;</div><div class="line">        <span class="comment">// do something</span></div><div class="line">        orderService.findByUserIdAndOrderStatus(id, <span class="string">"PAID"</span>);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="2-XML-配置方式"><a href="#2-XML-配置方式" class="headerlink" title="2. XML 配置方式"></a>2. XML 配置方式</h3><p>订单中心服务配置信息的代码片段：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- 声明 Bean --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"orderService"</span> <span class="attr">class</span>=<span class="string">"org.fanlychie.service.OrderServiceImpl"</span> /&gt;</span></div><div class="line"> </div><div class="line"><span class="comment">&lt;!-- 声明需要暴露的服务接口 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dubbo:service</span> <span class="attr">interface</span>=<span class="string">"org.fanlychie.service.OrderService"</span> <span class="attr">ref</span>=<span class="string">"orderService"</span> /&gt;</span></div></pre></td></tr></table></figure>
<p>用户中心服务配置信息的代码片段：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- 声明引用的服务, check 设为 false 以关闭服务的启动时检查, 避免服务启动顺序引发的异常 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dubbo:reference</span> <span class="attr">id</span>=<span class="string">"orderService"</span> <span class="attr">interface</span>=<span class="string">"org.fanlychie.service.OrderService"</span> <span class="attr">check</span>=<span class="string">"false"</span> /&gt;</span></div><div class="line"> </div><div class="line"><span class="comment">&lt;!-- 声明 Bean --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"userService"</span> <span class="attr">class</span>=<span class="string">"org.fanlychie.service.UserServiceImpl"</span>&gt;</span></div><div class="line">    <span class="comment">&lt;!-- 声明依赖的服务 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"orderService"</span> <span class="attr">ref</span>=<span class="string">"orderService"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"> </div><div class="line"><span class="comment">&lt;!-- 声明需要暴露的服务接口 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dubbo:service</span> <span class="attr">interface</span>=<span class="string">"org.fanlychie.service.UserService"</span> <span class="attr">ref</span>=<span class="string">"userService"</span> /&gt;</span></div></pre></td></tr></table></figure>
<p><code>&lt;dubbo:reference&gt;</code>的 check 属性设为 false 以关闭服务的启动时检查，否则服务的启动顺序不当会直接导致服务启动不了。如<code>check=true</code>（默认）若先启动用户中心服务会报以下异常导致服务启动失败：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">java.lang.IllegalStateException: Failed to check the status of the service ...</div></pre></td></tr></table></figure>
<p>在用户心中调用订单中心的服务示例代码片段，相关的依赖需要通过 setter 方法注入：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserService</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> OrderService orderService;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">findPaidOrdersById</span><span class="params">(Integer id)</span> </span>&#123;</div><div class="line">        <span class="comment">// do something</span></div><div class="line">        orderService.findByUserIdAndOrderStatus(id, <span class="string">"PAID"</span>);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOrderService</span><span class="params">(OrderService orderService)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.orderService = orderService;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="3-注解的方式"><a href="#3-注解的方式" class="headerlink" title="3. 注解的方式"></a>3. 注解的方式</h3><p>订单中心的服务接口使用<code>com.alibaba.dubbo.config.annotation.@Service</code>注解直接暴露服务：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> org.fanlychie.service;</div><div class="line"> </div><div class="line"><span class="keyword">import</span> com.alibaba.dubbo.config.annotation.Service;</div><div class="line"> </div><div class="line"><span class="meta">@Service</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderServiceImpl</span> <span class="keyword">implements</span> <span class="title">OrderService</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">findByUserIdAndOrderStatus</span><span class="params">(Integer userId, String orderStatus)</span> </span>&#123;</div><div class="line">        <span class="comment">// do something</span></div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>用户中心的服务接口使用<code>com.alibaba.dubbo.config.annotation.@Service</code>注解暴露服务，并使用使用<code>com.alibaba.dubbo.config.annotation.@Reference</code>注解引用订单中心的接口服务：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> org.fanlychie.service;</div><div class="line"> </div><div class="line"><span class="keyword">import</span> com.alibaba.dubbo.config.annotation.Reference;</div><div class="line"><span class="keyword">import</span> com.alibaba.dubbo.config.annotation.Service;</div><div class="line"> </div><div class="line"><span class="meta">@Service</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserService</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Reference</span></div><div class="line">    <span class="keyword">private</span> OrderService orderService;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">findPaidOrdersById</span><span class="params">(Integer id)</span> </span>&#123;</div><div class="line">        <span class="comment">// do something</span></div><div class="line">        orderService.findByUserIdAndOrderStatus(id, <span class="string">"PAID"</span>);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>引用的服务的属性<code>check</code>应设为 false 以关闭服务的启动时检查，避免服务启动顺序引发的异常。使用注解<code>@Reference(check = false)</code>的方式是无效的，需要在调用方(本文为用户中心)的配置文件中添加：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- 关闭引用服务的启动时检查 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dubbo:consumer</span> <span class="attr">check</span>=<span class="string">"false"</span> /&gt;</span></div></pre></td></tr></table></figure>
<blockquote>
<p>参考文档文献链接：<a href="http://dubbo.io/user-guide/demos/启动时检查.html" target="_blank" rel="external">启动时检查</a></p>
</blockquote>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;dubbo 缺省会在启动时检查依赖的服务是否可用，不可用时会抛出异常，阻止 Spring 初始化完成，以便上线前，能及早发现问题，默认&lt;code&gt;check=&amp;quot;true&amp;quot;&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;如果你的 Spring 容器是懒加载的，或者通过 API 编程延迟引用服务，请关闭检查，否则服务临时不可用时会抛出异常，拿到 null 引用，如果&lt;code&gt;check=&amp;quot;false&amp;quot;&lt;/code&gt;，总是会返回引用，当服务恢复时，能自动连上。&lt;/p&gt;
&lt;p&gt;比如对一些不关心的服务，或者服务之间出现了相互依赖必须有一方先启动时，你可以关闭检查避免异常。&lt;/p&gt;
    
    </summary>
    
    
      <category term="Dubbo" scheme="http://yoursite.com/tags/Dubbo/"/>
    
  </entry>
  
  <entry>
    <title>dubbo 注解方式整合 springmvc</title>
    <link href="http://yoursite.com/post/dubbo-annotation-with-springmvc.html"/>
    <id>http://yoursite.com/post/dubbo-annotation-with-springmvc.html</id>
    <published>2017-07-27T17:54:38.000Z</published>
    <updated>2017-07-28T10:18:24.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="1-项目结构"><a href="#1-项目结构" class="headerlink" title="1. 项目结构"></a>1. 项目结构</h3><p>创建一个 maven 多模块项目，结构如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">dubbo-annotation-with-springmvc-sample（父模块）</div><div class="line">|</div><div class="line">|__ user-module-api（服务接口模块）</div><div class="line">|</div><div class="line">|__ user-module-provider（服务提供者）</div><div class="line">|</div><div class="line">|__ user-module-consumer（服务消费者）</div></pre></td></tr></table></figure>
<a id="more"></a>
<h4 id="1-1-父模块项目"><a href="#1-1-父模块项目" class="headerlink" title="1.1 父模块项目"></a>1.1 父模块项目</h4><p>dubbo-annotation-with-springmvc-sample/pom.xml 配置如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></div><div class="line">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd"</span>&gt;</div><div class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.fanlychie<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dubbo-annotation-with-springmvc-sample<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>dubbo-annotation-with-springmvc-sample<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>Sample project for Dubbo<span class="tag">&lt;/<span class="name">description</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.apache.org<span class="tag">&lt;/<span class="name">url</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">modules</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">module</span>&gt;</span>user-module-api<span class="tag">&lt;/<span class="name">module</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">module</span>&gt;</span>user-module-provider<span class="tag">&lt;/<span class="name">module</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">module</span>&gt;</span>user-module-consumer<span class="tag">&lt;/<span class="name">module</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">modules</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dubbo.version</span>&gt;</span>2.5.3<span class="tag">&lt;/<span class="name">dubbo.version</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">spring.version</span>&gt;</span>4.3.7.RELEASE<span class="tag">&lt;/<span class="name">spring.version</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.fanlychie<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>user-module-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dubbo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">                <span class="comment">&lt;!-- dubbo依赖的spring版本（2.5）较低, 排除此依赖, 使用自己的spring版本 --&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></div><div class="line">                        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">                        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></div><div class="line">                <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;dubbo.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-webmvc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.8.8<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.101tec<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>zkclient<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></div></pre></td></tr></table></figure>
<h4 id="1-2-服务接口模块"><a href="#1-2-服务接口模块" class="headerlink" title="1.2 服务接口模块"></a>1.2 服务接口模块</h4><p>user-module-api/pom.xml 配置如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></div><div class="line">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd"</span>&gt;</div><div class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.fanlychie<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dubbo-annotation-with-springmvc-sample<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>user-module-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>jar<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>user-module-api<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.apache.org<span class="tag">&lt;/<span class="name">url</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></div></pre></td></tr></table></figure>
<p>编写注册用户的示例服务接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> org.fanlychie.service;</div><div class="line">    </div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserService</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">register</span><span class="params">(String username, String password)</span></span>;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="1-3-服务提供者"><a href="#1-3-服务提供者" class="headerlink" title="1.3 服务提供者"></a>1.3 服务提供者</h4><p>user-module-provider/pom.xml 配置如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></div><div class="line">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd"</span>&gt;</div><div class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.fanlychie<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dubbo-annotation-with-springmvc-sample<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>user-module-provider<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>jar<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>user-module-provider<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.apache.org<span class="tag">&lt;/<span class="name">url</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.fanlychie<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>user-module-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dubbo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.101tec<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>zkclient<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></div><div class="line">            <span class="comment">&lt;!-- 打包配置, 输出可执行的 jar 包 --&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-assembly-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">executions</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">execution</span>&gt;</span></div><div class="line">                        <span class="tag">&lt;<span class="name">id</span>&gt;</span>make-assembly<span class="tag">&lt;/<span class="name">id</span>&gt;</span></div><div class="line">                        <span class="tag">&lt;<span class="name">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></div><div class="line">                        <span class="tag">&lt;<span class="name">goals</span>&gt;</span></div><div class="line">                            <span class="tag">&lt;<span class="name">goal</span>&gt;</span>single<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></div><div class="line">                        <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></div><div class="line">                <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">archive</span>&gt;</span></div><div class="line">                        <span class="tag">&lt;<span class="name">manifest</span>&gt;</span></div><div class="line">                            <span class="tag">&lt;<span class="name">mainClass</span>&gt;</span>com.alibaba.dubbo.container.Main<span class="tag">&lt;/<span class="name">mainClass</span>&gt;</span></div><div class="line">                        <span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;/<span class="name">archive</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">descriptorRefs</span>&gt;</span></div><div class="line">                        <span class="tag">&lt;<span class="name">descriptorRef</span>&gt;</span>jar-with-dependencies<span class="tag">&lt;/<span class="name">descriptorRef</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;/<span class="name">descriptorRefs</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">appendAssemblyId</span>&gt;</span>false<span class="tag">&lt;/<span class="name">appendAssemblyId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></div></pre></td></tr></table></figure>
<p>实现服务接口，使用<code>com.alibaba.dubbo.config.annotation.@Service</code>注解暴露服务：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> org.fanlychie.service;</div><div class="line">    </div><div class="line"><span class="keyword">import</span> com.alibaba.dubbo.config.annotation.Service;</div><div class="line">    </div><div class="line"><span class="meta">@Service</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserService</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(String username, String password)</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"---------------------------------------------------------"</span>);</div><div class="line">        System.out.println(String.format(<span class="string">"接收到注册用户请求 - &#123;username:%s, password:%s&#125;"</span>,</div><div class="line">                username, password));</div><div class="line">        System.out.println(<span class="string">"---------------------------------------------------------"</span>);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>user-module-provider/src/main/resources/dubbo.properties 配置如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">dubbo.spring.config=classpath:spring-dubbo-provider.xml</div></pre></td></tr></table></figure>
<p>user-module-provider/src/main/resources/spring-dubbo-provider.xml 配置如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></div><div class="line">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></div><div class="line">       <span class="attr">xmlns:dubbo</span>=<span class="string">"http://code.alibabatech.com/schema/dubbo"</span></div><div class="line">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans</span></div><div class="line">       http://www.springframework.org/schema/beans/spring-beans.xsd</div><div class="line">       http://code.alibabatech.com/schema/dubbo</div><div class="line">       http://code.alibabatech.com/schema/dubbo/dubbo.xsd"&gt;</div><div class="line">    </div><div class="line">    <span class="comment">&lt;!-- 提供方应用信息，用于计算依赖关系 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dubbo:application</span> <span class="attr">name</span>=<span class="string">"user-module-provider"</span>/&gt;</span></div><div class="line">    </div><div class="line">    <span class="comment">&lt;!-- 使用ZK注册中心暴露服务地址 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dubbo:registry</span> <span class="attr">address</span>=<span class="string">"zookeeper://127.0.0.1:2181"</span>/&gt;</span></div><div class="line">    </div><div class="line">    <span class="comment">&lt;!-- 用Dubbo协议在20880端口暴露服务 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dubbo:protocol</span> <span class="attr">name</span>=<span class="string">"dubbo"</span> <span class="attr">port</span>=<span class="string">"20880"</span>/&gt;</span></div><div class="line">    </div><div class="line">    <span class="comment">&lt;!-- 扫描注解包路径，多个包用逗号分隔 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dubbo:annotation</span> <span class="attr">package</span>=<span class="string">"org.fanlychie.service"</span>/&gt;</span></div><div class="line">    </div><div class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></div></pre></td></tr></table></figure>
<p>user-module-provider/src/main/resources/log4j.properties 配置如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">log4j.rootCategory = INFO, console</div><div class="line">log4j.appender.console = org.apache.log4j.ConsoleAppender</div><div class="line">log4j.appender.console.target = System.out</div><div class="line">log4j.appender.console.layout = org.apache.log4j.PatternLayout</div><div class="line">log4j.appender.console.layout.conversionPattern = %d&#123;yyyy-MM-dd HH:mm:ss:SSS&#125; [%t] %-<span class="number">5</span>p [%c&#123;<span class="number">1</span>&#125;:%L] - %m%n</div></pre></td></tr></table></figure>
<h4 id="1-4-服务消费者"><a href="#1-4-服务消费者" class="headerlink" title="1.4 服务消费者"></a>1.4 服务消费者</h4><p>user-module-consumer/pom.xml 配置如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></div><div class="line">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd"</span>&gt;</div><div class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.fanlychie<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dubbo-annotation-with-springmvc-sample<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>user-module-consumer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>war<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>user-module-consumer<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.apache.org<span class="tag">&lt;/<span class="name">url</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.fanlychie<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>user-module-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dubbo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-webmvc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.101tec<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>zkclient<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">finalName</span>&gt;</span>autosellrobot-wechat<span class="tag">&lt;/<span class="name">finalName</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat.maven<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tomcat7-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">path</span>&gt;</span>/<span class="tag">&lt;/<span class="name">path</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">port</span>&gt;</span>8080<span class="tag">&lt;/<span class="name">port</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">uriEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">uriEncoding</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://localhost:8080/manager/html<span class="tag">&lt;/<span class="name">url</span>&gt;</span></div><div class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></div></pre></td></tr></table></figure>
<p>服务消费者使用<code>com.alibaba.dubbo.config.annotation.@Reference</code>注解引用接口服务：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> com.alibaba.dubbo.config.annotation.Reference;</div><div class="line"><span class="keyword">import</span> org.fanlychie.service.UserService;</div><div class="line"><span class="keyword">import</span> org.springframework.util.StringUtils;</div><div class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</div><div class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</div><div class="line">    </div><div class="line"><span class="meta">@RestController</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Reference</span></div><div class="line">    <span class="keyword">private</span> UserService userService;</div><div class="line">    </div><div class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/user/register"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">register</span><span class="params">(String username, String password)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!StringUtils.hasText(username) || !StringUtils.hasText(password)) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="string">"用户名或密码不能为空"</span>;</div><div class="line">        &#125;</div><div class="line">        userService.register(username, password);</div><div class="line">        <span class="keyword">return</span> <span class="string">"注册完成"</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>user-module-consumer/src/main/webapp/WEB-INF/web.xml 配置如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">version</span>=<span class="string">"2.5"</span> <span class="attr">xmlns</span>=<span class="string">"http://java.sun.com/xml/ns/javaee"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd"</span>&gt;</span></div><div class="line">    </div><div class="line">    <span class="tag">&lt;<span class="name">context-param</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>classpath:spring-context.xml<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">context-param</span>&gt;</span></div><div class="line">    </div><div class="line">    <span class="tag">&lt;<span class="name">listener</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">listener-class</span>&gt;</span>org.springframework.web.util.IntrospectorCleanupListener<span class="tag">&lt;/<span class="name">listener-class</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">listener</span>&gt;</span></div><div class="line">    </div><div class="line">    <span class="tag">&lt;<span class="name">listener</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">listener-class</span>&gt;</span>org.springframework.web.context.request.RequestContextListener<span class="tag">&lt;/<span class="name">listener-class</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">listener</span>&gt;</span></div><div class="line">    </div><div class="line">    <span class="tag">&lt;<span class="name">listener</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">listener-class</span>&gt;</span>org.springframework.web.context.ContextLoaderListener<span class="tag">&lt;/<span class="name">listener-class</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">listener</span>&gt;</span></div><div class="line">    </div><div class="line">    <span class="tag">&lt;<span class="name">filter</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>encodingFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.springframework.web.filter.CharacterEncodingFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>encoding<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>forceEncoding<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>encodingFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></div><div class="line">    </div><div class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>dispatcherServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>classpath:spring-mvc.xml<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>1<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>dispatcherServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></div><div class="line">    </div><div class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></div></pre></td></tr></table></figure>
<p>user-module-consumer/src/main/resources/log4j.properties 配置如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">log4j.rootCategory = INFO, console</div><div class="line">log4j.appender.console = org.apache.log4j.ConsoleAppender</div><div class="line">log4j.appender.console.target = System.out</div><div class="line">log4j.appender.console.layout = org.apache.log4j.PatternLayout</div><div class="line">log4j.appender.console.layout.conversionPattern = %d&#123;yyyy-MM-dd HH:mm:ss:SSS&#125; [%t] %-<span class="number">5</span>p [%c&#123;<span class="number">1</span>&#125;:%L] - %m%n</div></pre></td></tr></table></figure>
<p>user-module-consumer/src/main/resources/spring-context.xml 配置如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></div><div class="line">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></div><div class="line">       <span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span></div><div class="line">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans</span></div><div class="line">       http://www.springframework.org/schema/beans/spring-beans.xsd</div><div class="line">       http://www.springframework.org/schema/context</div><div class="line">       http://www.springframework.org/schema/context/spring-context.xsd"&gt;</div><div class="line">    </div><div class="line">    <span class="tag">&lt;<span class="name">context:annotation-config</span>/&gt;</span></div><div class="line">    </div><div class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">"org.fanlychie"</span>/&gt;</span></div><div class="line">    </div><div class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></div></pre></td></tr></table></figure>
<p>user-module-consumer/src/main/resources/spring-mvc.xml 配置如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></div><div class="line">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></div><div class="line">       <span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span></div><div class="line">       <span class="attr">xmlns:dubbo</span>=<span class="string">"http://code.alibabatech.com/schema/dubbo"</span></div><div class="line">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans</span></div><div class="line">       http://www.springframework.org/schema/beans/spring-beans.xsd</div><div class="line">       http://www.springframework.org/schema/context</div><div class="line">       http://www.springframework.org/schema/context/spring-context.xsd</div><div class="line">       http://code.alibabatech.com/schema/dubbo</div><div class="line">       http://code.alibabatech.com/schema/dubbo/dubbo.xsd"&gt;</div><div class="line">    </div><div class="line">    <span class="comment">&lt;!-- 提供方应用信息，用于计算依赖关系 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dubbo:application</span> <span class="attr">name</span>=<span class="string">"user-module-consumer"</span>/&gt;</span></div><div class="line">    </div><div class="line">    <span class="comment">&lt;!-- 使用ZK注册中心暴露服务地址 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dubbo:registry</span> <span class="attr">address</span>=<span class="string">"zookeeper://127.0.0.1:2181"</span>/&gt;</span></div><div class="line">    </div><div class="line">    <span class="comment">&lt;!-- 扫描注解包路径，多个包用逗号分隔 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dubbo:annotation</span> <span class="attr">package</span>=<span class="string">"org.fanlychie.controller"</span>/&gt;</span></div><div class="line">    </div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"useSuffixPatternMatch"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"useTrailingSlashMatch"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line">    </div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"stringHttpMessageConverter"</span> <span class="attr">class</span>=<span class="string">"org.springframework.http.converter.StringHttpMessageConverter"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">value</span>=<span class="string">"UTF-8"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"supportedMediaTypes"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">list</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>text/html;charset=utf-8<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>application/xml;charset=utf-8<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>application/json;charset=utf-8<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">list</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line">    </div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"mappingJackson2HttpMessageConverter"</span></span></div><div class="line">          <span class="attr">class</span>=<span class="string">"org.springframework.http.converter.json.MappingJackson2HttpMessageConverter"</span>&gt;</div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"prefixJson"</span> <span class="attr">value</span>=<span class="string">"false"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"supportedMediaTypes"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">list</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>text/html;charset=utf-8<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>application/xml;charset=utf-8<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>application/json;charset=utf-8<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">list</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line">    </div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"messageConverters"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">list</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">"stringHttpMessageConverter"</span>/&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">"mappingJackson2HttpMessageConverter"</span>/&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">list</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line">    </div><div class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">"org.fanlychie.**.controller"</span>/&gt;</span></div><div class="line">    </div><div class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></div></pre></td></tr></table></figure>
<p>服务消费者方 dubbo 注解扫描配置的信息不能独立出 springmvc 配置文件，否则<code>@Reference</code>注解引用的接口实例会出现 Null 的状况。</p>
<blockquote>
<p>示例项目开发环境：Java-8、Maven-3、IntelliJ IDEA-2017、Spring-4.7、Dubbo-2.5.3<br>完整示例项目链接：<a href="https://github.com/fanlychie/dubbo-samples/tree/master/dubbo-annotation-with-springmvc-sample" target="_blank" rel="external">dubbo-annotation-with-springmvc-sample</a><br>参考文档文献链接：<a href="http://dubbo.io/user-guide/" target="_blank" rel="external">dubbo用户指南</a></p>
</blockquote>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;1-项目结构&quot;&gt;&lt;a href=&quot;#1-项目结构&quot; class=&quot;headerlink&quot; title=&quot;1. 项目结构&quot;&gt;&lt;/a&gt;1. 项目结构&lt;/h3&gt;&lt;p&gt;创建一个 maven 多模块项目，结构如下：&lt;/p&gt;
&lt;figure class=&quot;highlight html&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;dubbo-annotation-with-springmvc-sample（父模块）&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;|&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;|__ user-module-api（服务接口模块）&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;|&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;|__ user-module-provider（服务提供者）&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;|&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;|__ user-module-consumer（服务消费者）&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
    
      <category term="Dubbo" scheme="http://yoursite.com/tags/Dubbo/"/>
    
  </entry>
  
  <entry>
    <title>dubbo 配置方式</title>
    <link href="http://yoursite.com/post/dubbo-configurations.html"/>
    <id>http://yoursite.com/post/dubbo-configurations.html</id>
    <published>2017-07-27T08:12:08.000Z</published>
    <updated>2017-07-28T10:18:07.961Z</updated>
    
    <content type="html"><![CDATA[<p>dubbo 提供了4种服务配置的方式，它们分别是：XML 配置、属性配置、注解配置、API 配置（官方不推荐 API 配置的方式）。本文只介绍前三种，API 配置方式可<a href="http://dubbo.io/user-guide/configuration/api.html" target="_blank" rel="external">点此前往官方文档查看API配置</a>。</p>
<a id="more"></a>
<h3 id="1-XML-配置"><a href="#1-XML-配置" class="headerlink" title="1. XML 配置"></a>1. XML 配置</h3><p>配置参考手册：</p>
<table>
<thead>
<tr>
<th>标签</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="http://dubbo.io/user-guide/reference-xmlconf/dubbo-service.html" target="_blank" rel="external"><code>&lt;dubbo:service&gt;</code></a></td>
<td>服务提供者暴露服务配置，用于定义服务的元信息，一个服务可以用多个协议暴露，一个服务也可以注册到多个注册中心。</td>
</tr>
<tr>
<td><a href="http://dubbo.io/user-guide/reference-xmlconf/dubbo-protocol.html" target="_blank" rel="external"><code>&lt;dubbo:protocol&gt;</code></a></td>
<td>服务提供者协议配置，用于配置提供服务的协议信息，协议由提供方指定，消费方被动接受。</td>
</tr>
<tr>
<td><a href="http://dubbo.io/user-guide/reference-xmlconf/dubbo-reference.html" target="_blank" rel="external"><code>&lt;dubbo:reference&gt;</code></a></td>
<td>服务消费者引用服务配置，用于创建一个远程服务代理，一个引用可以指向多个注册中心。</td>
</tr>
<tr>
<td><a href="http://dubbo.io/user-guide/reference-xmlconf/dubbo-registry.html" target="_blank" rel="external"><code>&lt;dubbo:registry&gt;</code></a></td>
<td>注册中心配置，用于配置连接注册中心相关信息。</td>
</tr>
<tr>
<td><a href="http://dubbo.io/user-guide/reference-xmlconf/dubbo-application.html" target="_blank" rel="external"><code>&lt;dubbo:application&gt;</code></a></td>
<td>应用配置，用于配置当前应用信息，不管该应用是提供者还是消费者。</td>
</tr>
<tr>
<td><a href="http://dubbo.io/user-guide/reference-xmlconf/dubbo-module.html" target="_blank" rel="external"><code>&lt;dubbo:module&gt;</code></a></td>
<td>模块配置，用于配置当前模块信息，可选。</td>
</tr>
<tr>
<td><a href="http://dubbo.io/user-guide/reference-xmlconf/dubbo-monitor.html" target="_blank" rel="external"><code>&lt;dubbo:monitor&gt;</code></a></td>
<td>监控中心配置，用于配置连接监控中心相关信息，可选。</td>
</tr>
<tr>
<td><a href="http://dubbo.io/user-guide/reference-xmlconf/dubbo-provider.html" target="_blank" rel="external"><code>&lt;dubbo:provider&gt;</code></a></td>
<td>服务提供者缺省值配置，当 ProtocolConfig 和 ServiceConfig 某属性没有配置时，采用此缺省值，可选。</td>
</tr>
<tr>
<td><a href="http://dubbo.io/user-guide/reference-xmlconf/dubbo-consumer.html" target="_blank" rel="external"><code>&lt;dubbo:consumer&gt;</code></a></td>
<td>服务消费者缺省值配置，当 ReferenceConfig 某属性没有配置时，采用此缺省值，可选。</td>
</tr>
<tr>
<td><a href="http://dubbo.io/user-guide/reference-xmlconf/dubbo-method.html" target="_blank" rel="external"><code>&lt;dubbo:method&gt;</code></a></td>
<td>方法配置，用于 ServiceConfig 和 ReferenceConfig 指定方法级的配置信息。</td>
</tr>
<tr>
<td><a href="http://dubbo.io/user-guide/reference-xmlconf/dubbo-argument.html" target="_blank" rel="external"><code>&lt;dubbo:argument&gt;</code></a></td>
<td>方法参数配置。</td>
</tr>
</tbody>
</table>
<p>注：标签属性只有<code>group</code>,<code>interface</code>,<code>version</code>是服务的匹配条件，三者用于共同决定是否是同一个服务，其它属性配置项均为调优和治理参数。</p>
<h4 id="1-1-dubbo-service"><a href="#1-1-dubbo-service" class="headerlink" title="1.1 dubbo:service"></a>1.1 dubbo:service</h4><p>必填属性参考列表（更多可选参数可<a href="http://dubbo.io/user-guide/reference-xmlconf/dubbo-service.html" target="_blank" rel="external">点此前往官方文档</a>查看）：</p>
<table>
<thead>
<tr>
<th style="text-align:center">属性名称</th>
<th style="text-align:center">类型</th>
<th style="text-align:center">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">interface</td>
<td style="text-align:center">class</td>
<td style="text-align:center">服务接口名</td>
</tr>
<tr>
<td style="text-align:center">ref</td>
<td style="text-align:center">object</td>
<td style="text-align:center">服务对象实现引用</td>
</tr>
</tbody>
</table>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dubbo:service</span> <span class="attr">interface</span>=<span class="string">"org.fanlychie.service.UserService"</span> <span class="attr">ref</span>=<span class="string">"userService"</span>/&gt;</span></div><div class="line"> </div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"userService"</span> <span class="attr">class</span>=<span class="string">"org.fanlychie.service.UserServiceImpl"</span>/&gt;</span></div></pre></td></tr></table></figure>
<h4 id="1-2-dubbo-protocol"><a href="#1-2-dubbo-protocol" class="headerlink" title="1.2 dubbo:protocol"></a>1.2 dubbo:protocol</h4><p>必填属性参考列表（更多可选参数可<a href="http://dubbo.io/user-guide/reference-xmlconf/dubbo-protocol.html" target="_blank" rel="external">点此前往官方文档</a>查看）：</p>
<table>
<thead>
<tr>
<th style="text-align:center">属性名称</th>
<th style="text-align:center">类型</th>
<th style="text-align:center">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">name</td>
<td style="text-align:center">string</td>
<td style="text-align:center">协议名称</td>
</tr>
</tbody>
</table>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dubbo:protocol</span> <span class="attr">name</span>=<span class="string">"dubbo"</span> <span class="attr">port</span>=<span class="string">"20880"</span>/&gt;</span></div></pre></td></tr></table></figure>
<p>dubbo 支持的协议有：<code>dubbo</code>、<code>rmi</code>、<code>hessian</code>、<code>http</code>、<code>webservice</code>、<code>thrift</code>、<code>redis</code>、<code>memcached</code>。各个协议的介绍和使用场景可<a href="http://dubbo.io/user-guide/reference-protocol/introduction.html" target="_blank" rel="external">点此前往官方文档查看协议参考手册</a>。</p>
<h4 id="1-3-dubbo-reference"><a href="#1-3-dubbo-reference" class="headerlink" title="1.3 dubbo:reference"></a>1.3 dubbo:reference</h4><p>必填属性参考列表（更多可选参数可<a href="http://dubbo.io/user-guide/reference-xmlconf/dubbo-reference.html" target="_blank" rel="external">点此前往官方文档</a>查看）：</p>
<table>
<thead>
<tr>
<th style="text-align:center">属性名称</th>
<th style="text-align:center">类型</th>
<th style="text-align:center">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">id</td>
<td style="text-align:center">string</td>
<td style="text-align:center">服务引用的 Bean ID</td>
</tr>
<tr>
<td style="text-align:center">interface</td>
<td style="text-align:center">class</td>
<td style="text-align:center">服务接口名</td>
</tr>
</tbody>
</table>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dubbo:reference</span> <span class="attr">id</span>=<span class="string">"userService"</span> <span class="attr">interface</span>=<span class="string">"org.fanlychie.service.UserService"</span> /&gt;</span></div></pre></td></tr></table></figure>
<h4 id="1-4-dubbo-registry"><a href="#1-4-dubbo-registry" class="headerlink" title="1.4 dubbo:registry"></a>1.4 dubbo:registry</h4><p>必填属性参考列表（更多可选参数可<a href="http://dubbo.io/user-guide/reference-xmlconf/dubbo-registry.html" target="_blank" rel="external">点此前往官方文档</a>查看）：</p>
<table>
<thead>
<tr>
<th style="text-align:center">属性名称</th>
<th style="text-align:center">类型</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">address</td>
<td style="text-align:center">string</td>
<td style="text-align:left">注册中心服务器地址，如果地址没有端口缺省为 9090，同一集群内的多个地址用逗号分隔，如：ip:port,ip:port，不同集群的注册中心，请配置多个<code>&lt;dubbo:registry&gt;</code> 标签</td>
</tr>
</tbody>
</table>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dubbo:registry</span> <span class="attr">address</span>=<span class="string">"zookeeper://127.0.0.1:2181"</span>/&gt;</span></div></pre></td></tr></table></figure>
<p>dubbo 提供支持的服务注册中心有：<code>multicast</code>、<code>zookeeper</code>、<code>redis</code>、<code>simple</code>。官方推荐你使用<code>zookeeper</code>注册中心，详细信息可<a href="http://dubbo.io/user-guide/reference-registry/introduction.html" target="_blank" rel="external">点此前往官方文档查看注册中心参考手册</a>。</p>
<h4 id="1-5-dubbo-application"><a href="#1-5-dubbo-application" class="headerlink" title="1.5 dubbo:application"></a>1.5 dubbo:application</h4><p>必填属性参考列表（更多可选参数可<a href="http://dubbo.io/user-guide/reference-xmlconf/dubbo-application.html" target="_blank" rel="external">点此前往官方文档</a>查看）：</p>
<table>
<thead>
<tr>
<th style="text-align:center">属性名称</th>
<th style="text-align:center">类型</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">name</td>
<td style="text-align:center">string</td>
<td style="text-align:left">当前应用名称，用于注册中心计算应用间依赖关系，注意：消费者和提供者应用名不要一样，此参数不是匹配条件，你当前项目叫什么名字就填什么，和提供者消费者角色无关</td>
</tr>
</tbody>
</table>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dubbo:application</span> <span class="attr">name</span>=<span class="string">"user-module-provider"</span>/&gt;</span></div></pre></td></tr></table></figure>
<h3 id="2-属性配置"><a href="#2-属性配置" class="headerlink" title="2. 属性配置"></a>2. 属性配置</h3><p>如果公共配置很简单，没有多注册中心，多协议等情况，或者想多个 Spring 容器想共享配置，可以使用 dubbo.properties 作为缺省配置。dubbo 将自动加载类路径下的 dubbo.properties，可以通过 JVM 启动参数：<code>-Ddubbo.properties.file=xxx.properties</code>改变缺省配置位置。如果类路径下存在多个 dubbo.properties，比如多个 jar 包中有 dubbo.properties，dubbo 会任意加载，并打印 Error 日志，后续可能改为抛异常。</p>
<h4 id="2-1-映射规则"><a href="#2-1-映射规则" class="headerlink" title="2.1 映射规则"></a>2.1 映射规则</h4><ul>
<li>将 XML 配置的标签名，加属性名，用点分隔，多个属性拆成多行：<ul>
<li>比如 dubbo.application.name=foo 等价于：<br><code>&lt;dubbo:application name=&quot;foo&quot;/&gt;</code></li>
</ul>
</li>
<li>如果 XML 有多行同名标签配置，可用 id 号区分，如果没有 id 号将对所有同名标签生效：<ul>
<li>比如 dubbo.protocol.rmi.port=1234 等价于：<br><code>&lt;dubbo:protocol id=&quot;rmi&quot; name=&quot;rmi&quot; port=&quot;1099&quot;/&gt;</code></li>
<li>比如 dubbo.registry.china.address=10.20.153.10:9090 等价于：<br><code>&lt;dubbo:registry id=&quot;china&quot; address=&quot;10.20.153.10:9090&quot;/&gt;</code></li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">dubbo.application.name=foo</div><div class="line">dubbo.application.owner=bar</div><div class="line">dubbo.registry.address=<span class="number">10.20</span>.153.10:<span class="number">9090</span></div></pre></td></tr></table></figure>
<h4 id="2-2-覆盖策略"><a href="#2-2-覆盖策略" class="headerlink" title="2.2 覆盖策略"></a>2.2 覆盖策略</h4><p>JVM 启动 -D 参数优先，这样可以使用户在部署和启动时进行参数重写，比如在启动时需改变协议的端口。<br>XML 次之，如果在 XML 中有配置，则 dubbo.properties 中的相应配置项无效。<br>Properties 最后，相当于缺省值，只有 XML 没有配置时，dubbo.properties 的相应配置项才会生效，通常用于共享公共配置，比如应用名。</p>
<h3 id="3-注解配置"><a href="#3-注解配置" class="headerlink" title="3. 注解配置"></a>3. 注解配置</h3><p>dubbo 2.2.1 以上的版本支持注解配置。</p>
<h4 id="3-1-服务提供者"><a href="#3-1-服务提供者" class="headerlink" title="3.1 服务提供者"></a>3.1 服务提供者</h4><p>服务提供者使用<code>com.alibaba.dubbo.config.annotation.@Service</code>注解暴露服务：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> org.fanlychie.service;</div><div class="line">    </div><div class="line"><span class="keyword">import</span> com.alibaba.dubbo.config.annotation.Service;</div><div class="line">    </div><div class="line"><span class="meta">@Service</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserService</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(String username, String password)</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"---------------------------------------------------------"</span>);</div><div class="line">        System.out.println(String.format(<span class="string">"接收到注册用户请求 - &#123;username:%s, password:%s&#125;"</span>,</div><div class="line">                username, password));</div><div class="line">        System.out.println(<span class="string">"---------------------------------------------------------"</span>);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>服务提供者使用<code>&lt;dubbo:annotation&gt;</code>配置扫描的包路径，多个包用逗号分隔：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></div><div class="line">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></div><div class="line">       <span class="attr">xmlns:dubbo</span>=<span class="string">"http://code.alibabatech.com/schema/dubbo"</span></div><div class="line">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans</span></div><div class="line">       http://www.springframework.org/schema/beans/spring-beans.xsd</div><div class="line">       http://code.alibabatech.com/schema/dubbo</div><div class="line">       http://code.alibabatech.com/schema/dubbo/dubbo.xsd"&gt;</div><div class="line">    </div><div class="line">    <span class="tag">&lt;<span class="name">dubbo:application</span> <span class="attr">name</span>=<span class="string">"user-module-provider"</span>/&gt;</span></div><div class="line">    </div><div class="line">    <span class="tag">&lt;<span class="name">dubbo:registry</span> <span class="attr">address</span>=<span class="string">"zookeeper://127.0.0.1:2181"</span>/&gt;</span></div><div class="line">    </div><div class="line">    <span class="tag">&lt;<span class="name">dubbo:protocol</span> <span class="attr">name</span>=<span class="string">"dubbo"</span> <span class="attr">port</span>=<span class="string">"20880"</span>/&gt;</span></div><div class="line">    </div><div class="line">    <span class="tag">&lt;<span class="name">dubbo:annotation</span> <span class="attr">package</span>=<span class="string">"org.fanlychie.service"</span>/&gt;</span></div><div class="line">    </div><div class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></div></pre></td></tr></table></figure>
<h4 id="3-2-服务消费者"><a href="#3-2-服务消费者" class="headerlink" title="3.2 服务消费者"></a>3.2 服务消费者</h4><p>服务消费者使用<code>com.alibaba.dubbo.config.annotation.@Reference</code>注解引用接口服务：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> com.alibaba.dubbo.config.annotation.Reference;</div><div class="line"><span class="keyword">import</span> org.fanlychie.service.UserService;</div><div class="line"><span class="keyword">import</span> org.springframework.util.StringUtils;</div><div class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</div><div class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</div><div class="line">    </div><div class="line"><span class="meta">@RestController</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Reference</span></div><div class="line">    <span class="keyword">private</span> UserService userService;</div><div class="line">    </div><div class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/user/register"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">register</span><span class="params">(String username, String password)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!StringUtils.hasText(username) || !StringUtils.hasText(password)) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="string">"用户名或密码不能为空"</span>;</div><div class="line">        &#125;</div><div class="line">        userService.register(username, password);</div><div class="line">        <span class="keyword">return</span> <span class="string">"注册完成"</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>服务消费者<code>&lt;dubbo:annotation&gt;</code>配置扫描的包路径，多个包用逗号分隔：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></div><div class="line">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></div><div class="line">       <span class="attr">xmlns:dubbo</span>=<span class="string">"http://code.alibabatech.com/schema/dubbo"</span></div><div class="line">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans</span></div><div class="line">       http://www.springframework.org/schema/beans/spring-beans.xsd</div><div class="line">       http://code.alibabatech.com/schema/dubbo</div><div class="line">       http://code.alibabatech.com/schema/dubbo/dubbo.xsd"&gt;</div><div class="line">    </div><div class="line">    <span class="tag">&lt;<span class="name">dubbo:application</span> <span class="attr">name</span>=<span class="string">"user-module-consumer"</span>/&gt;</span></div><div class="line">    </div><div class="line">    <span class="tag">&lt;<span class="name">dubbo:registry</span> <span class="attr">address</span>=<span class="string">"zookeeper://127.0.0.1:2181"</span>/&gt;</span></div><div class="line">    </div><div class="line">    <span class="tag">&lt;<span class="name">dubbo:annotation</span> <span class="attr">package</span>=<span class="string">"org.fanlychie.controller"</span>/&gt;</span></div><div class="line">    </div><div class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></div></pre></td></tr></table></figure>
<blockquote>
<p>参考文档文献链接：<a href="http://dubbo.io/user-guide/" target="_blank" rel="external">dubbo用户指南</a></p>
</blockquote>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;dubbo 提供了4种服务配置的方式，它们分别是：XML 配置、属性配置、注解配置、API 配置（官方不推荐 API 配置的方式）。本文只介绍前三种，API 配置方式可&lt;a href=&quot;http://dubbo.io/user-guide/configuration/api.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;点此前往官方文档查看API配置&lt;/a&gt;。&lt;/p&gt;
    
    </summary>
    
    
      <category term="Dubbo" scheme="http://yoursite.com/tags/Dubbo/"/>
    
  </entry>
  
  <entry>
    <title>dubbo 快速入门</title>
    <link href="http://yoursite.com/post/dubbo-quickstart.html"/>
    <id>http://yoursite.com/post/dubbo-quickstart.html</id>
    <published>2017-07-26T10:30:38.000Z</published>
    <updated>2017-07-28T10:25:28.027Z</updated>
    
    <content type="html"><![CDATA[<p>dubbo 是一个分布式服务框架，致力于提供高性能和透明化的 RPC 远程服务调用方案，以及 SOA 服务治理方案。它采用全 Spring 配置方式，透明化接入应用，对应用没有任何API侵入，只需用 Spring 加载 dubbo 的配置即可。如需了解更多相关信息可前往官方文档<a href="http://dubbo.io/user-guide/" target="_blank" rel="external">用户指南</a>部分的介绍。</p>
<a id="more"></a>
<h3 id="1-创建项目"><a href="#1-创建项目" class="headerlink" title="1. 创建项目"></a>1. 创建项目</h3><p>创建一个 maven 多模块项目，结构如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">dubbo-quickstart-sample（父模块）</div><div class="line">|</div><div class="line">|__ user-module-api（服务接口模块）</div><div class="line">|</div><div class="line">|__ user-module-provider（服务提供者）</div><div class="line">|</div><div class="line">|__ user-module-consumer（服务消费者）</div></pre></td></tr></table></figure>
<h4 id="1-1-父模块项目"><a href="#1-1-父模块项目" class="headerlink" title="1.1 父模块项目"></a>1.1 父模块项目</h4><p>dubbo-quickstart-sample/pom.xml 配置如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></div><div class="line">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd"</span>&gt;</div><div class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.fanlychie<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dubbo-quickstart-sample<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>dubbo-quickstart-sample<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>Sample project for Dubbo<span class="tag">&lt;/<span class="name">description</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.apache.org<span class="tag">&lt;/<span class="name">url</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">modules</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">module</span>&gt;</span>user-module-api<span class="tag">&lt;/<span class="name">module</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">module</span>&gt;</span>user-module-provider<span class="tag">&lt;/<span class="name">module</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">module</span>&gt;</span>user-module-consumer<span class="tag">&lt;/<span class="name">module</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">modules</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dubbo.version</span>&gt;</span>2.5.3<span class="tag">&lt;/<span class="name">dubbo.version</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">spring.version</span>&gt;</span>4.3.7.RELEASE<span class="tag">&lt;/<span class="name">spring.version</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.fanlychie<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>user-module-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dubbo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">                <span class="comment">&lt;!-- dubbo依赖的spring版本（2.5）较低, 排除此依赖, 使用自己的spring版本 --&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></div><div class="line">                        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">                        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></div><div class="line">                <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;dubbo.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-webmvc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.8.8<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.101tec<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>zkclient<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></div></pre></td></tr></table></figure>
<h4 id="1-2-服务接口模块"><a href="#1-2-服务接口模块" class="headerlink" title="1.2 服务接口模块"></a>1.2 服务接口模块</h4><p>user-module-api/pom.xml 配置如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></div><div class="line">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd"</span>&gt;</div><div class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.fanlychie<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dubbo-quickstart-sample<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>user-module-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>jar<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>user-module-api<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.apache.org<span class="tag">&lt;/<span class="name">url</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></div></pre></td></tr></table></figure>
<p>编写注册用户的示例服务接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> org.fanlychie.service;</div><div class="line">    </div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserService</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">register</span><span class="params">(String username, String password)</span></span>;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="1-3-服务提供者"><a href="#1-3-服务提供者" class="headerlink" title="1.3 服务提供者"></a>1.3 服务提供者</h4><p>user-module-provider/pom.xml 配置如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></div><div class="line">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd"</span>&gt;</div><div class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.fanlychie<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dubbo-quickstart-sample<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>user-module-provider<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>jar<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>user-module-provider<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.apache.org<span class="tag">&lt;/<span class="name">url</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.fanlychie<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>user-module-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dubbo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.101tec<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>zkclient<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></div><div class="line">            <span class="comment">&lt;!-- 打包配置, 输出可执行的 jar 包 --&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-assembly-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">executions</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">execution</span>&gt;</span></div><div class="line">                        <span class="tag">&lt;<span class="name">id</span>&gt;</span>make-assembly<span class="tag">&lt;/<span class="name">id</span>&gt;</span></div><div class="line">                        <span class="tag">&lt;<span class="name">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></div><div class="line">                        <span class="tag">&lt;<span class="name">goals</span>&gt;</span></div><div class="line">                            <span class="tag">&lt;<span class="name">goal</span>&gt;</span>single<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></div><div class="line">                        <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></div><div class="line">                <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">archive</span>&gt;</span></div><div class="line">                        <span class="tag">&lt;<span class="name">manifest</span>&gt;</span></div><div class="line">                            <span class="tag">&lt;<span class="name">mainClass</span>&gt;</span>com.alibaba.dubbo.container.Main<span class="tag">&lt;/<span class="name">mainClass</span>&gt;</span></div><div class="line">                        <span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;/<span class="name">archive</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">descriptorRefs</span>&gt;</span></div><div class="line">                        <span class="tag">&lt;<span class="name">descriptorRef</span>&gt;</span>jar-with-dependencies<span class="tag">&lt;/<span class="name">descriptorRef</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;/<span class="name">descriptorRefs</span>&gt;</span></div><div class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></div></pre></td></tr></table></figure>
<p>实现服务接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> org.fanlychie.service;</div><div class="line">    </div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserService</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(String username, String password)</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"---------------------------------------------------------"</span>);</div><div class="line">        System.out.println(String.format(<span class="string">"接收到注册用户请求 - &#123;username:%s, password:%s&#125;"</span>,</div><div class="line">                username, password));</div><div class="line">        System.out.println(<span class="string">"---------------------------------------------------------"</span>);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>user-module-provider/src/main/resources/dubbo.properties 配置如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"># 服务容器</div><div class="line">dubbo.container=spring</div><div class="line"># 容器加载的 spring 配置文件</div><div class="line">dubbo.spring.config=classpath:spring-dubbo-provider.xml</div></pre></td></tr></table></figure>
<p>user-module-provider/src/main/resources/spring-dubbo-provider.xml 配置如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></div><div class="line">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></div><div class="line">       <span class="attr">xmlns:dubbo</span>=<span class="string">"http://code.alibabatech.com/schema/dubbo"</span></div><div class="line">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans</span></div><div class="line">       http://www.springframework.org/schema/beans/spring-beans.xsd</div><div class="line">       http://code.alibabatech.com/schema/dubbo</div><div class="line">       http://code.alibabatech.com/schema/dubbo/dubbo.xsd"&gt;</div><div class="line">    </div><div class="line">    <span class="comment">&lt;!-- 提供方应用信息，用于计算依赖关系 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dubbo:application</span> <span class="attr">name</span>=<span class="string">"user-module-provider"</span>/&gt;</span></div><div class="line">    </div><div class="line">    <span class="comment">&lt;!-- 使用ZK注册中心暴露服务地址 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dubbo:registry</span> <span class="attr">address</span>=<span class="string">"zookeeper://127.0.0.1:2181"</span>/&gt;</span></div><div class="line">    </div><div class="line">    <span class="comment">&lt;!-- 用Dubbo协议在20880端口暴露服务 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dubbo:protocol</span> <span class="attr">name</span>=<span class="string">"dubbo"</span> <span class="attr">port</span>=<span class="string">"20880"</span>/&gt;</span></div><div class="line">    </div><div class="line">    <span class="comment">&lt;!-- 和本地Bean一样实现服务 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"userService"</span> <span class="attr">class</span>=<span class="string">"org.fanlychie.service.UserServiceImpl"</span>/&gt;</span></div><div class="line">    </div><div class="line">    <span class="comment">&lt;!-- 声明需要暴露的服务接口 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dubbo:service</span> <span class="attr">interface</span>=<span class="string">"org.fanlychie.service.UserService"</span> <span class="attr">ref</span>=<span class="string">"userService"</span>/&gt;</span></div><div class="line">    </div><div class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></div></pre></td></tr></table></figure>
<p>user-module-provider/src/main/resources/log4j.properties 配置如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">log4j.rootCategory = INFO, console</div><div class="line">log4j.appender.console = org.apache.log4j.ConsoleAppender</div><div class="line">log4j.appender.console.target = System.out</div><div class="line">log4j.appender.console.layout = org.apache.log4j.PatternLayout</div><div class="line">log4j.appender.console.layout.conversionPattern = %d&#123;yyyy-MM-dd HH:mm:ss:SSS&#125; [%t] %-<span class="number">5</span>p [%c&#123;<span class="number">1</span>&#125;:%L] - %m%n</div></pre></td></tr></table></figure>
<h4 id="1-4-服务消费者"><a href="#1-4-服务消费者" class="headerlink" title="1.4 服务消费者"></a>1.4 服务消费者</h4><p>user-module-consumer/pom.xml 配置如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></div><div class="line">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd"</span>&gt;</div><div class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.fanlychie<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dubbo-quickstart-sample<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>user-module-consumer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>war<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>user-module-consumer<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.apache.org<span class="tag">&lt;/<span class="name">url</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.fanlychie<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>user-module-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dubbo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-webmvc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.101tec<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>zkclient<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">finalName</span>&gt;</span>autosellrobot-wechat<span class="tag">&lt;/<span class="name">finalName</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat.maven<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tomcat7-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">path</span>&gt;</span>/<span class="tag">&lt;/<span class="name">path</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">port</span>&gt;</span>8080<span class="tag">&lt;/<span class="name">port</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">uriEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">uriEncoding</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://localhost:8080/manager/html<span class="tag">&lt;/<span class="name">url</span>&gt;</span></div><div class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></div></pre></td></tr></table></figure>
<p>编写用户注册的服务方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@RestController</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="keyword">private</span> UserService userService;</div><div class="line">    </div><div class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/user/register"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">register</span><span class="params">(String username, String password)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!StringUtils.hasText(username) || !StringUtils.hasText(password)) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="string">"用户名或密码不能为空"</span>;</div><div class="line">        &#125;</div><div class="line">        userService.register(username, password);</div><div class="line">        <span class="keyword">return</span> <span class="string">"注册完成"</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>user-module-consumer/src/main/webapp/WEB-INF/web.xml 配置如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">version</span>=<span class="string">"2.5"</span> <span class="attr">xmlns</span>=<span class="string">"http://java.sun.com/xml/ns/javaee"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd"</span>&gt;</span></div><div class="line">    </div><div class="line">    <span class="tag">&lt;<span class="name">context-param</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>classpath:spring-context.xml<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">context-param</span>&gt;</span></div><div class="line">    </div><div class="line">    <span class="tag">&lt;<span class="name">listener</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">listener-class</span>&gt;</span>org.springframework.web.util.IntrospectorCleanupListener<span class="tag">&lt;/<span class="name">listener-class</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">listener</span>&gt;</span></div><div class="line">    </div><div class="line">    <span class="tag">&lt;<span class="name">listener</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">listener-class</span>&gt;</span>org.springframework.web.context.request.RequestContextListener<span class="tag">&lt;/<span class="name">listener-class</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">listener</span>&gt;</span></div><div class="line">    </div><div class="line">    <span class="tag">&lt;<span class="name">listener</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">listener-class</span>&gt;</span>org.springframework.web.context.ContextLoaderListener<span class="tag">&lt;/<span class="name">listener-class</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">listener</span>&gt;</span></div><div class="line">    </div><div class="line">    <span class="tag">&lt;<span class="name">filter</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>encodingFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.springframework.web.filter.CharacterEncodingFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>encoding<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>forceEncoding<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>encodingFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></div><div class="line">    </div><div class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>dispatcherServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>classpath:spring-mvc.xml<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>1<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>dispatcherServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></div><div class="line">    </div><div class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></div></pre></td></tr></table></figure>
<p>user-module-consumer/src/main/resources/spring-context.xml 配置如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></div><div class="line">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></div><div class="line">       <span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span></div><div class="line">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans</span></div><div class="line">       http://www.springframework.org/schema/beans/spring-beans.xsd</div><div class="line">       http://www.springframework.org/schema/context</div><div class="line">       http://www.springframework.org/schema/context/spring-context.xsd"&gt;</div><div class="line">    </div><div class="line">    <span class="tag">&lt;<span class="name">context:annotation-config</span>/&gt;</span></div><div class="line">    </div><div class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">"org.fanlychie"</span>/&gt;</span></div><div class="line">    </div><div class="line">    <span class="tag">&lt;<span class="name">import</span> <span class="attr">resource</span>=<span class="string">"spring-dubbo-consumer.xml"</span>/&gt;</span></div><div class="line">    </div><div class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></div></pre></td></tr></table></figure>
<p>user-module-consumer/src/main/resources/spring-dubbo-consumer.xml 配置如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></div><div class="line">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></div><div class="line">       <span class="attr">xmlns:dubbo</span>=<span class="string">"http://code.alibabatech.com/schema/dubbo"</span></div><div class="line">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans</span></div><div class="line">       http://www.springframework.org/schema/beans/spring-beans.xsd</div><div class="line">       http://code.alibabatech.com/schema/dubbo</div><div class="line">       http://code.alibabatech.com/schema/dubbo/dubbo.xsd"&gt;</div><div class="line">    </div><div class="line">    <span class="comment">&lt;!-- 提供方应用信息，用于计算依赖关系 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dubbo:application</span> <span class="attr">name</span>=<span class="string">"user-module-consumer"</span>/&gt;</span></div><div class="line">    </div><div class="line">    <span class="comment">&lt;!-- 使用ZK注册中心暴露服务地址 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dubbo:registry</span> <span class="attr">address</span>=<span class="string">"zookeeper://127.0.0.1:2181"</span>/&gt;</span></div><div class="line">    </div><div class="line">    <span class="comment">&lt;!-- 生成远程服务代理，可以和本地Bean一样使用 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dubbo:reference</span> <span class="attr">id</span>=<span class="string">"userService"</span> <span class="attr">interface</span>=<span class="string">"org.fanlychie.service.UserService"</span> /&gt;</span></div><div class="line">    </div><div class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></div></pre></td></tr></table></figure>
<p>user-module-consumer/src/main/resources/spring-mvc.xml 配置如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></div><div class="line">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></div><div class="line">       <span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span></div><div class="line">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans</span></div><div class="line">       http://www.springframework.org/schema/beans/spring-beans.xsd</div><div class="line">       http://www.springframework.org/schema/context</div><div class="line">       http://www.springframework.org/schema/context/spring-context.xsd"&gt;</div><div class="line">    </div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"useSuffixPatternMatch"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"useTrailingSlashMatch"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line">    </div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"stringHttpMessageConverter"</span> <span class="attr">class</span>=<span class="string">"org.springframework.http.converter.StringHttpMessageConverter"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">value</span>=<span class="string">"UTF-8"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"supportedMediaTypes"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">list</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>text/html;charset=utf-8<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>application/xml;charset=utf-8<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>application/json;charset=utf-8<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">list</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line">    </div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"mappingJackson2HttpMessageConverter"</span></span></div><div class="line">          <span class="attr">class</span>=<span class="string">"org.springframework.http.converter.json.MappingJackson2HttpMessageConverter"</span>&gt;</div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"prefixJson"</span> <span class="attr">value</span>=<span class="string">"false"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"supportedMediaTypes"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">list</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>text/html;charset=utf-8<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>application/xml;charset=utf-8<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>application/json;charset=utf-8<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">list</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line">    </div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"messageConverters"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">list</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">"stringHttpMessageConverter"</span>/&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">"mappingJackson2HttpMessageConverter"</span>/&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">list</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line">    </div><div class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">"org.fanlychie.**.controller"</span>/&gt;</span></div><div class="line">    </div><div class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></div></pre></td></tr></table></figure>
<p>user-module-consumer/src/main/resources/log4j.properties 配置如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">log4j.rootCategory = INFO, console</div><div class="line">log4j.appender.console = org.apache.log4j.ConsoleAppender</div><div class="line">log4j.appender.console.target = System.out</div><div class="line">log4j.appender.console.layout = org.apache.log4j.PatternLayout</div><div class="line">log4j.appender.console.layout.conversionPattern = %d&#123;yyyy-MM-dd HH:mm:ss:SSS&#125; [%t] %-<span class="number">5</span>p [%c&#123;<span class="number">1</span>&#125;:%L] - %m%n</div></pre></td></tr></table></figure>
<h3 id="2-启动服务"><a href="#2-启动服务" class="headerlink" title="2. 启动服务"></a>2. 启动服务</h3><p>首先需要先启动 zookeeper 服务（可参考<a href="http://fanlychie.github.io/post/zookeeper-setup.html" target="_blank" rel="external">Zookeeper安装和配置</a>），再启动 dubbo-admin 应用（可选，可参考<a href="http://fanlychie.github.io/post/dubbo-admin-setup.html" target="_blank" rel="external">dubbo-admin管理控制台应用安装</a>）。</p>
<h4 id="2-1-启动服务提供者"><a href="#2-1-启动服务提供者" class="headerlink" title="2.1 启动服务提供者"></a>2.1 启动服务提供者</h4><p>本示例将启用2个服务提供者的实例，并使用 dubbo 提供的<code>com.alibaba.dubbo.container.Main</code>启动类来启动服务提供者的实例。下面介绍3种较为常用的启动命令。</p>
<h5 id="2-1-1-maven-命令启动"><a href="#2-1-1-maven-命令启动" class="headerlink" title="2.1.1 maven 命令启动"></a>2.1.1 maven 命令启动</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 启动第一个实例, 端口 20881</span></div><div class="line">&gt; mvn <span class="built_in">exec</span>:java -Ddubbo.protocol.port=20881 -Dexec.mainClass=com.alibaba.dubbo.container.Main</div><div class="line"><span class="comment"># 启动第二个实例, 端口 20882</span></div><div class="line">&gt; mvn <span class="built_in">exec</span>:java -Ddubbo.protocol.port=20882 -Dexec.mainClass=com.alibaba.dubbo.container.Main</div></pre></td></tr></table></figure>
<h5 id="2-1-2-application-启动"><a href="#2-1-2-application-启动" class="headerlink" title="2.1.2 application 启动"></a>2.1.2 application 启动</h5><p>以开发工具 IntelliJ IDEA 为例，<code>Run -&gt; Edit Configurations</code>添加一个 Application，配置如下：</p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/intellij-provider-application.png" alt=""></p>
<h5 id="2-1-3-jar-包启动"><a href="#2-1-3-jar-包启动" class="headerlink" title="2.1.3 jar 包启动"></a>2.1.3 jar 包启动</h5><p>在父模块项目 dubbo-quickstart-sample 根目录下执行打包命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&gt; mvn package</div></pre></td></tr></table></figure>
<p>执行完成之后，在 dubbo-quickstart-sample/user-module-provider/target 目录下将得到一个可执行的 jar 包：<code>user-module-provider-0.0.1-SNAPSHOT.jar</code>。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 启动第一个实例, 端口 20881</span></div><div class="line">&gt; java -jar -Ddubbo.protocol.port=20881 user-module-provider-0.0.1-SNAPSHOT.jar</div><div class="line"><span class="comment"># 启动第二个实例, 端口 20882</span></div><div class="line">&gt; java -jar -Ddubbo.protocol.port=20882 user-module-provider-0.0.1-SNAPSHOT.jar</div></pre></td></tr></table></figure>
<h4 id="2-2-启动服务消费者"><a href="#2-2-启动服务消费者" class="headerlink" title="2.2 启动服务消费者"></a>2.2 启动服务消费者</h4><p>服务消费者 user-module-consumer 是一个 web 项目，使用内置 tomcat 容器或部署到外部的 tomcat 运行即可。</p>
<p>如使用内置 tomcat 插件启动的 maven 命令：</p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/intellij-consumer.png" alt=""></p>
<h3 id="3-访问服务"><a href="#3-访问服务" class="headerlink" title="3. 访问服务"></a>3. 访问服务</h3><p>访问地址：<code>http://localhost:8080/user/register?username=fanlychie&amp;password=123456</code>可在服务提供者的控制台查看相关的输出信息。你也可以在 dubbo-admin 应用查看和管理相关的服务：</p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/dubbo-admin-host.png" alt=""></p>
<blockquote>
<p>示例项目开发环境：Java-8、Maven-3、IntelliJ IDEA-2017、Spring-4.7、Dubbo-2.5.3<br>完整示例项目链接：<a href="https://github.com/fanlychie/dubbo-samples/tree/master/dubbo-quickstart-sample" target="_blank" rel="external">dubbo-quickstart-sample</a><br>参考文档文献链接：<a href="http://dubbo.io/user-guide/" target="_blank" rel="external">dubbo用户指南</a></p>
</blockquote>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;dubbo 是一个分布式服务框架，致力于提供高性能和透明化的 RPC 远程服务调用方案，以及 SOA 服务治理方案。它采用全 Spring 配置方式，透明化接入应用，对应用没有任何API侵入，只需用 Spring 加载 dubbo 的配置即可。如需了解更多相关信息可前往官方文档&lt;a href=&quot;http://dubbo.io/user-guide/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;用户指南&lt;/a&gt;部分的介绍。&lt;/p&gt;
    
    </summary>
    
    
      <category term="Dubbo" scheme="http://yoursite.com/tags/Dubbo/"/>
    
  </entry>
  
  <entry>
    <title>dubbo-admin 管理控制台应用安装</title>
    <link href="http://yoursite.com/post/dubbo-admin-setup.html"/>
    <id>http://yoursite.com/post/dubbo-admin-setup.html</id>
    <published>2017-07-25T14:20:38.000Z</published>
    <updated>2017-07-26T10:27:51.984Z</updated>
    
    <content type="html"><![CDATA[<p>dubbo 管理控制台是其内部裁剪版本，开源部分主要包含：路由规则，动态配置，服务降级，访问控制，权重调整，负载均衡，等管理功能。</p>
<h3 id="1-安装应用"><a href="#1-安装应用" class="headerlink" title="1. 安装应用"></a>1. 安装应用</h3><p>目前最新的发布版本为 2.5.3，但由于仓库问题下载不了依赖包，亲测主分支代码可以编译通过。首先下载最新的源代码：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git <span class="built_in">clone</span> https://github.com/alibaba/dubbo.git</div></pre></td></tr></table></figure>
<p>最新源代码拉下来之后，在 dubbo 文件夹的根目录下，执行编译安装命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mvn install -Dmaven.test.skip=<span class="literal">true</span></div></pre></td></tr></table></figure>
<p>执行完成之后，在 dubbo/dubbo-admin/target 目录下得到 dubbo-admin-2.5.4-SNAPSHOT.war。</p>
<p>在 tomcat 的 webapps 目录下创建 dubbo-admin 文件夹，即：tomcat/webapps/dubbo-admin，并将安装包拷贝到该目录下，并对安装包进行解压缩（解压缩完成之后，删除安装包即可）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">jar xvf dubbo-admin-2.5.4-SNAPSHOT.war</div></pre></td></tr></table></figure>
<p>接着我们可以验证安装是否成功。首先需要先启动 zookeeper（可参考<a href="http://fanlychie.github.io/post/zookeeper-setup.html" target="_blank" rel="external">Zookeeper安装和配置</a>），再启动 dubbo-admin 的 tomcat。访问<code>http://localhost:8080/dubbo-admin</code>。账户密码可在 dubbo-admin/WEB-INF/dubbo.properties 中查看和配置（默认为：<code>root/root</code>、<code>guest/guest</code>）。</p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/dubbo-admin.png" alt=""></p>
<blockquote>
<p>参考文档文献链接：<a href="http://dubbo.io/Administrator+Guide-zh.htm" target="_blank" rel="external">dubbo管理员指南</a></p>
</blockquote>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;dubbo 管理控制台是其内部裁剪版本，开源部分主要包含：路由规则，动态配置，服务降级，访问控制，权重调整，负载均衡，等管理功能。&lt;/p&gt;
&lt;h3 id=&quot;1-安装应用&quot;&gt;&lt;a href=&quot;#1-安装应用&quot; class=&quot;headerlink&quot; title=&quot;1. 安装应用
    
    </summary>
    
    
      <category term="Dubbo" scheme="http://yoursite.com/tags/Dubbo/"/>
    
  </entry>
  
  <entry>
    <title>Zookeeper 安装和配置</title>
    <link href="http://yoursite.com/post/zookeeper-setup.html"/>
    <id>http://yoursite.com/post/zookeeper-setup.html</id>
    <published>2017-07-25T12:56:35.000Z</published>
    <updated>2017-07-25T18:46:53.746Z</updated>
    
    <content type="html"><![CDATA[<p>ZooKeeper 是一个开放源码的分布式应用程序协调服务，它为分布式应用提供一致性服务，主要功能包括：配置维护、域名服务、分布式同步、组服务等。</p>
<a id="more"></a>
<h3 id="1-安装"><a href="#1-安装" class="headerlink" title="1. 安装"></a>1. 安装</h3><p>到 <a href="http://apache.org/dist/zookeeper/" target="_blank" rel="external">Zookeeper官网</a> 下载安装包，本文使用 <a href="http://apache.org/dist/zookeeper/zookeeper-3.4.10/" target="_blank" rel="external">zookeeper-3.4.10.tar.gz</a> 安装包。</p>
<p>解压缩：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ tar zxvf zookeeper-3.4.10.tar.gz</div></pre></td></tr></table></figure>
<p>删除安装包：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ rm -f zookeeper-3.4.10.tar.gz</div></pre></td></tr></table></figure>
<h3 id="2-单机模式配置"><a href="#2-单机模式配置" class="headerlink" title="2. 单机模式配置"></a>2. 单机模式配置</h3><p>拷贝一份 zookeeper-3.4.10/conf/zoo_sample.cfg 配置文件并重命名为 zoo.cfg：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ <span class="built_in">cd</span> zookeeper-3.4.10/conf/</div><div class="line">$ cp zoo_sample.cfg zoo.cfg</div></pre></td></tr></table></figure>
<p>编辑 zoo.cfg 配置文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ vi zoo.cfg</div></pre></td></tr></table></figure>
<p>内容如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">tickTime=<span class="number">2000</span></div><div class="line">dataDir=/usr/local/applications/zookeeper/data</div><div class="line">dataLogDir=/usr/local/applications/zookeeper/logs</div><div class="line">clientPort=<span class="number">2181</span></div></pre></td></tr></table></figure>
<p>参数说明：</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>tickTime</td>
<td>基本时间单位（毫秒）</td>
</tr>
<tr>
<td>dataDir</td>
<td>数据目录的路径</td>
</tr>
<tr>
<td>dataLogDir</td>
<td>日志目录的路径</td>
</tr>
<tr>
<td>clientPort</td>
<td>端口号</td>
</tr>
</tbody>
</table>
<p>启动服务命令（在 bin 目录下执行）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ ./zkServer.sh start</div></pre></td></tr></table></figure>
<p>重启服务命令（在 bin 目录下执行）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ ./zkServer.sh restart</div></pre></td></tr></table></figure>
<p>查看服务状态（在 bin 目录下执行）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ ./zkServer.sh status</div></pre></td></tr></table></figure>
<p>停止服务命令（在 bin 目录下执行）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ ./zkServer.sh stop</div></pre></td></tr></table></figure>
<h3 id="3-伪集群模式配置"><a href="#3-伪集群模式配置" class="headerlink" title="3. 伪集群模式配置"></a>3. 伪集群模式配置</h3><p>伪集群是指在单台机器中启动多个 Zookeeper 服务并组成一个集群。Zookeeper 集群中只要有过半的节点是正常的，那么整个集群对外就是可用的。基于这种特性，Zookeeper 集群的节点数量通常为奇数个。</p>
<p>拷贝三份 Zookeeper：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ cp -r zookeeper-3.4.10/ zookeeper-1</div><div class="line">$ cp -r zookeeper-3.4.10/ zookeeper-2</div><div class="line">$ cp -r zookeeper-3.4.10/ zookeeper-3</div></pre></td></tr></table></figure>
<p>配置 zookeeper-1/conf/zoo.cfg：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">tickTime=<span class="number">2000</span></div><div class="line">initLimit=<span class="number">10</span></div><div class="line">syncLimit=<span class="number">5</span></div><div class="line">dataDir=/usr/local/applications/zookeeper/cluster/node1/data</div><div class="line">dataLogDir=/usr/local/applications/zookeeper/cluster/node1/logs</div><div class="line">clientPort=<span class="number">2181</span></div><div class="line">server.1=<span class="number">127.0</span>.0.1:<span class="number">8881</span>:<span class="number">9991</span></div><div class="line">server.2=<span class="number">127.0</span>.0.1:<span class="number">8882</span>:<span class="number">9992</span></div><div class="line">server.3=<span class="number">127.0</span>.0.1:<span class="number">8883</span>:<span class="number">9993</span></div></pre></td></tr></table></figure>
<p>参数说明：</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>initLimit</td>
<td>初始化连接时, follower 和 leader 之间的最长心跳时间。若设置为 10，表示 10 倍的 tickTime 时间</td>
</tr>
<tr>
<td>syncLimit</td>
<td>leader 和 follower 之间发送消息，请求和应答的最大时间。若设置为 5，表示 5 倍的 tickTime 时间</td>
</tr>
<tr>
<td>server.X=A:B:C</td>
<td>X 是一个数字，表示这是第几个服务。A 是服务器的IP地址。B 是服务器和 leader 交换消息所使用的端口。C 是选举 leader 时所使用的端口</td>
</tr>
</tbody>
</table>
<p>zookeeper-2 和 zookeeper-3 的配置与 zookeeper-1 基本相同，只需改变 dataDir、dataLogDir、clientPort 参数的值。配置 zookeeper-2/conf/zoo.cfg：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">tickTime=<span class="number">2000</span></div><div class="line">initLimit=<span class="number">10</span></div><div class="line">syncLimit=<span class="number">5</span></div><div class="line">dataDir=/usr/local/applications/zookeeper/cluster/node2/data</div><div class="line">dataLogDir=/usr/local/applications/zookeeper/cluster/node2/logs</div><div class="line">clientPort=<span class="number">2182</span></div><div class="line">server.1=<span class="number">127.0</span>.0.1:<span class="number">8881</span>:<span class="number">9991</span></div><div class="line">server.2=<span class="number">127.0</span>.0.1:<span class="number">8882</span>:<span class="number">9992</span></div><div class="line">server.3=<span class="number">127.0</span>.0.1:<span class="number">8883</span>:<span class="number">9993</span></div></pre></td></tr></table></figure>
<p>配置 zookeeper-3/conf/zoo.cfg：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">tickTime=<span class="number">2000</span></div><div class="line">initLimit=<span class="number">10</span></div><div class="line">syncLimit=<span class="number">5</span></div><div class="line">dataDir=/usr/local/applications/zookeeper/cluster/node3/data</div><div class="line">dataLogDir=/usr/local/applications/zookeeper/cluster/node3/logs</div><div class="line">clientPort=<span class="number">2183</span></div><div class="line">server.1=<span class="number">127.0</span>.0.1:<span class="number">8881</span>:<span class="number">9991</span></div><div class="line">server.2=<span class="number">127.0</span>.0.1:<span class="number">8882</span>:<span class="number">9992</span></div><div class="line">server.3=<span class="number">127.0</span>.0.1:<span class="number">8883</span>:<span class="number">9993</span></div></pre></td></tr></table></figure>
<p>在相应的数据目录下创建 myid 文件，并输入相对应的数字编号的值作为内容：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">$ mkdir -p /usr/<span class="built_in">local</span>/applications/zookeeper/cluster/node1/data</div><div class="line">$ vi /usr/<span class="built_in">local</span>/applications/zookeeper/cluster/node1/data/myid	<span class="comment"># 输入内容：1</span></div><div class="line">  </div><div class="line">$ mkdir -p /usr/<span class="built_in">local</span>/applications/zookeeper/cluster/node2/data</div><div class="line">$ vi /usr/<span class="built_in">local</span>/applications/zookeeper/cluster/node2/data/myid	<span class="comment"># 输入内容：2</span></div><div class="line">  </div><div class="line">$ mkdir -p /usr/<span class="built_in">local</span>/applications/zookeeper/cluster/node3/data</div><div class="line">$ vi /usr/<span class="built_in">local</span>/applications/zookeeper/cluster/node3/data/myid	<span class="comment"># 输入内容：3</span></div></pre></td></tr></table></figure>
<p>启动服务命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ zookeeper-1/bin/zkServer.sh start</div><div class="line">$ zookeeper-2/bin/zkServer.sh start</div><div class="line">$ zookeeper-3/bin/zkServer.sh start</div></pre></td></tr></table></figure>
<p>查看服务状态：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ zookeeper-1/bin/zkServer.sh status</div><div class="line">$ zookeeper-2/bin/zkServer.sh status</div><div class="line">$ zookeeper-3/bin/zkServer.sh status</div></pre></td></tr></table></figure>
<h3 id="4-集群模式配置"><a href="#4-集群模式配置" class="headerlink" title="4. 集群模式配置"></a>4. 集群模式配置</h3><p>集群模式的配置和伪集群的配置基本相同。在集群模式下，由于各个服务部署在不同的主机上，因此，zoo.cfg 配置文件的配置内容可以是完全一样的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">tickTime=<span class="number">2000</span></div><div class="line">initLimit=<span class="number">10</span></div><div class="line">syncLimit=<span class="number">5</span></div><div class="line">dataDir=/usr/local/applications/zookeeper/data</div><div class="line">dataLogDir=/usr/local/applications/zookeeper/logs</div><div class="line">clientPort=<span class="number">2181</span></div><div class="line">server.1=<span class="number">192.168</span>.1.101:<span class="number">2555</span>:<span class="number">3555</span></div><div class="line">server.2=<span class="number">192.168</span>.1.102:<span class="number">2555</span>:<span class="number">3555</span></div><div class="line">server.3=<span class="number">192.168</span>.1.103:<span class="number">2555</span>:<span class="number">3555</span></div></pre></td></tr></table></figure>
<p>在各主机相应的数据目录下创建 myid 文件，并输入相对应的数字编号的值作为内容：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">$ mkdir -p /usr/<span class="built_in">local</span>/applications/zookeeper/data</div><div class="line">$ vi /usr/<span class="built_in">local</span>/applications/zookeeper/data/myid	<span class="comment"># 192.168.1.101 输入内容：1</span></div><div class="line">  </div><div class="line">$ mkdir -p /usr/<span class="built_in">local</span>/applications/zookeeper/data</div><div class="line">$ vi /usr/<span class="built_in">local</span>/applications/zookeeper/data/myid	<span class="comment"># 192.168.1.102 输入内容：2</span></div><div class="line">  </div><div class="line">$ mkdir -p /usr/<span class="built_in">local</span>/applications/zookeeper/data</div><div class="line">$ vi /usr/<span class="built_in">local</span>/applications/zookeeper/data/myid	<span class="comment"># 192.168.1.103 输入内容：3</span></div></pre></td></tr></table></figure>
<p>各主机防火墙分别开放相对应的端口：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">-A INPUT -m state --state NEW -m tcp -p tcp --dport 2181 -j ACCEPT</div><div class="line">-A INPUT -m state --state NEW -m tcp -p tcp --dport 2555 -j ACCEPT</div><div class="line">-A INPUT -m state --state NEW -m tcp -p tcp --dport 3555 -j ACCEPT</div></pre></td></tr></table></figure>
<p>各主机启动服务命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ zookeeper-3.4.10/bin/zkServer.sh start</div></pre></td></tr></table></figure>
<p>查看服务状态：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ zookeeper-3.4.10/bin/zkServer.sh status</div></pre></td></tr></table></figure>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ZooKeeper 是一个开放源码的分布式应用程序协调服务，它为分布式应用提供一致性服务，主要功能包括：配置维护、域名服务、分布式同步、组服务等。&lt;/p&gt;
    
    </summary>
    
    
      <category term="Zookeeper" scheme="http://yoursite.com/tags/Zookeeper/"/>
    
  </entry>
  
  <entry>
    <title>Spring Cloud Ribbon — 客户端负载均衡器</title>
    <link href="http://yoursite.com/post/spring-cloud-netflix-ribbon.html"/>
    <id>http://yoursite.com/post/spring-cloud-netflix-ribbon.html</id>
    <published>2017-07-20T05:57:18.000Z</published>
    <updated>2017-07-23T11:03:00.217Z</updated>
    
    <content type="html"><![CDATA[<p>Ribbon 是 Netflix 开源的项目，主要用于为提供客户端软件提供负载均衡算法。Spring Cloud Ribbon 是基于 Netflix Ribbon 实现的一个基于 HTTP 和 TCP 的客户端负载均衡器。</p>
<h3 id="1-Ribbon-单独使用"><a href="#1-Ribbon-单独使用" class="headerlink" title="1. Ribbon 单独使用"></a>1. Ribbon 单独使用</h3><p>创建两个项目：order-service（订单服务，作为服务提供者）、user-center（用户中心，作为服务消费者）。并在 user-center（服务消费者）端使用 Spring Cloud Ribbon 做客户端负载均衡。</p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/spring-cloud-netflix-ribbon-project.png" alt=""></p>
<h4 id="1-1-服务提供者"><a href="#1-1-服务提供者" class="headerlink" title="1.1 服务提供者"></a>1.1 服务提供者</h4><p>在 order-service/pom.xml 中声明依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<p>在 order-service/src/main/resources/application.yml 配置两个端口以便启动两个不同实例用于测试：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  application:</span></div><div class="line"><span class="attr">    name:</span> <span class="string">order-service</span></div><div class="line"><span class="attr">  profiles:</span></div><div class="line"><span class="attr">    active:</span> <span class="string">service1</span></div><div class="line"><span class="meta">---</span></div><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  profiles:</span> <span class="string">service1</span></div><div class="line"><span class="attr">server:</span></div><div class="line"><span class="attr">  port:</span> <span class="number">8881</span></div><div class="line"><span class="meta">---</span></div><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  profiles:</span> <span class="string">service2</span></div><div class="line"><span class="attr">server:</span></div><div class="line"><span class="attr">  port:</span> <span class="number">8882</span></div></pre></td></tr></table></figure>
<p>编写查询用户订单的服务方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@RestController</span></div><div class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/order"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderController</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="keyword">private</span> OrderRepository orderRepository;</div><div class="line">    </div><div class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/find/&#123;uid:[1-9]\\d+&#125;"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> List&lt;Order&gt; <span class="title">findByUid</span><span class="params">(@PathVariable Integer uid)</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"------------------------------------------------"</span>);</div><div class="line">        System.out.println(<span class="string">"------------------ 方法被调用 ------------------"</span>);</div><div class="line">        System.out.println(<span class="string">"------------------------------------------------"</span>);</div><div class="line">        <span class="keyword">return</span> orderRepository.findByUid(uid);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>配置根路径的访问许可，以便客户端负载均衡器能够 PING 通本服务：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Configuration</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebConfig</span> <span class="keyword">extends</span> <span class="title">WebMvcConfigurerAdapter</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addViewControllers</span><span class="params">(ViewControllerRegistry registry)</span> </span>&#123;</div><div class="line">        registry.addStatusController(<span class="string">"/"</span>, HttpStatus.OK);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>编写 Spring Boot 应用启动类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@SpringBootApplication</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        SpringApplication.run(Application.class);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="1-2-服务消费者"><a href="#1-2-服务消费者" class="headerlink" title="1.2 服务消费者"></a>1.2 服务消费者</h4><p>在 user-center/pom.xml 中声明依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-ribbon<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<p>在 user-center/src/main/resources/application.yml 配置客户端负载均衡：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="attr">server:</span></div><div class="line"><span class="attr">  port:</span> <span class="number">8888</span></div><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  application:</span></div><div class="line"><span class="attr">    name:</span> <span class="string">user-center</span></div><div class="line"><span class="attr">order-service:</span></div><div class="line"><span class="attr">  ribbon:</span></div><div class="line"><span class="attr">    eureka:</span></div><div class="line"><span class="attr">      enabled:</span> <span class="literal">false</span></div><div class="line">    <span class="comment"># 微服务的服务器列表</span></div><div class="line"><span class="attr">    listOfServers:</span> <span class="attr">localhost:8881,localhost:8882</span></div><div class="line">    <span class="comment"># 刷新微服务的服务器列表信息间隔的毫秒数</span></div><div class="line"><span class="attr">    ServerListRefreshInterval:</span> <span class="number">3000</span></div></pre></td></tr></table></figure>
<p>默认情况下，Spring Cloud Ribbon 使用 NoOpPing 作为 IPing 的实现，NoOpPing 实际上并没有 PING 服务器而是一直返回 true。而 PingUrl 则会通过 PING 服务器根路径地址来检查每一台服务器的状态以确认服务是否还在线。默认情况下，Spring Cloud Ribbon 使用 ZoneAvoidanceRule 作为 IRule 的实现，ZoneAvoidanceRule 基于 AZ（可用区）过滤服务器最大程度避免区域服务器故障。由于本地环境测试，这里采用 AvailabilityFilteringRule，它使用 Ribbon 内置的断路器功能来过滤掉处于开路状态（无法 PING 通）的服务器。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RibbonConfiguration</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="keyword">private</span> IClientConfig ribbonClientConfig;</div><div class="line">    </div><div class="line">    <span class="meta">@Bean</span></div><div class="line">    <span class="function"><span class="keyword">public</span> IPing <span class="title">ribbonPing</span><span class="params">(IClientConfig config)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> PingUrl();</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@Bean</span></div><div class="line">    <span class="function"><span class="keyword">public</span> IRule <span class="title">ribbonRule</span><span class="params">(IClientConfig config)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> AvailabilityFilteringRule();</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>编写用户订单查询服务：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@RestController</span></div><div class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/user"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</div><div class="line">    </div><div class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/orders/&#123;uid:[1-9]\\d+&#125;"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> List&lt;Order&gt; <span class="title">orders</span><span class="params">(@PathVariable Integer uid)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> restTemplate.getForObject(String.format(<span class="string">"http://order-service/order/find/%d"</span>, uid), List.class);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>编写 Spring Boot 应用启动类，使用<code>@LoadBalanced</code>注解，为 RestTemplate 开启负载均衡的能力：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@SpringBootApplication</span></div><div class="line"><span class="meta">@RibbonClient</span>(name = <span class="string">"order-service"</span>, configuration = RibbonConfiguration.class)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Bean</span></div><div class="line">    <span class="meta">@LoadBalanced</span></div><div class="line">    <span class="function"><span class="keyword">public</span> RestTemplate <span class="title">proviceRestTemplate</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        SpringApplication.run(Application.class);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="1-3-启动服务"><a href="#1-3-启动服务" class="headerlink" title="1.3 启动服务"></a>1.3 启动服务</h4><p>启动两个服务提供者服务：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ java -jar order-service-<span class="number">0.0</span>.1-SNAPSHOT.jar</div><div class="line">$ java -Dspring.profiles.active=service2 -jar order-service-<span class="number">0.0</span>.1-SNAPSHOT.jar</div></pre></td></tr></table></figure>
<p>启动一个服务消费者服务：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ java -jar user-center-<span class="number">0.0</span>.1-SNAPSHOT.jar</div></pre></td></tr></table></figure>
<p>你可以尝试多次访问用户订单服务，或尝试途中关闭其中一个服务提供者服务再访问用户订单服务，以便查看其效果。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ curl -i -X GET http:<span class="comment">//localhost:8888/user/orders/1001</span></div></pre></td></tr></table></figure>
<h3 id="2-整合-Eureka"><a href="#2-整合-Eureka" class="headerlink" title="2. 整合 Eureka"></a>2. 整合 Eureka</h3><p>创建三个项目：eureka-server（服务注册中心）、order-service（订单服务，作为服务提供者）、user-center（用户中心，作为服务消费者）。并在 user-center（服务消费者）端使用 Spring Cloud Ribbon 做客户端负载均衡。</p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/spring-cloud-netflix-ribbon-eureka-project.png" alt=""></p>
<h4 id="2-1-服务注册中心"><a href="#2-1-服务注册中心" class="headerlink" title="2.1 服务注册中心"></a>2.1 服务注册中心</h4><p>在 eureka-server/pom.xml 中声明依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-eureka-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<p>eureka-server/src/main/resources/application.yml 配置示例：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="attr">server:</span></div><div class="line"><span class="attr">  port:</span> <span class="number">8761</span></div><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  application:</span></div><div class="line"><span class="attr">    name:</span> <span class="string">eureka-server</span></div><div class="line"><span class="attr">eureka:</span></div><div class="line"><span class="attr">  instance:</span></div><div class="line"><span class="attr">    hostname:</span> <span class="string">localhost</span></div><div class="line"><span class="attr">  server:</span></div><div class="line"><span class="attr">    renewal-percent-threshold:</span> <span class="number">0.49</span></div><div class="line"><span class="attr">  client:</span></div><div class="line"><span class="attr">    register-with-eureka:</span> <span class="literal">false</span></div><div class="line"><span class="attr">    fetch-registry:</span> <span class="literal">false</span></div><div class="line"><span class="attr">    service-url:</span></div><div class="line"><span class="attr">      default-zone:</span> <span class="attr">http://$&#123;eureka.instance.hostname&#125;:$&#123;server.port&#125;/eureka/</span></div><div class="line"><span class="attr">logging:</span></div><div class="line"><span class="attr">  level:</span></div><div class="line">    <span class="string">com.netflix.eureka:</span> <span class="string">'off'</span></div><div class="line">    <span class="string">com.netflix.discovery:</span> <span class="string">'off'</span></div></pre></td></tr></table></figure>
<p>Spring Boot 应用启动类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@SpringBootApplication</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        SpringApplication.run(Application.class);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="2-2-服务提供者"><a href="#2-2-服务提供者" class="headerlink" title="2.2 服务提供者"></a>2.2 服务提供者</h4><p>在 order-service/pom.xml 中声明依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-eureka<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<p>在 order-service/src/main/resources/application.yml 配置两个端口以便启动两个不同实例用于测试：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  application:</span></div><div class="line"><span class="attr">    name:</span> <span class="string">order-service</span></div><div class="line"><span class="attr">  profiles:</span></div><div class="line"><span class="attr">    active:</span> <span class="string">service1</span></div><div class="line"><span class="attr">eureka:</span></div><div class="line"><span class="attr">  client:</span></div><div class="line"><span class="attr">    service-url:</span></div><div class="line"><span class="attr">      defaultZone:</span> <span class="attr">http://localhost:8761/eureka/</span></div><div class="line"><span class="meta">---</span></div><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  profiles:</span> <span class="string">service1</span></div><div class="line"><span class="attr">server:</span></div><div class="line"><span class="attr">  port:</span> <span class="number">8881</span></div><div class="line"><span class="meta">---</span></div><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  profiles:</span> <span class="string">service2</span></div><div class="line"><span class="attr">server:</span></div><div class="line"><span class="attr">  port:</span> <span class="number">8882</span></div></pre></td></tr></table></figure>
<p>编写查询用户订单的服务方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@RestController</span></div><div class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/order"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderController</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="keyword">private</span> OrderRepository orderRepository;</div><div class="line">    </div><div class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/find/&#123;uid:[1-9]\\d+&#125;"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> List&lt;Order&gt; <span class="title">findByUid</span><span class="params">(@PathVariable Integer uid)</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"------------------------------------------------"</span>);</div><div class="line">        System.out.println(<span class="string">"------------------ 方法被调用 ------------------"</span>);</div><div class="line">        System.out.println(<span class="string">"------------------------------------------------"</span>);</div><div class="line">        <span class="keyword">return</span> orderRepository.findByUid(uid);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>编写 Spring Boot 应用启动类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@SpringBootApplication</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        SpringApplication.run(Application.class);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="2-3-服务消费者"><a href="#2-3-服务消费者" class="headerlink" title="2.3 服务消费者"></a>2.3 服务消费者</h4><p>在 user-center/pom.xml 中声明依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-eureka<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<p>user-center/src/main/resources/application.yml 配置示例：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="attr">server:</span></div><div class="line"><span class="attr">  port:</span> <span class="number">8888</span></div><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  application:</span></div><div class="line"><span class="attr">    name:</span> <span class="string">user-center</span></div><div class="line"><span class="attr">eureka:</span></div><div class="line"><span class="attr">  client:</span></div><div class="line"><span class="attr">    register-with-eureka:</span> <span class="literal">false</span></div><div class="line"><span class="attr">    serviceUrl:</span></div><div class="line"><span class="attr">      defaultZone:</span> <span class="attr">http://localhost:8761/eureka/</span></div></pre></td></tr></table></figure>
<p>编写用户订单查询服务：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@RestController</span></div><div class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/user"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</div><div class="line">    </div><div class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/orders/&#123;uid:[1-9]\\d+&#125;"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> List&lt;Order&gt; <span class="title">orders</span><span class="params">(@PathVariable Integer uid)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> restTemplate.getForObject(String.format(<span class="string">"http://order-service/order/find/%d"</span>, uid), List.class);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>编写 Spring Boot 应用启动类，使用<code>@LoadBalanced</code>注解，为 RestTemplate 开启负载均衡的能力：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@SpringBootApplication</span></div><div class="line"><span class="meta">@RibbonClient</span>(name = <span class="string">"order-service"</span>, configuration = RibbonConfiguration.class)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Bean</span></div><div class="line">    <span class="meta">@LoadBalanced</span></div><div class="line">    <span class="function"><span class="keyword">public</span> RestTemplate <span class="title">proviceRestTemplate</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        SpringApplication.run(Application.class);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="2-4-启动服务"><a href="#2-4-启动服务" class="headerlink" title="2.4 启动服务"></a>2.4 启动服务</h4><p>启动服务注册中心：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ java -jar eureka-server-<span class="number">0.0</span>.1-SNAPSHOT.jar</div></pre></td></tr></table></figure>
<p>启动两个服务提供者服务：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ java -jar order-service-<span class="number">0.0</span>.1-SNAPSHOT.jar</div><div class="line">$ java -Dspring.profiles.active=service2 -jar order-service-<span class="number">0.0</span>.1-SNAPSHOT.jar</div></pre></td></tr></table></figure>
<p>启动一个服务消费者服务：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ java -jar user-center-<span class="number">0.0</span>.1-SNAPSHOT.jar</div></pre></td></tr></table></figure>
<p>你可以尝试多次访问用户订单服务，或尝试途中关闭其中一个服务提供者服务再访问用户订单服务，以便查看其效果。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ curl -i -X GET http:<span class="comment">//localhost:8888/user/orders/1001</span></div></pre></td></tr></table></figure>
<blockquote>
<p>示例项目开发环境：Java-8、Maven-3、IntelliJ IDEA-2017、Spring Cloud-Dalston.SR1<br>完整示例项目链接：<a href="https://github.com/fanlychie/spring-cloud-samples/tree/master/spring-cloud-netflix-ribbon-sample" target="_blank" rel="external">spring-cloud-netflix-ribbon-sample</a>、<a href="https://github.com/fanlychie/spring-cloud-samples/tree/master/spring-cloud-netflix-ribbon-with-eureka-sample" target="_blank" rel="external">spring-cloud-netflix-ribbon-with-eureka-sample</a><br>参考文档文献链接：<a href="https://spring.io/guides/gs/client-side-load-balancing" target="_blank" rel="external">client-side-load-balancing</a>、<a href="http://cloud.spring.io/spring-cloud-static/Dalston.SR1/#spring-cloud-ribbon" target="_blank" rel="external">spring-cloud-ribbon</a></p>
</blockquote>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Ribbon 是 Netflix 开源的项目，主要用于为提供客户端软件提供负载均衡算法。Spring Cloud Ribbon 是基于 Netflix Ribbon 实现的一个基于 HTTP 和 TCP 的客户端负载均衡器。&lt;/p&gt;
&lt;h3 id=&quot;1-Ribbon-单独使
    
    </summary>
    
    
      <category term="Spring Cloud" scheme="http://yoursite.com/tags/Spring-Cloud/"/>
    
  </entry>
  
  <entry>
    <title>Spring Cloud Eureka — 服务发现</title>
    <link href="http://yoursite.com/post/spring-cloud-netflix-eureka.html"/>
    <id>http://yoursite.com/post/spring-cloud-netflix-eureka.html</id>
    <published>2017-06-21T13:57:47.000Z</published>
    <updated>2017-07-06T17:11:16.739Z</updated>
    
    <content type="html"><![CDATA[<p>Spring Cloud 是一套基于 Spring Boot 实现的微服务开发工具。微服务（也称微服务架构），简单的说，就是将一个系统按照一定的规则有效的拆分成多个不同的服务，每个服务都能够独立的进行开发、部署、扩展和维护。服务与服务之间可以通过 RESTful API 等方式进行相互调用。</p>
<p>Spring Cloud 没有重复制造轮子，它只是将业界内多个开源的微服务框架集成起来，再通过 Spring Boot 进行包装屏蔽掉了复杂的配置和实现原理，目的是给开发者予一套简单易懂、易部署和易维护的分布式系统开发工具包。它提供了微服务开发所需的配置管理、服务发现、断路器、智能路由、微代理、控制总线等组件。</p>
<a id="more"></a>
<h2 id="1-Eureka"><a href="#1-Eureka" class="headerlink" title="1. Eureka"></a>1. Eureka</h2><p>Eureka 是一种基于 REST 的服务，主要用于定位服务，以实现中间层服务器的负载均衡和故障转移。它是由 Spring Cloud Netflix（Spring Cloud 的子项目） 项目提供的。</p>
<h3 id="1-1-Spring-Cloud-Netflix"><a href="#1-1-Spring-Cloud-Netflix" class="headerlink" title="1.1 Spring Cloud Netflix"></a>1.1 Spring Cloud Netflix</h3><p>它主要是对 Netflix 开源的一系列产品进行包装，为 Spring Boot 应用程序提供自动配置的 Netflix OSS 集成。通过一些简单的注解，就能快速启用并构建大型的分布式系统。它提供的模块有：<br>服务发现（Eureka）、断路器（Hystrix）、智能路由（Zuul）、客户端负载均衡（Ribbon）。</p>
<h3 id="1-2-样例项目结构"><a href="#1-2-样例项目结构" class="headerlink" title="1.2 样例项目结构"></a>1.2 样例项目结构</h3><p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/spring-cloud-netflix-eureka-sample-structure.png" alt=""></p>
<h3 id="1-3-服务注册中心"><a href="#1-3-服务注册中心" class="headerlink" title="1.3 服务注册中心"></a>1.3 服务注册中心</h3><p>在 pom.xml 中声明使用<code>spring-cloud-starter-eureka-server</code>启动器（本示例对应的项目是<code>eureka-server</code>）：</p>
<p></p><p class="code-title">pom.xml</p><br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-eureka-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure><p></p>
<p>使用<code>@EnableEurekaServer</code>注解将应用声明为 Eureka 服务器端（Eureka Server），从而启动 Eureka 服务注册中心的组件，对外提供服务注册和发现的功能。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@SpringBootApplication</span></div><div class="line"><span class="meta">@EnableEurekaServer</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EurekaServerApplication</span> </span>&#123;</div><div class="line">	</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        SpringApplication.run(Application.class);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在默认的模式中，Eureka 服务器端也充当客户端并向给定的 serviceUrl 注册自己。在生产环境中，我们通常会有多台服务器端应用，但是为了简单起见，本示例使用单台服务器，因此需要禁掉 Eureka 服务器端应用的客户端行为：</p>
<p></p><p class="code-title">src/main/resources/application.yml</p><br><figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="attr">server:</span></div><div class="line"><span class="attr">  port:</span> <span class="number">8761</span></div><div class="line"><span class="attr">eureka:</span></div><div class="line"><span class="attr">  instance:</span></div><div class="line"><span class="attr">    hostname:</span> <span class="string">localhost</span></div><div class="line"><span class="attr">  client:</span></div><div class="line"><span class="attr">    register-with-eureka:</span> <span class="literal">false</span></div><div class="line"><span class="attr">    fetch-registry:</span> <span class="literal">false</span></div><div class="line"><span class="attr">    service-url:</span></div><div class="line"><span class="attr">      defaultZone:</span> <span class="attr">http://$&#123;eureka.instance.hostname&#125;:$&#123;server.port&#125;/eureka/</span></div></pre></td></tr></table></figure><p></p>
<table>
<thead>
<tr>
<th>配置项</th>
<th style="text-align:center">默认值</th>
<th>简述</th>
</tr>
</thead>
<tbody>
<tr>
<td>eureka.instance.hostname</td>
<td style="text-align:center">-</td>
<td>实例的主机名。</td>
</tr>
<tr>
<td>eureka.client.register-with-eureka</td>
<td style="text-align:center">true</td>
<td>该实例是否向 Eureka 服务器注册自己，以供外部应用发现自己。在某些情况下，你可能不希望当前的应用被外部的其他应用发现，而只是想从服务器发现其他服务的实例，此时你可以将此值设为 false。</td>
</tr>
<tr>
<td>eureka.client.fetch-registry</td>
<td style="text-align:center">true</td>
<td>该实例是否向 Eureka 服务器获取所有的注册信息表。</td>
</tr>
<tr>
<td>eureka.client.service-url.defaultZone</td>
<td style="text-align:center">-</td>
<td>该实例与 Eureka 服务器通讯的 URL 地址列表。如果 Eureka 服务器地址不止一个，则使用英文的逗号分隔。</td>
</tr>
</tbody>
</table>
<p>Eureka 服务器默认监听 8761 端口来接收服务注册，除此之外它还提供一个可视化的直观页面，可以方便的查看注册的服务。启动<code>EurekaServerApplication</code>，访问：<code>http://localhost:8761/</code></p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/spring-cloud-netflix-eureka-server-page-1.png" alt=""></p>
<p>从上图可以看到，此时还没有任何服务注册到 Eureka 服务器。</p>
<h3 id="1-4-客户端（服务提供者）"><a href="#1-4-客户端（服务提供者）" class="headerlink" title="1.4 客户端（服务提供者）"></a>1.4 客户端（服务提供者）</h3><p>在 pom.xml 中声明使用<code>spring-cloud-starter-eureka</code>启动器（本示例对应的项目是<code>order-service</code>）：</p>
<p></p><p class="code-title">pom.xml</p><br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-eureka<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure><p></p>
<p>使用<code>@EnableEurekaClient</code>或<code>@EnableDiscoveryClient</code>注解可以将应用声明为 Eureka 客户端（Eureka Client）。当客户端向 Eureka 服务器注册时，它会提供关于自身的一些元数据，例如主机和端口，健康指示符 URL，主页等信息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@SpringBootApplication</span></div><div class="line"><span class="meta">@EnableEurekaClient</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderServiceApplication</span> </span>&#123;</div><div class="line">	</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        SpringApplication.run(Application.class);</div><div class="line">    &#125;</div><div class="line">	</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>除此之外，还需要配置才能找到 Eureka 服务器：</p>
<p></p><p class="code-title">src/main/resources/application.yml</p><br><figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="attr">server:</span></div><div class="line"><span class="attr">  port:</span> <span class="number">8881</span></div><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  application:</span></div><div class="line"><span class="attr">    name:</span> <span class="string">order-service</span></div><div class="line"><span class="attr">eureka:</span></div><div class="line"><span class="attr">  client:</span></div><div class="line"><span class="attr">    service-url:</span></div><div class="line"><span class="attr">      defaultZone:</span> <span class="attr">http://localhost:8761/eureka/</span></div></pre></td></tr></table></figure><p></p>
<p><code>spring.application.name</code>是 Eureka 客户端向服务器注册的服务ID和虚拟主机的名称。在 Eureka 服务器中，服务ID相同的实例将集群在一起。<br>启动<code>OrderServiceApplication</code>，再次访问：<code>http://localhost:8761/</code></p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/spring-cloud-netflix-eureka-server-page-2.png" alt=""></p>
<p>从上图可以看到，客户端应用程序已经成功被注册了。</p>
<h3 id="1-5-高可用"><a href="#1-5-高可用" class="headerlink" title="1.5 高可用"></a>1.5 高可用</h3><p>以上示例都是单点运行的，不适合于生产环境。<a href="https://github.com/Netflix/eureka/wiki/Eureka-at-a-glance#high-level-architecture" target="_blank" rel="external">Eureka</a> 官方给出的应用部署架构图是这样的：</p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/eureka-architecture.png" alt=""></p>
<p>下面对这个架构图来作一些解读，希望能帮助你更好的理解。</p>
<p><strong>1．Region 和 Zone</strong><br>在 Eureka 中有 Region（区域）和 Zone（Availability Zone，可用区）的区分。<br>这是由于 Netflix 开源的 Eureka 旨在 AWS（Amazon Web Services，现在通常称为云计算）中运行，因此使用了一些 AWS 特有的概念术语。<br>在非 AWS 的环境下，我们可以简单的将 Region 理解成大区或地域（如阿里云服务器的华南、华北地区），Zone 可以简单的理解成机房。如需了解更多相关信息，可参考：<a href="http://blog.csdn.net/awschina/article/details/17639191" target="_blank" rel="external">AWS的区域和可用区概念解释</a>。<br>上图是一个 Eureka 集群的部署架构图，它面有 3 个 Zone（us-east-1c、us-east-1d、us-east-1e），它们都属于 us-east-1 这个 Region。</p>
<p><strong> 2．Eureka Server </strong><br>每个 Zone 至少有一个 Eureka Server，能够对外提供服务发现和处理区域故障。<br>在 Eureka Server 集群中（<code>eureka.client.register-with-eureka</code>不能设置为 false），没有 Master/Slave 的区分，每个 Eureka Server 都是对等（Peer）的。它们除了可以作为服务注册中心外还可以充当客户端向其他 Eureka Server 注册自己，并且会从它的对等的节点（由<code>eureka.client.service-url.defaultZone</code>配置指定）中 Replicate（复制）所有的服务注册表信息以达到同步的目的，如果因为某种原因导致同步失败，默认等待 5 分钟（可以通过<code>eureka.server.wait-time-in-ms-when-sync-empt</code>配置），在这期间，它不向客户端提供服务注册信息。并且默认失败重试 5 次（可以通过<code>eureka.server.number-of-replication-retries</code>配置）。</p>
<p><strong> 3．Eureka Client </strong><br>Eureka 客户端应用分两种，Applicaton Service（服务提供者）和 Application Client（服务消费者）。<br>Applicaton Service（服务提供者）通常需要向给定的 serviceUrl 对应的 Eureka Server 来 Register（注册）自己，以供外部应用可以发现自己。其注册信息包含主机名和端口信息等元数据。然后默认以每隔 30 秒的频率向注册的 Eureka Server 发送一次心跳（可以通过<code>eureka.instance.lease-renewal-interval-in-seconds</code>配置）来 Renew（续约）服务。<br>Eureka Server 默认为 90 秒内如果没有收到客户端的心跳，则它会将该客户端实例从它的注册表中剔除，以禁止该实例的流量（可以通过<code>eureka.instance.lease-expiration-duration-in-seconds</code>配置。注意，如果该值设置的太大，即使实例已经不存在了，流量也可以路由到该实例；如果设置的太小，很可能因为网络问题导致实例被服务器剔除；该值至少应该比发送心跳频率的间隔值要大）。<br>Eureka 客户端默认会从注册的 Eureka Server 中获取所有的服务注册表信息（可以通过<code>eureka.client.fetch-registry</code>配置），默认是以每隔 30 秒的频率去 Get Registry（获取注册表） 一次（可以通过<code>eureka.client.registry-fetch-interval-seconds</code>配置）。<br>Application Client（服务消费者）可以不向任何 Eureka Server 注册自己，它可以只从 Eureka Server 获取注册过的服务列表，通过 RESTful API 的方式远程调用 Applicaton Service（服务提供者）。</p>
<h4 id="1-5-1-Eureka-Server-高可用样例"><a href="#1-5-1-Eureka-Server-高可用样例" class="headerlink" title="1.5.1 Eureka Server 高可用样例"></a>1.5.1 Eureka Server 高可用样例</h4><p>本示例是在同一主机运行多个 Eureka Server 实例，由于 Eureka 会过滤同一主机的相同主机名（详见<code>com.netflix.eureka.cluster.PeerEurekaNodes#isThisMyUrl</code>），但是它不检查端口，因此需要先行定义至少两个不同的主机名，并使它们映射到<code>127.0.0.1</code>。<br>这里采用修改 hosts 文件的方式。Windows 操作系统的 hosts 文件路径是<code>C:\Windows\System32\drivers\etc\hosts</code>。找到并打开系统的 hosts 文件，在最后添加如下行：</p>
<p></p><p class="code-title">hosts</p><br><figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="string">peer1</span> <span class="string">peer2</span> <span class="string">peer3</span></div></pre></td></tr></table></figure><p></p>
<p>修改<code>eureka-server</code>项目的配置文件：</p>
<p></p><p class="code-title">src/main/resources/application.yml</p><br><figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  application:</span></div><div class="line"><span class="attr">    name:</span> <span class="string">eureka-server</span></div><div class="line"><span class="attr">  profiles:</span></div><div class="line"><span class="attr">    active:</span> <span class="string">peer1</span></div><div class="line"><span class="attr">logging:</span></div><div class="line"><span class="attr">  level:</span></div><div class="line">    <span class="string">com.netflix.eureka:</span> <span class="string">'off'</span></div><div class="line">    <span class="string">com.netflix.discovery:</span> <span class="string">'off'</span></div><div class="line"><span class="meta">---</span></div><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  profiles:</span> <span class="string">peer1</span></div><div class="line"><span class="attr">server:</span></div><div class="line"><span class="attr">  port:</span> <span class="number">8761</span></div><div class="line"><span class="attr">eureka:</span></div><div class="line"><span class="attr">  instance:</span></div><div class="line"><span class="attr">    hostname:</span> <span class="string">peer1</span></div><div class="line"><span class="attr">  client:</span></div><div class="line"><span class="attr">    service-url:</span></div><div class="line"><span class="attr">      defaultZone:</span> <span class="attr">http://peer2:8762/eureka/,http://peer3:8763/eureka/</span></div><div class="line"><span class="meta">---</span></div><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  profiles:</span> <span class="string">peer2</span></div><div class="line"><span class="attr">server:</span></div><div class="line"><span class="attr">  port:</span> <span class="number">8762</span></div><div class="line"><span class="attr">eureka:</span></div><div class="line"><span class="attr">  instance:</span></div><div class="line"><span class="attr">    hostname:</span> <span class="string">peer2</span></div><div class="line"><span class="attr">  client:</span></div><div class="line"><span class="attr">    service-url:</span></div><div class="line"><span class="attr">      defaultZone:</span> <span class="attr">http://peer1:8761/eureka/,http://peer3:8763/eureka/</span></div><div class="line"><span class="meta">---</span></div><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  profiles:</span> <span class="string">peer3</span></div><div class="line"><span class="attr">server:</span></div><div class="line"><span class="attr">  port:</span> <span class="number">8763</span></div><div class="line"><span class="attr">eureka:</span></div><div class="line"><span class="attr">  instance:</span></div><div class="line"><span class="attr">    hostname:</span> <span class="string">peer3</span></div><div class="line"><span class="attr">  client:</span></div><div class="line"><span class="attr">    service-url:</span></div><div class="line"><span class="attr">      defaultZone:</span> <span class="attr">http://peer1:8761/eureka/,http://peer2:8762/eureka/</span></div></pre></td></tr></table></figure><p></p>
<p>这里配置了 3 个 Eureka Server 实例，每个实例与其他两个实例分别进行两两的相互注册，关系如图示：</p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/ES-2.png" alt=""></p>
<p>需要注意的是，Eureka Server 的服务注册信息不能进行二次传播。如下图的实例关系配置是不可取的：</p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/ES-1.png" alt=""></p>
<p>此图的每个 Eureka Server 实例是单向的向另外一个实例注册，假如现有一个新的客户端实例 C 向 1 注册，那么，1 和 2 中都会有 C 的注册信息，但是 3 中是没有 C 的注册信息的（详见<code>com.netflix.eureka.registry.PeerAwareInstanceRegistryImpl#replicateToPeers</code>）。</p>
<p>启动 3 个 Eureka Server 实例：</p>
<p></p><p class="code-title">cmd</p><br><figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 启动 peer1 实例</span></div><div class="line"><span class="string">&gt; java -jar eureka-server-0.0.1-SNAPSHOT.jar</span></div><div class="line"># 启动 peer2 实例</div><div class="line">&gt; java -jar -Dspring.profiles.active=peer2 eureka-server-0.0.1-SNAPSHOT.jar</div><div class="line"># 启动 peer3 实例</div><div class="line">&gt; java -jar -Dspring.profiles.active=peer3 eureka-server-0.0.1-SNAPSHOT.jar</div></pre></td></tr></table></figure><p></p>
<h4 id="1-5-2-Eureka-Client-高可用样例"><a href="#1-5-2-Eureka-Client-高可用样例" class="headerlink" title="1.5.2 Eureka Client 高可用样例"></a>1.5.2 Eureka Client 高可用样例</h4><p>修改<code>order-service</code>项目的配置文件：</p>
<p></p><p class="code-title">src/main/resources/application.yml</p><br><figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  application:</span></div><div class="line"><span class="attr">    name:</span> <span class="string">order-service</span></div><div class="line"><span class="attr">  profiles:</span></div><div class="line"><span class="attr">    active:</span> <span class="string">client1</span></div><div class="line"><span class="attr">eureka:</span></div><div class="line"><span class="attr">  client:</span></div><div class="line"><span class="attr">    service-url:</span></div><div class="line"><span class="attr">      defaultZone:</span> <span class="attr">http://peer1:8761/eureka/</span></div><div class="line"><span class="meta">---</span></div><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  profiles:</span> <span class="string">client1</span></div><div class="line"><span class="attr">server:</span></div><div class="line"><span class="attr">  port:</span> <span class="number">8881</span></div><div class="line"><span class="meta">---</span></div><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  profiles:</span> <span class="string">client2</span></div><div class="line"><span class="attr">server:</span></div><div class="line"><span class="attr">  port:</span> <span class="number">8882</span></div></pre></td></tr></table></figure><p></p>
<p>客户端的<code>eureka.client.service-url.defaultZone</code>指定为当前 Zone 中任意一台服务注册中心的地址就可以，因为上例中配置的每台服务注册中心的服务注册表是两两相互进行复制的。</p>
<p>启动 2 个 Eureka Client 实例：</p>
<p></p><p class="code-title">cmd</p><br><figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 启动 client1 实例</span></div><div class="line"><span class="string">&gt; java -jar order-service-0.0.1-SNAPSHOT.jar</span></div><div class="line"># 启动 client2 实例</div><div class="line">&gt; java -jar -Dspring.profiles.active=client2 order-service-0.0.1-SNAPSHOT.jar</div></pre></td></tr></table></figure><p></p>
<p>重新刷新<code>http://localhost:8761/</code>：</p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/spring-cloud-netflix-eureka-server-page-3.png" alt=""></p>
<h3 id="1-6-自我保护模式"><a href="#1-6-自我保护模式" class="headerlink" title="1.6 自我保护模式"></a>1.6 自我保护模式</h3><p>Eureka 默认开启了自我保护模式（可以通过<code>eureka.server.enable-self-preservation</code>配置）。该模式被激活的条件是：在 1 分钟后，<code>Renews (last min)</code>&lt;<code>Renews threshold</code>。你可以在 Eureka Server 首页的右上侧可以看到：</p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/spring-cloud-netflix-eureka-server-page-part.png" alt=""></p>
<table>
<thead>
<tr>
<th>参数</th>
<th>简述</th>
</tr>
</thead>
<tbody>
<tr>
<td>Renews threshold</td>
<td>Eureka Server 期望每分钟收到客户端实例续约的总数</td>
</tr>
<tr>
<td>Renews (last min)</td>
<td>Eureka Server 最后 1 分钟收到客户端实例续约的总数</td>
</tr>
</tbody>
</table>
<p><strong> 1．服务器端续约阀值的计算源码（Renews threshold） </strong></p>
<p></p><p class="code-title">com.netflix.eureka.registry.PeerAwareInstanceRegistryImpl#openForTraffic</p><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">this</span>.expectedNumberOfRenewsPerMin = count * <span class="number">2</span>;</div><div class="line"><span class="keyword">this</span>.numberOfRenewsPerMinThreshold = (<span class="keyword">int</span>) (<span class="keyword">this</span>.expectedNumberOfRenewsPerMin * serverConfig.getRenewalPercentThreshold());</div></pre></td></tr></table></figure><p></p>
<p>其中，count 为 服务器的数量。数值 2 表示每 30 秒 1 个心跳，每分钟 2 个心跳的固定频率因子。</p>
<p>归纳公式：<code>2M * renewalPercentThreshold</code>。其中，M 为服务器的个数，计算结果只保留整数位。</p>
<p>renewalPercentThreshold 默认是 0.85（可以通过<code>eureka.server.renewal-percent-threshold</code>配置）。</p>
<p>其实这就是个固定值，因为对于每个 Eureka Server 来说，M 只能取 1。这段代码达到的效果是：</p>
<p>1．expectedNumberOfRenewsPerMin 重置为固定值 2；<br>2．numberOfRenewsPerMinThreshold 的值被设置为 1；</p>
<p><strong> 2．客户端续约阀值的计算源码（Renews threshold） </strong></p>
<p></p><p class="code-title">com.netflix.eureka.registry.AbstractInstanceRegistry#register</p><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (<span class="keyword">this</span>.expectedNumberOfRenewsPerMin &gt; <span class="number">0</span>) &#123;</div><div class="line">    <span class="keyword">this</span>.expectedNumberOfRenewsPerMin = <span class="keyword">this</span>.expectedNumberOfRenewsPerMin + <span class="number">2</span>;</div><div class="line">    <span class="keyword">this</span>.numberOfRenewsPerMinThreshold = (<span class="keyword">int</span>) (<span class="keyword">this</span>.expectedNumberOfRenewsPerMin * serverConfig.getRenewalPercentThreshold());</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p>
<p>注：上面贴出的 PeerAwareInstanceRegistryImpl 继承自 AbstractInstanceRegistry。<br>它们共享 expectedNumberOfRenewsPerMin 和 numberOfRenewsPerMinThreshold 属性，具体可自行翻阅源码。</p>
<p>设有 N 个客户端，服务器端先启动，expectedNumberOfRenewsPerMin 被重置为固定值 2。接着客户端依次启动：</p>
<p><code>N = 1</code>–&gt;<code>(2 + 2) * renewalPercentThreshold</code><br><code>N = 2</code>–&gt;<code>(2 + 2 + 2) * renewalPercentThreshold</code><br><code>N = 3</code>–&gt;<code>(2 + 2 + 2 + 2) * renewalPercentThreshold</code></p>
<p>归纳公式：<code>2(N + 1) * renewalPercentThreshold</code>，计算结果只保留整数位。</p>
<p>即，如果只有 1 个 Eureka Server 或者有多个 Eureka Server 但它们之间没有相互注册：</p>
<p>当 N = 0 时，只计算服务器端。<code>Renews threshold</code>= 1。由于没有客户端向服务器发送心跳，<code>Renews (last min)</code>&lt;<code>Renews threshold</code>，Eureka 自我保护模式被激活；</p>
<p>当 N ≠ 0 时，服务器端的计算结果被客户端覆盖，即只计算客户端；</p>
<p>当 N = 2 时，<code>Renews threshold</code>= 2(N + 1) * renewalPercentThreshold = 2 * 3 * 0.85 = 5。2 个客户端以每 30 秒发送 1 个心跳，1 分钟后总共向服务器发送 4 个心跳，<code>Renews (last min)</code>&lt;<code>Renews threshold</code>，Eureka 自我保护模式被激活；</p>
<p>所以如果 N &lt; 3，在 1 分钟后，服务器端收到的客户端实例续约的总数总是小于期望的阀值，因此 Eureka 的自我保护模式自动被激活。首页会出现警告信息：</p>
<font color="#da5985" style="margin:-12px 0 6px 0;display:block;">EMERGENCY! EUREKA MAY BE INCORRECTLY CLAIMING INSTANCES ARE UP WHEN THEY’RE NOT. RENEWALS ARE LESSER THAN THRESHOLD AND HENCE THE INSTANCES ARE NOT BEING EXPIRED JUST TO BE SAFE.</font>

<p>这种情况下，由于 Eureka Server 没有对等的节点，同步不到服务注册信息，默认需等待 5 分钟（可以通过<code>eureka.server.wait-time-in-ms-when-sync-empty</code>配置）。即 5 分钟后你应该看到此信息。</p>
<p>为避免这种情况发生，你可以：</p>
<ul>
<li>关闭自我保护模式（<code>eureka.server.enable-self-preservation</code>设为 false）</li>
<li>降低 renewalPercentThreshold 的比例（<code>eureka.server.renewal-percent-threshold</code>设置为 0.5 以下，比如 0.49）</li>
<li>部署多个 Eureka Server 并开启其客户端行为（<code>eureka.client.register-with-eureka</code>不要设为 false，默认为 true）</li>
</ul>
<p><div style="margin-top:18px"></div>如果是采取部署多个 Eureka Server 并开启其客户端行为使其相互注册。假设有 M 个 Eureka Server，那么，每个 Eureka Server 每分钟可以额外收到 2 * (M - 1) 个心跳。例如：</p>
<p>当 M = 1，N = 2 时，<code>Renews threshold</code>= 2(N + 1) * renewalPercentThreshold = 2 * 3 * 0.85 = 5，2 个客户端以每 30 秒发送 1 个心跳，1 分钟后总共向服务器发送 4 个心跳，<code>Renews (last min)</code>&lt;<code>Renews threshold</code>；</p>
<p>当 M = 2，N = 2 时，<code>Renews threshold</code>= 2(N + 1) * renewalPercentThreshold = 2 * 3 * 0.85 = 5，2 个客户端以每 30 秒发送 1 个心跳，1 分钟后总共向服务器发送 4 个心跳，另外还有 1 个 M 发来的 2 个心跳，总共是 6 个心跳，<code>Renews (last min)</code>&gt;<code>Renews threshold</code>；</p>
<p>Eureka 的自我保护模式是有意义的，该模式被激活后，它不会从注册列表中剔除因长时间没收到心跳导致租期过期的服务，而是等待修复，直到心跳恢复正常之后，它自动退出自我保护模式。这种模式旨在避免因网络分区故障导致服务不可用的问题。例如，两个客户端实例 C1 和 C2 的连通性是良好的，但是由于网络故障，C2 未能及时向 Eureka 发送心跳续约，这时候 Eureka 不能简单的将 C2 从注册表中剔除。因为如果剔除了，C1 就无法从 Eureka 服务器中获取 C2 注册的服务，但是这时候 C2 服务是可用的。所以，Eureka 的自我保护模式最好还是开启它。</p>
<h3 id="1-7-Eureka-与-Zookeeper-的区别"><a href="#1-7-Eureka-与-Zookeeper-的区别" class="headerlink" title="1.7 Eureka 与 Zookeeper 的区别"></a>1.7 Eureka 与 Zookeeper 的区别</h3><p>Eureka 最大程度上保证 AP（Availability，可用性；Partition-tolerance，分区容错性），而 Zookeeper 保证的是 CP（Consistency，一致性；Partition-tolerance，分区容错性）。<br>如果因为网络分区故障导致服务器（master 节点）无法与其它节点联系，对于 Zookeeper 来说，这是不能容忍的。它会对剩下的节点重新进行 leader 选举，在这期间，整个 Zookeeper 集群是不可用的，这就直接导致了所有注册服务瘫痪的现象。<br>而对于 Eureka 来说，每个节点都是对等的，失去了一个节点，就自动切换到其它节点，只要还有一个 Eureka 节点存在，就能正常对外提供注册服务。Eureka 可以很好的应对因网络分区故障而导致的部分节点失去联系的状况。</p>
<blockquote>
<p>示例项目开发环境：Java-8、Maven-3、IntelliJ IDEA-2017、Spring Cloud-Dalston.SR1<br>完整示例项目链接：<a href="https://github.com/fanlychie/spring-cloud-samples/tree/master/spring-cloud-netflix-eureka-sample" target="_blank" rel="external">spring-cloud-netflix-eureka-sample</a><br>参考文档文献链接：<a href="http://cloud.spring.io/spring-cloud-static/Dalston.SR1/#_spring_cloud_netflix" target="_blank" rel="external">http://cloud.spring.io/spring-cloud-static/Dalston.SR1/#_spring_cloud_netflix</a></p>
</blockquote>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Spring Cloud 是一套基于 Spring Boot 实现的微服务开发工具。微服务（也称微服务架构），简单的说，就是将一个系统按照一定的规则有效的拆分成多个不同的服务，每个服务都能够独立的进行开发、部署、扩展和维护。服务与服务之间可以通过 RESTful API 等方式进行相互调用。&lt;/p&gt;
&lt;p&gt;Spring Cloud 没有重复制造轮子，它只是将业界内多个开源的微服务框架集成起来，再通过 Spring Boot 进行包装屏蔽掉了复杂的配置和实现原理，目的是给开发者予一套简单易懂、易部署和易维护的分布式系统开发工具包。它提供了微服务开发所需的配置管理、服务发现、断路器、智能路由、微代理、控制总线等组件。&lt;/p&gt;
    
    </summary>
    
    
      <category term="Spring Cloud" scheme="http://yoursite.com/tags/Spring-Cloud/"/>
    
  </entry>
  
  <entry>
    <title>Spring Boot Test</title>
    <link href="http://yoursite.com/post/spring-boot-testing.html"/>
    <id>http://yoursite.com/post/spring-boot-testing.html</id>
    <published>2017-06-20T06:51:38.000Z</published>
    <updated>2017-07-07T12:32:19.249Z</updated>
    
    <content type="html"><![CDATA[<p>Spring 框架提供了一个专门的测试模块（<code>spring-test</code>），用于应用程序的集成测试。 在 Spring Boot 中，你可以通过<code>spring-boot-starter-test</code>启动器快速开启和使用它。</p>
<p></p><p class="code-title"># pom.xml</p><br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure><p></p>
<a id="more"></a>
<h2 id="1-Junit-测试"><a href="#1-Junit-测试" class="headerlink" title="1. Junit 测试"></a>1. Junit 测试</h2><p>当你的单元测试代码不需要用到 Spring Boot 功能，而只是一个简单的测试时，你可以直接编写你的 Junit 测试代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleJunitTest</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Test</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSayHi</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"Hi Junit."</span>);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="2-Spring-Boot-测试"><a href="#2-Spring-Boot-测试" class="headerlink" title="2. Spring Boot 测试"></a>2. Spring Boot 测试</h2><p>当你的集成测试代码需要用到 Spring Boot 功能时，你可以使用<code>@SpringBootTest</code>注解。<br>该注解是普通的 Spring 项目（非 Spring Boot 项目）中编写集成测试代码所使用的<code>@ContextConfiguration</code>注解的替代品。其作用是用于确定如何装载 Spring 应用程序的上下文资源。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@RunWith</span>(SpringRunner.class)</div><div class="line"><span class="meta">@SpringBootTest</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BeanInjectTest</span> </span>&#123;</div><div class="line">	</div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="keyword">private</span> HelloService helloService;</div><div class="line">	</div><div class="line">    <span class="meta">@Test</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSayHi</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(helloService.sayHi());</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Service</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloService</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sayHi</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">"--- Hi ---"</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sayHello</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">"--- Hello ---"</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当运行 Spring Boot 应用程序测试时，它会自动的从当前测试类所在的包起一层一层向上搜索，直到找到一个<code>@SpringBootApplication</code>或<code>@SpringBootConfiguration</code>注释类为止。以此来确定如何装载 Spring 应用程序的上下文资源。只要你以合理的方式组织你的代码，你项目的主配置通常是可以被发现的。本示例项目的部分文件结构图为：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">spring-boot-testing-sample</div><div class="line">\__ src</div><div class="line">     \__ main</div><div class="line">     :     \__ java</div><div class="line">     :           \__ org</div><div class="line">     :                \__ fanlychie</div><div class="line">     :                        |__ Application.java</div><div class="line">     :                        \__ service</div><div class="line">     :                               |__ HelloService.java</div><div class="line">     \__ test</div><div class="line">           \__ java</div><div class="line">                 \__ org</div><div class="line">                      \__ fanlychie</div><div class="line">                              \__ test</div><div class="line">                                    |__ BeanInjectTest.java</div></pre></td></tr></table></figure>
<p>其中，主配置启动类的代码为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@SpringBootApplication</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        SpringApplication.run(Application.class);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果搜索算法搜索不到你项目的主配置文件，将报出异常：</p>
<font color="#da5985" style="margin:-12px 0 6px 0;display:block;">java.lang.IllegalStateException: Unable to find a @SpringBootConfiguration, you need to use @ContextConfiguration or @SpringBootTest(classes=…) with your test</font>

<p>解决办法是，按 Spring Boot 的约定重新组织你的代码结构，或者手工指定你要装载的主配置文件：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@RunWith</span>(SpringRunner.class)</div><div class="line"><span class="meta">@SpringBootTest</span>(classes = &#123;YourApplication.class&#125;)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BeanInjectTest</span> </span>&#123;</div><div class="line">	</div><div class="line">    <span class="comment">// ...</span></div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>基于 Spring 环境的 Junit 集成测试还需要使用<code>@RunWith(SpringJUnit4ClassRunner.class)</code>注解，该注解能够改变 Junit 并让其运行在 Spring 的测试环境，以得到 Spring 测试环境的上下文支持。否则，在 Junit 测试中，Bean 的自动装配等注解将不起作用。但由于 SpringJUnit4ClassRunner 不方便记忆，Spring 4.3 起提供了一个等同于 SpringJUnit4ClassRunner 的类 SpringRunner，因此可以简写成：<code>@RunWith(SpringRunner.class)</code>。</p>
<h2 id="3-Spring-MVC-测试"><a href="#3-Spring-MVC-测试" class="headerlink" title="3. Spring MVC 测试"></a>3. Spring MVC 测试</h2><p>当你想对 Spring MVC 控制器编写单元测试代码时，可以使用<code>@WebMvcTest</code>注解。它提供了自配置的 MockMvc，可以不需要完整启动 HTTP 服务器就可以快速测试 MVC 控制器。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.test.web.servlet.request.MockMvcRequestBuilders.*;</div><div class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.test.web.servlet.result.MockMvcResultHandlers.*;</div><div class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.test.web.servlet.result.MockMvcResultMatchers.*;</div><div class="line">	</div><div class="line"><span class="meta">@RunWith</span>(SpringRunner.class)</div><div class="line"><span class="meta">@WebMvcTest</span>(HelloController.class)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloControllerTest</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="keyword">private</span> MockMvc mvc;</div><div class="line">    </div><div class="line">    <span class="meta">@Test</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testHello</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        mvc.perform(get(<span class="string">"/hello"</span>))</div><div class="line">                .andExpect(status().isOk())</div><div class="line">                .andDo(print());</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Controller</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloController</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/hello"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">(ModelMap model)</span> </span>&#123;</div><div class="line">        model.put(<span class="string">"message"</span>, <span class="string">"Hello Page"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="string">"hello"</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>使用<code>@WebMvcTest</code>注解时，只有一部分的 Bean 能够被扫描得到，它们分别是：</p>
<ul>
<li><code>@Controller</code></li>
<li><code>@ControllerAdvice</code></li>
<li><code>@JsonComponent</code></li>
<li><code>Filter</code></li>
<li><code>WebMvcConfigurer</code></li>
<li><code>HandlerMethodArgumentResolver</code></li>
</ul>
<p>其他常规的<code>@Component</code>（包括<code>@Service</code>、<code>@Repository</code>等）Bean 则不会被加载到 Spring 测试环境上下文中。</p>
<p>如果测试的 MVC 控制器中需要<code>@Component</code>Bean 的参与，你可以使用<code>@MockBean</code>注解来协助完成：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.mockito.BDDMockito.*;</div><div class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.test.web.servlet.request.MockMvcRequestBuilders.*;</div><div class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.test.web.servlet.result.MockMvcResultHandlers.*;</div><div class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.test.web.servlet.result.MockMvcResultMatchers.*;</div><div class="line">    </div><div class="line"><span class="meta">@RunWith</span>(SpringRunner.class)</div><div class="line"><span class="meta">@WebMvcTest</span>(HelloController.class)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloControllerTest</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="keyword">private</span> MockMvc mvc;</div><div class="line">    </div><div class="line">    <span class="meta">@MockBean</span></div><div class="line">    <span class="keyword">private</span> HelloService helloService;</div><div class="line">    </div><div class="line">    <span class="meta">@Test</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSayHi</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="comment">// 模拟 HelloService.sayHi() 调用, 返回 "=== Hi ==="</span></div><div class="line">        when(helloService.sayHi()).thenReturn(<span class="string">"=== Hi ==="</span>);</div><div class="line">        mvc.perform(get(<span class="string">"/hello/sayHi"</span>))</div><div class="line">                .andExpect(status().isOk())</div><div class="line">                .andDo(print());</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Controller</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloController</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="keyword">private</span> HelloService helloService;</div><div class="line">    </div><div class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/hello/sayHi"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sayHi</span><span class="params">(ModelMap model)</span> </span>&#123;</div><div class="line">        model.put(<span class="string">"message"</span>, helloService.sayHi());</div><div class="line">        <span class="keyword">return</span> <span class="string">"hello"</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="4-Spring-Boot-Web-测试"><a href="#4-Spring-Boot-Web-测试" class="headerlink" title="4. Spring Boot Web 测试"></a>4. Spring Boot Web 测试</h2><p>当你想启动一个完整的 HTTP 服务器对 Spring Boot 的 Web 应用编写测试代码时，可以使用<code>@SpringBootTest(webEnvironment = WebEnvironment.RANDOM_PORT)</code>注解开启一个随机的可用端口。Spring Boot 针对 REST 调用的测试提供了一个 TestRestTemplate 模板，它可以解析链接服务器的相对地址。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@RunWith</span>(SpringRunner.class)</div><div class="line"><span class="meta">@SpringBootTest</span>(webEnvironment = WebEnvironment.RANDOM_PORT)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApplicationTest</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="keyword">private</span> TestRestTemplate restTemplate;</div><div class="line">    </div><div class="line">    <span class="meta">@Test</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSayHello</span><span class="params">()</span> </span>&#123;</div><div class="line">        Map&lt;String, Object&gt; result = restTemplate.getForObject(<span class="string">"/hello/sayHello"</span>, Map.class);</div><div class="line">        System.out.println(result.get(<span class="string">"message"</span>));</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Controller</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloController</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="keyword">private</span> HelloService helloService;</div><div class="line">    </div><div class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/hello/sayHello"</span>)</div><div class="line">    <span class="keyword">public</span> <span class="meta">@ResponseBody</span> <span class="function">Object <span class="title">helloInfo</span><span class="params">()</span> </span>&#123;</div><div class="line">        Map&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">        map.put(<span class="string">"message"</span>, helloService.sayHello());</div><div class="line">        <span class="keyword">return</span> map;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="5-Spring-Data-JPA-测试"><a href="#5-Spring-Data-JPA-测试" class="headerlink" title="5. Spring Data JPA 测试"></a>5. Spring Data JPA 测试</h2><p>当你想对 Spring Data JPA 应用进行单元测试时，你可以使用<code>@DataJpaTest</code>注解。并且在进行 JPA 测试时，你可以选择使用内存数据库还是真实的数据库测试。</p>
<h3 id="5-1-内存数据库测试"><a href="#5-1-内存数据库测试" class="headerlink" title="5.1 内存数据库测试"></a>5.1 内存数据库测试</h3><p>默认情况下，<code>@DataJpaTest</code>使用的是内存数据库进行测试，你无需配置和启用真实的数据库。只需要在 pom.xml 配置文件中声明如下依赖即可：</p>
<p></p><p class="code-title"># pom.xml</p><br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.h2database<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>h2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure><p></p>
<p><code>@DataJpaTest</code>注解它只扫描<code>@Entity</code>Bean 和装配 Spring Data JPA 存储库，其他常规的<code>@Component</code>（包括<code>@Service</code>、<code>@Repository</code>等）Bean 则不会被加载到 Spring 测试环境上下文。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@RunWith</span>(SpringRunner.class)</div><div class="line"><span class="meta">@DataJpaTest</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserRepositoryInMemoryTest</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="keyword">private</span> UserRepository userRepository;</div><div class="line">    </div><div class="line">    <span class="meta">@Test</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSave</span><span class="params">()</span> </span>&#123;</div><div class="line">        User user = <span class="keyword">new</span> User();</div><div class="line">        user.setName(<span class="string">"fanlychie"</span>);</div><div class="line">        userRepository.save(user);</div><div class="line">        System.out.println(<span class="string">"===================================="</span>);</div><div class="line">        System.out.println(userRepository.findAll());</div><div class="line">        System.out.println(<span class="string">"===================================="</span>);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Entity</span>(name = <span class="string">"User"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Id</span></div><div class="line">    <span class="meta">@GeneratedValue</span>(generator = <span class="string">"uuidGenerator"</span>)</div><div class="line">    <span class="meta">@GenericGenerator</span>(name = <span class="string">"uuidGenerator"</span>, strategy = <span class="string">"uuid"</span>)</div><div class="line">    <span class="keyword">private</span> String id;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> String name;</div><div class="line">    </div><div class="line">    <span class="comment">// getters and setters</span></div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserRepository</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">User</span>, <span class="title">String</span>&gt; </span>&#123;</div><div class="line">	</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="5-2-真实数据库测试"><a href="#5-2-真实数据库测试" class="headerlink" title="5.2 真实数据库测试"></a>5.2 真实数据库测试</h3><p>如果你希望使用真实的数据库做测试，你可以使用<code>@AutoConfigureTestDatabase(replace = Replace.NONE)</code>注解：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@RunWith</span>(SpringRunner.class)</div><div class="line"><span class="meta">@DataJpaTest</span></div><div class="line"><span class="meta">@AutoConfigureTestDatabase</span>(replace = Replace.NONE)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserRepositoryMySQLTest</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="keyword">private</span> UserRepository userRepository;</div><div class="line">    </div><div class="line">    <span class="meta">@Test</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSave</span><span class="params">()</span> </span>&#123;</div><div class="line">        User user = <span class="keyword">new</span> User();</div><div class="line">        user.setName(<span class="string">"fanlychie"</span>);</div><div class="line">        userRepository.save(user);</div><div class="line">        System.out.println(<span class="string">"===================================="</span>);</div><div class="line">        System.out.println(userRepository.findAll());</div><div class="line">        System.out.println(<span class="string">"===================================="</span>);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>replace = Replace.NONE</code>的作用是告知 Spring Boot 不要替换应用程序默认的数据源。</p>
<p></p><p class="code-title"># src/main.resources/application.yml</p><br><figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  datasource:</span></div><div class="line"><span class="attr">      url:</span> <span class="attr">jdbc:mysql://127.0.0.1/test</span></div><div class="line"><span class="attr">      username:</span> <span class="string">root</span></div><div class="line"><span class="attr">      password:</span> <span class="string">root</span></div><div class="line"><span class="attr">      driver-class-name:</span> <span class="string">com.mysql.jdbc.Driver</span></div><div class="line"><span class="attr">      tomcat:</span></div><div class="line"><span class="attr">        default-auto-commit:</span> <span class="literal">true</span></div><div class="line"><span class="attr">  jpa:</span></div><div class="line"><span class="attr">    hibernate:</span></div><div class="line"><span class="attr">      ddl-auto:</span> <span class="string">update</span></div></pre></td></tr></table></figure><p></p>
<h3 id="5-3-事务控制"><a href="#5-3-事务控制" class="headerlink" title="5.3 事务控制"></a>5.3 事务控制</h3><p>默认情况下，在每个 JPA 测试结束时，事务会发生回滚。这在一定程度上可以防止测试数据污染数据库。如果你不希望事务发生回滚，你可以使用<code>@Rollback(false)</code>注解，该注解可以标注在类级别做全局的控制，也可以标注在某个特定不需要执行事务回滚的方法级别上。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@RunWith</span>(SpringRunner.class)</div><div class="line"><span class="meta">@DataJpaTest</span></div><div class="line"><span class="meta">@AutoConfigureTestDatabase</span>(replace = Replace.NONE)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserRepositoryMySQLTest</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="keyword">private</span> UserRepository userRepository;</div><div class="line">    </div><div class="line">    <span class="meta">@Test</span></div><div class="line">    <span class="meta">@Rollback</span>(<span class="keyword">false</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSave</span><span class="params">()</span> </span>&#123;</div><div class="line">        User user = <span class="keyword">new</span> User();</div><div class="line">        user.setName(<span class="string">"fanlychie"</span>);</div><div class="line">        userRepository.save(user);</div><div class="line">        System.out.println(<span class="string">"===================================="</span>);</div><div class="line">        System.out.println(userRepository.findAll());</div><div class="line">        System.out.println(<span class="string">"===================================="</span>);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>另外，你也可以使用<code>@Transactional</code>注解对事务进行控制。该注解可以标注在类级别做全局的控制，也可以标注在某个特定的方法级别上。如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@RunWith</span>(SpringRunner.class)</div><div class="line"><span class="meta">@DataJpaTest</span></div><div class="line"><span class="meta">@AutoConfigureTestDatabase</span>(replace = Replace.NONE)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserRepositoryMySQLTest</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="keyword">private</span> UserRepository userRepository;</div><div class="line">    </div><div class="line">    <span class="meta">@Test</span></div><div class="line">    <span class="meta">@Transactional</span>(readOnly = <span class="keyword">true</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSelect</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"===================================="</span>);</div><div class="line">        System.out.println(userRepository.findAll());</div><div class="line">        System.out.println(<span class="string">"===================================="</span>);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="6-关闭-DEBUG-日志和输出-SQL-信息"><a href="#6-关闭-DEBUG-日志和输出-SQL-信息" class="headerlink" title="6. 关闭 DEBUG 日志和输出 SQL 信息"></a>6. 关闭 DEBUG 日志和输出 SQL 信息</h2><p>在 Spring Boot 环境中执行 Junit 单元测试的时候，会有很多<code>DEBUG</code>和<code>INFO</code>级别的日志信息输出。我们对这些信息其实并不是很感兴趣，而是更关心自己编写的测试代码部分输出的信息以及 SQL 语句信息。正确关闭这些日志信息的姿势是，在测试目录的资源文件夹中创建一个<code>logback-test.xml</code>文件：</p>
<p></p><p class="code-title"># src/test/resources/logback-test.xml</p><br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">include</span> <span class="attr">resource</span>=<span class="string">"org/springframework/boot/logging/logback/base.xml"</span> /&gt;</span></div><div class="line">    <span class="comment">&lt;!-- 日志级别设置为 ERROR --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">"ERROR"</span> /&gt;</span></div><div class="line">    <span class="comment">&lt;!-- 输出 SQL 语句信息 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">logger</span> <span class="attr">name</span>=<span class="string">"org.hibernate.SQL"</span> <span class="attr">level</span>=<span class="string">"DEBUG"</span>/&gt;</span></div><div class="line">    <span class="comment">&lt;!-- 输出 SQL 语句参数信息 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">logger</span> <span class="attr">name</span>=<span class="string">"org.hibernate.type.descriptor.sql.BasicBinder"</span> <span class="attr">level</span>=<span class="string">"TRACE"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></div></pre></td></tr></table></figure><p></p>
<blockquote>
<p>示例项目开发环境：Java-8、Maven-3、IntelliJ IDEA-2017、Spring Boot-1.5.2.RELEASE<br>完整示例项目链接：<a href="https://github.com/fanlychie/spring-boot-samples/tree/master/spring-boot-testing-sample" target="_blank" rel="external">spring-boot-testing-sample</a><br>参考文档文献链接：<a href="http://docs.spring.io/spring-boot/docs/1.5.2.RELEASE/reference/htmlsingle/#boot-features-testing" target="_blank" rel="external">http://docs.spring.io/spring-boot/docs/1.5.2.RELEASE/reference/htmlsingle/#boot-features-testing</a></p>
</blockquote>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Spring 框架提供了一个专门的测试模块（&lt;code&gt;spring-test&lt;/code&gt;），用于应用程序的集成测试。 在 Spring Boot 中，你可以通过&lt;code&gt;spring-boot-starter-test&lt;/code&gt;启动器快速开启和使用它。&lt;/p&gt;
&lt;p&gt;&lt;/p&gt;&lt;p class=&quot;code-title&quot;&gt;# pom.xml&lt;/p&gt;&lt;br&gt;&lt;figure class=&quot;highlight xml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;dependency&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;groupId&lt;/span&gt;&amp;gt;&lt;/span&gt;org.springframework.boot&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;groupId&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;artifactId&lt;/span&gt;&amp;gt;&lt;/span&gt;spring-boot-starter-test&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;artifactId&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;scope&lt;/span&gt;&amp;gt;&lt;/span&gt;test&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;scope&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;dependency&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;&lt;/p&gt;
    
    </summary>
    
    
      <category term="Spring Boot" scheme="http://yoursite.com/tags/Spring-Boot/"/>
    
  </entry>
  
  <entry>
    <title>Spring Boot 使用 Servlet、Filter、Listener</title>
    <link href="http://yoursite.com/post/spring-boot-servlet-filter-listener-usage.html"/>
    <id>http://yoursite.com/post/spring-boot-servlet-filter-listener-usage.html</id>
    <published>2017-06-19T14:30:08.000Z</published>
    <updated>2017-07-06T17:23:12.189Z</updated>
    
    <content type="html"><![CDATA[<p>在普通的 WEB 应用中，Servlet、Filter、Listener 都是在 web.xml 配置文件中配置的。而在 Spring Boot 中，由于它省去 web.xml 配置文件，Servlet、Filter、Listener 的配置需要通过 Java 代码的方式来进行配置。</p>
<a id="more"></a>
<h2 id="1-通过-Bean-的方式配置"><a href="#1-通过-Bean-的方式配置" class="headerlink" title="1. 通过 Bean 的方式配置"></a>1. 通过 Bean 的方式配置</h2><p>Spring Boot 提供了 ServletRegistrationBean、FilterRegistrationBean、<br>ServletListenerRegistrationBean 三种类型来分别配置应用的 Servlet、Filter、Listener。</p>
<p></p><p class="code-title"># 在 Spring Boot 应用中配置使用 Servlet、Filter、Listener</p><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Configuration</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApplicationConfigurer</span> </span>&#123;</div><div class="line">	</div><div class="line">    <span class="meta">@Bean</span></div><div class="line">    <span class="function"><span class="keyword">public</span> FilterRegistrationBean <span class="title">registerCustomFilter</span><span class="params">()</span> </span>&#123;</div><div class="line">        FilterRegistrationBean filterRegBean = <span class="keyword">new</span> FilterRegistrationBean(<span class="keyword">new</span> CustomFilter());</div><div class="line">        filterRegBean.setUrlPatterns(Arrays.asList(<span class="string">"/*"</span>));</div><div class="line">        <span class="keyword">return</span> filterRegBean;</div><div class="line">    &#125;</div><div class="line">	</div><div class="line">    <span class="meta">@Bean</span></div><div class="line">    <span class="function"><span class="keyword">public</span> ServletRegistrationBean <span class="title">registerCustomServlet</span><span class="params">()</span> </span>&#123;</div><div class="line">        ServletRegistrationBean servletRegBean = <span class="keyword">new</span> ServletRegistrationBean(<span class="keyword">new</span> CustomServlet());</div><div class="line">        servletRegBean.setUrlMappings(Arrays.asList(<span class="string">"/customServlet"</span>));</div><div class="line">        servletRegBean.setLoadOnStartup(<span class="number">1</span>);</div><div class="line">        <span class="keyword">return</span> servletRegBean;</div><div class="line">    &#125;</div><div class="line">	</div><div class="line">    <span class="meta">@Bean</span></div><div class="line">    <span class="keyword">public</span> ServletListenerRegistrationBean&lt;?&gt; registerCustomListener() &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ServletListenerRegistrationBean&lt;&gt;(<span class="keyword">new</span> CustomListener());</div><div class="line">    &#125;</div><div class="line">	</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p>
<p></p><p class="code-title"># 自定义的 Filter</p><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</div><div class="line">        System.out.println(<span class="string">"------ CustomFilter ------"</span>);</div><div class="line">        chain.doFilter(request, response);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException </span>&#123;</div><div class="line">    </div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</div><div class="line">    </div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p>
<p></p><p class="code-title"># 自定义的 Listener</p><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomListener</span> <span class="keyword">implements</span> <span class="title">ServletRequestListener</span> </span>&#123;</div><div class="line">	</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">requestInitialized</span><span class="params">(ServletRequestEvent event)</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"------ CustomListener ------"</span>);</div><div class="line">    &#125;</div><div class="line">	</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">requestDestroyed</span><span class="params">(ServletRequestEvent event)</span> </span>&#123;</div><div class="line">    </div><div class="line">    &#125;</div><div class="line">	</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p>
<p></p><p class="code-title"># 自定义的 Servlet</p><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</div><div class="line">	</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</div><div class="line">        System.out.println(<span class="string">"------ CustomServlet ------"</span>);</div><div class="line">    &#125;</div><div class="line">	</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p>
<h2 id="2-通过注解的方式配置"><a href="#2-通过注解的方式配置" class="headerlink" title="2. 通过注解的方式配置"></a>2. 通过注解的方式配置</h2><p>Spring Boot 提供了 @WebServlet、@WebFilter、@WebListener 三种类型的注解来分别配置应用的 Servlet、Filter、Listener。</p>
<p></p><p class="code-title"># Filter 注解</p><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@WebFilter</span>(urlPatterns = <span class="string">"/*"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</div><div class="line">	</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</div><div class="line">        System.out.println(<span class="string">"------ CustomFilter Annotation ------"</span>);</div><div class="line">        chain.doFilter(request, response);</div><div class="line">    &#125;</div><div class="line">	</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException </span>&#123;</div><div class="line">    </div><div class="line">    &#125;</div><div class="line">	</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</div><div class="line">    </div><div class="line">    &#125;</div><div class="line">	</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p>
<p></p><p class="code-title"># Listener 注解</p><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@WebListener</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomListener</span> <span class="keyword">implements</span> <span class="title">ServletRequestListener</span> </span>&#123;</div><div class="line">	</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">requestInitialized</span><span class="params">(ServletRequestEvent event)</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"------ CustomListener Annotation ------"</span>);</div><div class="line">    &#125;</div><div class="line">	</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">requestDestroyed</span><span class="params">(ServletRequestEvent event)</span> </span>&#123;</div><div class="line">    </div><div class="line">    &#125;</div><div class="line">	</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p>
<p></p><p class="code-title"># Servlet 注解</p><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@WebServlet</span>(urlPatterns = <span class="string">"/customServlet"</span>, loadOnStartup = <span class="number">1</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</div><div class="line">	</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</div><div class="line">        System.out.println(<span class="string">"------ CustomServlet Annotation ------"</span>);</div><div class="line">    &#125;</div><div class="line">	</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p>
<p>最后，需要在应用中使用<code>@ServletComponentScan</code>注解配置才有效。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@SpringBootApplication</span></div><div class="line"><span class="meta">@ServletComponentScan</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</div><div class="line">	</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        SpringApplication.run(Application.class);</div><div class="line">    &#125;</div><div class="line">	</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>示例项目开发环境：Java-8、Maven-3、IntelliJ IDEA-2017、Spring Boot-1.5.2.RELEASE<br>完整示例项目链接：<a href="https://github.com/fanlychie/spring-boot-samples/tree/master/spring-boot-servlet-filter-listener-conf-sample" target="_blank" rel="external">conf-sample</a> <a href="https://github.com/fanlychie/spring-boot-samples/tree/master/spring-boot-servlet-filter-listener-scan-sample" target="_blank" rel="external">scan-sample</a><br>参考文档文献链接：<a href="http://docs.spring.io/spring-boot/docs/1.5.2.RELEASE/reference/htmlsingle/#boot-features-embedded-container" target="_blank" rel="external">http://docs.spring.io/spring-boot/docs/1.5.2.RELEASE/reference/htmlsingle/#boot-features-embedded-container</a></p>
</blockquote>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;在普通的 WEB 应用中，Servlet、Filter、Listener 都是在 web.xml 配置文件中配置的。而在 Spring Boot 中，由于它省去 web.xml 配置文件，Servlet、Filter、Listener 的配置需要通过 Java 代码的方式来进行配置。&lt;/p&gt;
    
    </summary>
    
    
      <category term="Spring Boot" scheme="http://yoursite.com/tags/Spring-Boot/"/>
    
  </entry>
  
  <entry>
    <title>Spring Boot 异常处理</title>
    <link href="http://yoursite.com/post/spring-boot-exception-handler.html"/>
    <id>http://yoursite.com/post/spring-boot-exception-handler.html</id>
    <published>2017-06-18T08:18:54.000Z</published>
    <updated>2017-07-06T17:23:47.837Z</updated>
    
    <content type="html"><![CDATA[<p>Spring Boot 默认提供了程序出错的结果映射路径<code>/error</code>（见：<a href="http://fanlychie.github.io/post/spring-boot-error-page.html" target="_blank" rel="external">Spring Boot 错误页面</a>）。其内部是通过判断请求头中的<code>Accept</code>的内容是否为<code>text/html</code>来区分请求是来自客户端浏览器（浏览器通常默认自动发送请求头内容<code>Accept:text/html</code>）还是客户端接口的调用，以此来决定返回页面视图还是 JSON 消息内容。</p>
<a id="more"></a>
<h2 id="1-自定义异常处理"><a href="#1-自定义异常处理" class="headerlink" title="1. 自定义异常处理"></a>1. 自定义异常处理</h2><p>使用<code>@ControllerAdvice</code>注解可以对已知的<code>Controller</code>中抛出的异常进行捕获并处理。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@ControllerAdvice</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GlobalExceptionHandler</span> </span>&#123;</div><div class="line">	</div><div class="line">    <span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(GlobalExceptionHandler.class);</div><div class="line">	</div><div class="line">    <span class="meta">@ResponseStatus</span>(HttpStatus.INTERNAL_SERVER_ERROR)</div><div class="line">    <span class="meta">@ExceptionHandler</span>(BusinessHtmlException.class)</div><div class="line">    <span class="function"><span class="keyword">public</span> ModelAndView <span class="title">handleHtmlException</span><span class="params">(Exception e)</span> </span>&#123;</div><div class="line">        logger.error(<span class="string">"「捕捉到异常」："</span>, e);</div><div class="line">        ModelAndView modelAndView = <span class="keyword">new</span> ModelAndView(<span class="string">"error/general"</span>);</div><div class="line">        modelAndView.addObject(<span class="string">"message"</span>, e.getMessage());</div><div class="line">        <span class="keyword">return</span> modelAndView;</div><div class="line">    &#125;</div><div class="line">	</div><div class="line">    <span class="meta">@ExceptionHandler</span>(&#123;</div><div class="line">            BusinessJsonException.class,</div><div class="line">            IllegalArgumentJsonException.class</div><div class="line">    &#125;)</div><div class="line">    <span class="keyword">public</span> ResponseEntity&lt;?&gt; handleJsonException(Exception e) &#123;</div><div class="line">        logger.error(<span class="string">"「捕捉到异常」："</span>, e);</div><div class="line">        HttpStatus status = HttpStatus.INTERNAL_SERVER_ERROR;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ResponseEntity&lt;&gt;(<span class="keyword">new</span> HttpResponseBody(status.value(), e.getMessage(), <span class="keyword">null</span>), status);</div><div class="line">    &#125;</div><div class="line">	</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="1-1-ExceptionHandler"><a href="#1-1-ExceptionHandler" class="headerlink" title="1.1 @ExceptionHandler"></a>1.1 @ExceptionHandler</h3><p>该注解用于标注处理方法处理哪些特定的异常。被该注解标注的方法可以有以下任意顺序的参数类型：</p>
<ul>
<li>Throwable、Exception 等异常对象；</li>
<li>ServletRequest、HttpServletRequest、ServletResponse、HttpServletResponse；</li>
<li>HttpSession 等会话对象；</li>
<li>org.springframework.web.context.request.WebRequest；</li>
<li>java.util.Locale；</li>
<li>java.io.InputStream、java.io.Reader；</li>
<li>java.io.OutputStream、java.io.Writer；</li>
<li>org.springframework.ui.Model；</li>
</ul>
<p><div style="margin-top:18px"></div>并且被该注解标注的方法可以有以下的返回值类型可选：</p>
<ul>
<li>ModelAndView；</li>
<li>org.springframework.ui.Model；</li>
<li>java.util.Map；</li>
<li>org.springframework.web.servlet.View；</li>
<li>@ResponseBody 注解标注的任意对象；</li>
<li>HttpEntity&lt;?&gt; or ResponseEntity&lt;?&gt;；</li>
<li>void；</li>
</ul>
<p><div style="margin-top:18px"></div>以上罗列的不完全，更加详细的信息可参考：<a href="https://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/web/bind/annotation/ExceptionHandler.html" target="_blank" rel="external">Spring ExceptionHandler</a>。</p>
<h3 id="1-2-ResponseStatus"><a href="#1-2-ResponseStatus" class="headerlink" title="1.2 @ResponseStatus"></a>1.2 @ResponseStatus</h3><p>@ExceptionHandler 注释可以与 @ResponseStatus 结合起来，以定义 HTTP 响应的状态码值。</p>
<p><strong> 以下为涉及本示例的其余代码： </strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpResponseBody</span> </span>&#123;</div><div class="line">	</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> code;</div><div class="line">	</div><div class="line">    <span class="keyword">private</span> String errmsg;</div><div class="line">	</div><div class="line">    <span class="keyword">private</span> Object data;</div><div class="line">	</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HttpResponseBody</span><span class="params">(<span class="keyword">int</span> code, String errmsg, Object data)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.code = code;</div><div class="line">        <span class="keyword">this</span>.data = data;</div><div class="line">        <span class="keyword">this</span>.errmsg = errmsg;</div><div class="line">    &#125;</div><div class="line">	</div><div class="line">    <span class="comment">// getters and setters</span></div><div class="line">	</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BusinessHtmlException</span> <span class="keyword">extends</span> <span class="title">RuntimeException</span> </span>&#123;</div><div class="line">	</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BusinessHtmlException</span><span class="params">(String message)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(message);</div><div class="line">    &#125;</div><div class="line">	</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BusinessJsonException</span> <span class="keyword">extends</span> <span class="title">RuntimeException</span> </span>&#123;</div><div class="line">	</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BusinessJsonException</span><span class="params">(String message)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(message);</div><div class="line">    &#125;</div><div class="line">	</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IllegalArgumentJsonException</span> <span class="keyword">extends</span> <span class="title">RuntimeException</span> </span>&#123;</div><div class="line">	</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">IllegalArgumentJsonException</span><span class="params">(String message)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(message);</div><div class="line">    &#125;</div><div class="line">	</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>示例项目开发环境：Java-8、Maven-3、IntelliJ IDEA-2017、Spring Boot-1.5.2.RELEASE<br>完整示例项目链接：<a href="https://github.com/fanlychie/spring-boot-samples/tree/master/spring-boot-exception-handler-sample" target="_blank" rel="external">spring-boot-exception-handler-sample</a><br>参考文档文献链接：<a href="http://docs.spring.io/spring-boot/docs/1.5.2.RELEASE/reference/htmlsingle/#boot-features-error-handling" target="_blank" rel="external">http://docs.spring.io/spring-boot/docs/1.5.2.RELEASE/reference/htmlsingle/#boot-features-error-handling</a></p>
</blockquote>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Spring Boot 默认提供了程序出错的结果映射路径&lt;code&gt;/error&lt;/code&gt;（见：&lt;a href=&quot;http://fanlychie.github.io/post/spring-boot-error-page.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Spring Boot 错误页面&lt;/a&gt;）。其内部是通过判断请求头中的&lt;code&gt;Accept&lt;/code&gt;的内容是否为&lt;code&gt;text/html&lt;/code&gt;来区分请求是来自客户端浏览器（浏览器通常默认自动发送请求头内容&lt;code&gt;Accept:text/html&lt;/code&gt;）还是客户端接口的调用，以此来决定返回页面视图还是 JSON 消息内容。&lt;/p&gt;
    
    </summary>
    
    
      <category term="Spring Boot" scheme="http://yoursite.com/tags/Spring-Boot/"/>
    
  </entry>
  
  <entry>
    <title>Spring Boot 错误页面</title>
    <link href="http://yoursite.com/post/spring-boot-error-page.html"/>
    <id>http://yoursite.com/post/spring-boot-error-page.html</id>
    <published>2017-06-17T03:26:48.000Z</published>
    <updated>2017-07-06T17:25:35.303Z</updated>
    
    <content type="html"><![CDATA[<h3 id="1-默认的错误页面"><a href="#1-默认的错误页面" class="headerlink" title="1. 默认的错误页面"></a>1. 默认的错误页面</h3><p>Spring Boot 默认提供了程序出错的结果映射路径<code>/error</code>：<br>spring-boot-autoconfigure.jar/org.springframework.boot.autoconfigure.web.BasicErrorController.java</p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/BasicErrorController_code.png" alt=""></p>
<a id="more"></a>
<p>其中，<code>errorHtml</code>方法是用于处理浏览器端的请求，它返回一个简单的错误页面。而<code>error</code>方法是用于处理客户端的调用，它返回一个简单的 JSON 字串信息。</p>
<p>当请求发生错误，它会响应浏览器一个简单的页面来描述这些错误信息，如 404 错误页面：</p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/spring-boot-404-page-default.png" alt=""></p>
<h3 id="2-自定义错误页面"><a href="#2-自定义错误页面" class="headerlink" title="2. 自定义错误页面"></a>2. 自定义错误页面</h3><p>Spring Boot 默认是到模板文件所在目录的<code>error</code>文件夹中查找错误码对应的视图模板文件：<br>spring-boot-autoconfigure-1.5.2.RELEASE.jar/org.springframework.boot.autoconfigure.web.DefaultErrorViewResolver.java</p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/DefaultErrorViewResolver.png" alt=""></p>
<p>因此，自定义的错误模板文件放在 error 目录下即可。如：</p>
<p></p><p class="code-title"># src/main/resources/templates/error/404.html（Thymeleaf）</p><br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;!DOCTYPE HTML&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">xmlns:th</span>=<span class="string">"http://www.thymeleaf.org"</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>404错误页面<span class="tag">&lt;/<span class="name">title</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Type"</span> <span class="attr">content</span>=<span class="string">"text/html; charset=UTF-8"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>404<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">p</span> <span class="attr">th:text</span>=<span class="string">"|timestamp：$&#123;#dates.format(timestamp, 'yyyy-MM-dd HH:mm:ss:SSS')&#125;|"</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">p</span> <span class="attr">th:text</span>=<span class="string">"|status：$&#123;status&#125;|"</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">p</span> <span class="attr">th:text</span>=<span class="string">"|error：$&#123;error&#125;|"</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">p</span> <span class="attr">th:text</span>=<span class="string">"|message：$&#123;message&#125;|"</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">p</span> <span class="attr">th:text</span>=<span class="string">"|path：$&#123;path&#125;|"</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div></pre></td></tr></table></figure><p></p>
<p>最终的效果：</p>
<p><img src="https://raw.githubusercontent.com/fanlychie/mdimg/master/spring-boot-404-page.png" alt=""></p>
<blockquote>
<p>示例项目开发环境：Java-8、Maven-3、IntelliJ IDEA-2017、Spring Boot-1.5.2.RELEASE<br>完整示例项目链接：<a href="https://github.com/fanlychie/spring-boot-samples/tree/master/spring-boot-error-page-sample" target="_blank" rel="external">spring-boot-error-page-sample</a><br>参考文档文献链接：<a href="http://docs.spring.io/spring-boot/docs/1.5.2.RELEASE/reference/htmlsingle/#boot-features-error-handling-custom-error-pages" target="_blank" rel="external">http://docs.spring.io/spring-boot/docs/1.5.2.RELEASE/reference/htmlsingle/#boot-features-error-handling-custom-error-pages</a></p>
</blockquote>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;1-默认的错误页面&quot;&gt;&lt;a href=&quot;#1-默认的错误页面&quot; class=&quot;headerlink&quot; title=&quot;1. 默认的错误页面&quot;&gt;&lt;/a&gt;1. 默认的错误页面&lt;/h3&gt;&lt;p&gt;Spring Boot 默认提供了程序出错的结果映射路径&lt;code&gt;/error&lt;/code&gt;：&lt;br&gt;spring-boot-autoconfigure.jar/org.springframework.boot.autoconfigure.web.BasicErrorController.java&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/fanlychie/mdimg/master/BasicErrorController_code.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
    
    </summary>
    
    
      <category term="Spring Boot" scheme="http://yoursite.com/tags/Spring-Boot/"/>
    
  </entry>
  
  <entry>
    <title>Spring Boot Tomcat 上下文路径</title>
    <link href="http://yoursite.com/post/spring-boot-tomcat-context-path.html"/>
    <id>http://yoursite.com/post/spring-boot-tomcat-context-path.html</id>
    <published>2017-05-12T16:17:40.000Z</published>
    <updated>2017-07-07T12:16:05.163Z</updated>
    
    <content type="html"><![CDATA[<p>Spring Boot 内置 Tomcat 上下文路径默认是<code>/</code>。修改上下文路径的方式有：</p>
<h3 id="1-application-yml"><a href="#1-application-yml" class="headerlink" title="1. application.yml"></a>1. <code>application.yml</code></h3><p></p><p class="code-title">src/main/resources/application.yml</p><br><figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="attr">server:</span></div><div class="line"><span class="attr">  contextPath:</span> <span class="string">/my-app</span></div></pre></td></tr></table></figure><p></p>
<a id="more"></a>
<h3 id="2-application-properties"><a href="#2-application-properties" class="headerlink" title="2. application.properties"></a>2. <code>application.properties</code></h3><p></p><p class="code-title">src/main/resources/application.properties</p><br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">server.contextPath=/my-app</div></pre></td></tr></table></figure><p></p>
<h3 id="3-命令行"><a href="#3-命令行" class="headerlink" title="3. 命令行"></a>3. 命令行</h3><p></p><p class="code-title">terminal</p><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ java -Dserver.contextPath=/my-app -jar xxxx.jar</div></pre></td></tr></table></figure><p></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Spring Boot 内置 Tomcat 上下文路径默认是&lt;code&gt;/&lt;/code&gt;。修改上下文路径的方式有：&lt;/p&gt;
&lt;h3 id=&quot;1-application-yml&quot;&gt;&lt;a href=&quot;#1-application-yml&quot; class=&quot;headerlink&quot; title=&quot;1. application.yml&quot;&gt;&lt;/a&gt;1. &lt;code&gt;application.yml&lt;/code&gt;&lt;/h3&gt;&lt;p&gt;&lt;/p&gt;&lt;p class=&quot;code-title&quot;&gt;src/main/resources/application.yml&lt;/p&gt;&lt;br&gt;&lt;figure class=&quot;highlight yml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;server:&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  contextPath:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;/my-app&lt;/span&gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;&lt;/p&gt;
    
    </summary>
    
    
      <category term="Spring Boot" scheme="http://yoursite.com/tags/Spring-Boot/"/>
    
  </entry>
  
</feed>
